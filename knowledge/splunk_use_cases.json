[
  {
    "name": "Internal Network Scanning Detection",
    "description": "This alert detects internal hosts generating unusually high traffic to multiple ports, which may indicate network scanning from a compromised system (e.g., malware attempting lateral movement, etc.).\nConditions:\n(src_ip_location = \"Internal\" \nAND \nTotal_Traffic > 500) \nAND\n         ((Average_Traffic_Volume < 10000 AND Number_Dest_Port > 10) \n          OR \n          (Average_Traffic_Volume < 1000 AND Percent_Blocked_Traffic > 50))",
    "spl": "index = netfw sourcetype=fortigate_traffic AND (src_ip!=10.20.22.2 AND src_ip!=172.17.1.34 AND src_ip!=172.18.5.11)\n| bin _time span=15m\n| eval src_ip_location = if(cidrmatch(\"10.0.0.0/8\", src_ip) OR cidrmatch(\"172.16.0.0/12\", src_ip) OR cidrmatch(\"192.168.0.0/16\", src_ip), \"Internal\", \"External\")\n| eval dest_ip_location = if(cidrmatch(\"10.0.0.0/8\", dest_ip) OR cidrmatch(\"172.16.0.0/12\", dest_ip) OR cidrmatch(\"192.168.0.0/16\", dest_ip), \"Internal\", \"External\")\n| where (src_ip_location = \"External\") OR (src_ip_location = \"Internal\" AND dest_ip_location = \"Internal\")\n| stats dc(dest_port) as num_dest_port, \n        count as total_traffic,\n        sum(bytes) as Total_Volume,\n        count(eval(action=\"blocked\")) as total_blocked_traffic, \n        values(dest_port) as list_dest_ports,\n        values(dest_ip) as list_dest_ips, \n        dc(dest_ip) as num_dest_ip,\n        values(src_ip_location) as src_ip_location,\n        min(_time) as firstTime,\n        values(policyname) as allow_rules\n    by _time, src_ip, srccountry\n| rename srccountry as src_country\n| eval List_of_DestPorts = mvjoin(List_of_DestPorts, \", \")\n| eval percent_blocked_traffic = round((total_blocked_traffic/total_traffic)*100, 2),\n       average_traffic_volume = round((Total_Volume/total_traffic)*100, 2),\n       time = strftime(firstTime, \"%Y-%m-%d %H:%M:%S\")\n| search (src_ip_location = \"Internal\" AND total_traffic > 200) AND\n                                                                   ((average_traffic_volume < 10000 AND num_dest_port > 10) \n                                                                   OR \n                                                                   (average_traffic_volume < 1000 AND percent_blocked_traffic > 50))\n| table time, src_ip, total_traffic, total_blocked_traffic, percent_blocked_traffic, average_traffic_volume, num_dest_port, list_dest_ports, num_dest_ip, list_dest_ips, allow_rules\n| sort + time"
  },
  {
    "name": "External Network Scanning Detection",
    "description": "This report runs twice daily at 3 AM and 3 PM, analyzing the last 12 hours of data to find potential network scanning activities originating from external IP addresses that were permitted by current firewall rules. It flags sources that connect to a high number of unique ports or destination IPs.\nConditions:\n       total_traffic > 20 \n       AND \n       num_dest_port > 15\nOR \n       total_traffic > 50 \n       AND\n       average_traffic_volume < 100 \n       AND\n       percent_blocked_traffic > 50\nAND\n       percent_blocked_traffic != 100",
    "spl": "index IN (netfw,netproxy,netauth,netops) sourcetype=*pan* rule!=\"Allow Access To BIC Website\" rule!=\"Allow External To Access websites public ip\" rule!=\"Allow External To BIC Websites\" rule!=\"Allow Access To Websites UAT\"\n| bin _time span=15m\n| eval src_ip_location = if(cidrmatch(\"10.0.0.0/8\", src_ip) \n                        OR cidrmatch(\"172.16.0.0/12\", src_ip) \n                        OR cidrmatch(\"192.168.0.0/16\", src_ip), \n                        \"Internal\", \"External\")\n| where (src_ip_location=\"External\") OR (src_ip_location=\"Internal\" AND dest_ip_location=\"Internal\")\n| stats dc(dest_port) as num_dest_port,\n        count as total_traffic,\n        sum(bytes) as total_volume,\n        count(eval(action=\"blocked\")) as total_blocked_traffic,\n        values(dest_port) as list_of_ports,\n        values(dest_ip) as list_of_dest_ip,\n        dc(dest_ip) as num_dest_ip,\n        values(src_ip_location) as src_ip_location,\n        values(src_location) as src_country,\n        values(eval(if(action=\"allowed\",rule,null()))) as allow_rules,\n        values(eval(if(action=\"allowed\",dest_port,null()))) as allowed_ports\n  by _time, src_ip\n| eval list_of_ports = mvjoin(list_of_ports, \", \"),\n       allowed_rules = mvjoin(allow_rules, \", \"),\n       allowed_ports = mvjoin(allowed_ports, \", \"),\n       list_of_dest_ip = mvjoin(list_of_dest_ip, \", \"),\n       percent_blocked_traffic = round((total_blocked_traffic/total_traffic)*100,2),\n       average_traffic_volume = round((total_volume/total_traffic)*100,2),\n       time = strftime(_time, \"%Y-%m-%d %H:%M:%S\")\n| search (src_ip_location=\"External\" AND percent_blocked_traffic!=100 AND\n        ((total_traffic>20 AND num_dest_port>15) \n        OR (total_traffic>50 AND average_traffic_volume<100 AND percent_blocked_traffic>50)))\n\n| join type=left src_ip \n    [ search index=notable earliest=-90d\n      | stats count as previous_notable_events by src_ip ]\n\n| eval previous_notable_events=coalesce(previous_notable_events,0)\n| table time, src_ip, src_country, previous_notable_events, total_traffic, total_blocked_traffic, percent_blocked_traffic, average_traffic_volume, num_dest_port, list_of_ports, num_dest_ip, list_of_dest_ip, allowed_rules, allowed_ports\n| sort - time"
  },
  {
    "name": "Web Content Discovery Detected",
    "description": "An alert that detects potential web content discovery activity (also known as Forced Browsing attack). It is triggered when a high volume of requests resulting in HTTP errors (e.g., 404 Not Found) or using User-Agent strings linked to scanning tools. Such behavior may indicate attempts to discover hidden files and directories.\n\nConditions:\nnot_found_count > 50 AND error_percentage > 20)\n        OR (mvjoin(user_agents, \" \") LIKE \"%dirb%\"\n        OR mvjoin(user_agents, \" \") LIKE \"%gobuster%\"\n        OR mvjoin(user_agents, \" \") LIKE \"%sqlmap%\"\n        OR mvjoin(user_agents, \" \") LIKE \"%nikto%\"\n        OR mvjoin(user_agents, \" \") LIKE \"%wpscan%\")",
    "spl": "index IN (netops,netfw) host=fortiweb_vm http_agent!= none\n| eval time = strftime(_time, \"%Y-%m-%d %H:%M:%S\")\n| eval full_url = if((http_retcode>=200 AND http_retcode<400) , time + \" \" + http_method + \" [\" + http_retcode+ \"]\"+ \": \"+ http_host + http_url, NULL)\n| bin span=15m _time\n| stats count as total_requests, \n        count(eval(http_retcode>=400)) as not_found_count, \n        values(http_agent) as user_agents, \n        values(full_url) as successful_full_urls \n        by _time, original_src\n| eval error_percentage = round((not_found_count / total_requests) * 100, 2),\n       success_percentage = round(100 - error_percentage, 2)\n| where (not_found_count > 50 AND error_percentage > 20 AND success_percentage > 0)\n        OR (mvjoin(user_agents, \" \") LIKE \"%dirb%\"\n        OR mvjoin(user_agents, \" \") LIKE \"%gobuster%\"\n        OR mvjoin(user_agents, \" \") LIKE \"%sqlmap%\"\n        OR mvjoin(user_agents, \" \") LIKE \"%nikto%\"\n        OR mvjoin(user_agents, \" \") LIKE \"%wpscan%\")\n| rename original_src as src_ip\n| join type=left src_ip \n    [ search index=notable earliest=-90d\n      | stats count as previous_notable_events by src_ip ]\n| eval previous_notable_events=coalesce(previous_notable_events,0)\n| table _time, src_ip, previous_notable_events,total_requests, not_found_count, error_percentage, successful_full_urls\n| sort + _time"
  },
  {
    "name": "Unusual traffic targeting public services detected (DoS/DDos)",
    "description": "Detects unusually high traffic volumes targeting public-facing services, potentially indicating a  Denial-of-Service (DoS) / Distributed Denial-of-Service (DDoS) attack.\nConditions:\n       total_traffic_for_dest_services > 200",
    "spl": "index=netfw sourcetype=\"pan:traffic\"\n| bin _time span=1m\n| eval public_dest_IP = if(cidrmatch(\"10.0.0.0/8\", dest_ip) OR cidrmatch(\"172.16.0.0/12\", dest_ip) OR cidrmatch(\"192.168.0.0/16\", dest_ip), \"false\", \"true\") \n| search public_dest_IP = \"true\" src_zone!=INSIDE\n\n| eventstats count as total_traffic_per_service by _time, dest_ip, dest_port, protocol\n| where  ((protocol = \"tcp\" OR protocol = \"udp\") AND total_traffic_for_service > 2000)\n      OR ((protocol = \"ip\") AND total_traffic_for_service > 100)\n      OR ((protocol = \"icmp\") AND total_traffic_for_service > 100 AND src_ip != \"54.179.6.82\")\n      OR (((protocol = \"udp\") AND dest_port = 53) AND total_traffic_per_service > 300)\n\n| eventstats count as traffic_from_source by _time, dest_ip, dest_port, protocol, src_ip\n| eval Source_IP_and_traffic=src_ip.\" [\".traffic_from_source.\"]\"\n\n| stats values(Source_IP_and_traffic) as Source_IP_and_traffics by _time, dest_ip, dest_port, protocol, total_traffic_for_service\n| eval Source_IP_and_traffics = mvjoin(Source_IP_and_traffics, \" | \")\n| rename _time as time\n\n| eval time = strftime(time, \"%Y-%m-%d %H:%M:%S\")\n| table time, dest_ip, dest_port, protocol, total_traffic_per_service, Source_IP_and_traffics\n| sort - time"
  },
  {
    "name": "Rarely used firewall rules",
    "description": "This report lists the firewall rules that have not been triggered for over 7 days. The purpose is to help system administrators review unused or outdated firewall rules.\n\nConditions:\n       Firewall rules that have not been triggered for over 7 days\n\nSchedule: Every week - Wednesday - 1:00 AM\nTime range: All time",
    "spl": "| inputlookup firewall_policies_record\n| eval current_time=now(), time_since_last_hit = now()-last_hit_time_epoch\n\n| sort 0  + last_hit_time_epoch\n\n| eval last_hit_time_epoch=strftime(last_hit_time_epoch, \"%Y-%m-%d %H:%M:%S %z\"),\n       current_time=strftime(current_time, \"%Y-%m-%d %H:%M:%S %z\")\n| eval days=floor(time_since_last_hit/86400),\n       hours=floor((time_since_last_hit%86400)/3600),\n       mins=floor((time_since_last_hit%3600)/60),\n       \"Time since last hit\"=days.\"d \".hours.\"h \".mins.\"m\"\n| where days>6\n| rename device_name as \"Device Name\", vendor as \"Vendor\", last_hit_time_epoch as \"Last hit time\", policy_name as \"Policy name\"\n| table \"Policy name\", \"Device Name\", \"Vendor\", \"Last hit time\", \"Time since last hit\""
  },
  {
    "name": "Dormant firewall rule triggered",
    "description": "An hourly alert that detects firewall rules triggered after more than 7 days of inactivity or being triggered for the first time since log onboarded.  Such rules may be unused or outdated, and could potentially be exploited by attackers.\nConditions:\n       policy triggered for the first time since log onboarded\n       OR\n       current_time - last_hit_time > 7 days\n\nSchedule: Every hour",
    "spl": "index=\"netfw\" tag=network tag=communicate rule=* \n| eval vendor=case(like(sourcetype,\"pan:%\"),\"PAN\", like(sourcetype,\"fortigate%\"),\"FG\", 1=1,\"Other\") \n| eval device_name=coalesce(devname, dvc_name, host) \n| eval policy_name=coalesce(policyname, rule) \n| eval rule_key=coalesce(poluuid, rule_uuid, vendor.\"|\".device_name.\"|\".policy_name) \n\n| eval ActionLabel=case(action=\"allowed\",\"Allowed\", action=\"teardown\",\"Teardowned\", true(), action) \n| eval hit_time=strftime(_time, \"%Y-%m-%d %H:%M:%S %z\"), hit_src=coalesce(src_ip, src), hit_dest=coalesce(dest_ip,\"N/A\")\n| eval hit_string = hit_time.\" | \".hit_src.\" | \".hit_dest .\" | \".ActionLabel \n| sort 0 + _time \n\n| stats latest(_time) as this_hit_time \n        values(action) as Actions \n        values(hit_src) as Sources \n        list(hit_string) as Hits \n        count as hit_last_hour\n        by rule_key vendor device_name policy_name\n\n| lookup firewall_policies_record _key AS rule_key OUTPUT last_hit_time_epoch AS prev_last_hit_time_epoch, hit_count\n\n| eval hit_count=coalesce(hit_count,\"\")\n| rex field=hit_count max_match=1\n      \"^(?i)w(?<prev_wk>\\d+?)_(?<last_wk_count>\\d+?)_w(?<curr_wk>\\d+?)_(?<week_count>\\d+?)_(?<curr_mon>\\d{2})_(?<month_count>\\d+?)_(?<curr_yr>\\d{2})_(?<year_count>\\d+?)$\"\n\n| eval curr_wk_num=strftime(relative_time(now(),\"@w0\"), \"%V\"),\n       curr_mon_num=strftime(relative_time(now(),\"@mon\"), \"%m\"),\n       curr_yr_num=strftime(now(), \"%y\")\n\n| eval last_wk_count = coalesce(last_wk_count, 0)+0,\n       week_count    = coalesce(week_count, 0)+0,\n       month_count   = coalesce(month_count,0)+0,\n       year_count    = coalesce(year_count, 0)+0\n\n| eval last_wk_count = if(curr_wk_num!=curr_wk, week_count, last_wk_count)\n| eval week_count    = if(curr_wk_num==curr_wk, week_count + hit_last_hour, hit_last_hour)\n| eval month_count   = if(curr_mon_num==curr_mon, month_count + hit_last_hour, hit_last_hour)\n| eval year_count    = if(curr_yr_num==curr_yr, year_count + hit_last_hour, hit_last_hour)\n\n| eval hit_count = \"w\".(curr_wk_num-1).\"_\".last_wk_count.\"_w\".curr_wk_num.\"_\".week_count.\"_\".curr_mon_num.\"_\".month_count.\"_\".curr_yr_num.\"_\".year_count\n\n| eval last_hit_time_epoch = if(isnull(prev_last_hit_time_epoch), this_hit_time, max(prev_last_hit_time_epoch, this_hit_time)) \n| eval idle_sec = if(isnull(prev_last_hit_time_epoch), 999999999999999, now()-prev_last_hit_time_epoch) \n\n| appendpipe [\n    | eventstats count AS _cnt\n    | where _cnt>0\n    | fields - _cnt\n    | eval last_updated = now()\n    | fields rule_key vendor device_name policy_name last_hit_time_epoch last_updated hit_count\n    | outputlookup firewall_policies_record append=true key_field=rule_key\n    | where 1=0\n] \n    \n| where isnull(prev_last_hit_time_epoch) OR idle_sec >= 60*60*24*7 \n\n| eval last_hit_prev = if(isnull(prev_last_hit_time_epoch),\"N/A\", strftime(prev_last_hit_time_epoch,\"%Y-%m-%d %H:%M:%S %z\")) \n| eval this_hit = strftime(this_hit_time,\"%Y-%m-%d %H:%M:%S %z\") \n| eval NL = printf(\"%c\",10) \n| eval \"Hit times (time | source | dest | action)\" = mvjoin(Hits, NL) \n\n| eval idle_sec = case(idle_sec=999999999999999, \"N/A\", true(), idle_sec) \n| eval days = floor(idle_sec/86400) \n| eval hours = floor((idle_sec%86400)/3600) \n| eval mins = floor((idle_sec%3600)/60) \n| eval \"Time since last hit\" = days.\"d \".hours.\"h \".mins.\"m\" \n\n| table vendor device_name policy_name this_hit last_hit_prev \"Time since last hit\" \"Hit times (time | source | dest | action)\" Sources Actions\n| rename vendor as Vendor device_name as \"Device name\" policy_name as \"Policy_name\" this_hit as \"Hit time\" last_hit_prev as \"Last hit time\" \n| fields - Sources Actions"
  },
  {
    "name": "Network Device Configuration Change Detected",
    "description": "An hourly alert that detects configuration changes on network devices.  The purpose is to help system administrators review unauthorize or improperly configured on network devices.\nConditions:\n(\n  tag = change\n  AND logid NOT IN [\"0100041000\", \"0100032040\", \"0100032029\"]\n  AND action NOT IN [\"logoff\", \"read\"]\n)\nOR\n(\n  user NOT IN [\"system\", \"update_manager\", \"fgdlinkd\",\"daemon_user\"]\n  AND action NOT IN [\"login\", \"logout\", \"system session\"]\n)\n\nSchedule: Every hour",
    "spl": "index=\"netops\" \n    (\n    user!=\"system\" \n    user!=\"update_manager\" \n    user!=\"fgdlinkd\"\n    user!=\"daemon_admin\"\n    operation!=login* \n    operation!=logout* \n    operation!=\"system session\"\n    )\n    OR\n    (\n    tag=change sourcetype!=\"pan:system\"    NOT ui=\"ha_daemon\" NOT action=\"logoff\" NOT action=\"read\"\n    ) \n    OR\n    (\n    type=\"event\" subtype=\"Admin\" devname=\"*FortiWEB*\" OR devname=\"*FAC*\"\n    )\n    NOT logid=\"0100041000\" \n    NOT (logid=\"0100032040\" AND ( msg=\"System deleted*\" msg=\"*oldest report*\")) \n    NOT (logid=\"0100032029\" AND msg=\"System deleted log file*\")\n    NOT msg=\"Add firewall.policy*\"\n    NOT msg=\"Edit firewall.policy*\"\n    NOT msg=\"*firewall.address*\"\n    NOT msg=\"*firewall.addrgrp*\"\n    NOT path=\"*address*\"\n    NOT path=\"*rulebase security rules*\"\n    NOT cmd=\"commit\"\n    NOT changes=\"Send a test*\"\n    NOT msg=\"Configuration is changed in the admin session\"\n    NOT status=\"failure\"\n    NOT result=\"Failed\"\n    NOT msg=\"*firewall.service.custom*\"\n| eval Time = strftime(_time, \"%Y-%m-%d %H:%M:%S\") \n| eval \"Device_Name\" = coalesce(devname, dvc) \n| eval \"User\" = coalesce(user, 'User') \n| eval \"User Source\" = coalesce(userfrom, ui, \"N/A\") \n| eval \"Operation Performed\" = coalesce(operation, action, cmd, log_action) \n| rex field=cfgattr \"uuid\\\\s*\\\\[(?<policy_id>.*?)(?=\\\\\\\\*\\\\])\\\\\\\\*\\\\]\"\n| lookup firewall_policies_record _key AS policy_id OUTPUT policy_name\n| eval policy_label = coalesce(policy_name, policy_id, \"unknown\")\n| eval \"Change Summary\" = case(\n    isnotnull(changes) AND changes!=\"\", changes,\n    like(msg,\"Edit firewall.policy%\"), \"Edit firewall policy \\\"\" . policy_label . \"\\\"\",\n    like(msg,\"Add firewall.policy%\"),  \"Add firewall policy \\\"\"  . policy_label . \"\\\"\",\n    isnotnull(msg) AND msg!=\"\", msg,\n    isnotnull(desc) AND desc!=\"\", desc,\n    isnotnull(path) AND path!=\"\", path,\n    cmd==\"commit\", \"Commit changes\",\n    true(), null()\n)\n| rex field=cfgattr max_match=0 \"(?<!\\w)(?<policy_field>(?!uuid\\b)[A-Za-z0-9_/\\-]+)\\[(?<policy_field_old_value>.*?)(?=->|\\\\\\\\*\\])(?:->(?<policy_field_new_value>.*?))?\\\\\\\\*\\]\"\n| eval old_len = mvcount(policy_field_old_value)\n| eval new_len = mvcount(policy_field_new_value)\n\n| eval new_list = if(new_len=old_len AND new_len>0,\n                     policy_field_new_value,\n                     mvmap(mvrange(0, old_len), \"\"))\n| eval field_eq_old        = mvzip(policy_field, policy_field_old_value, \": \")\n| eval field_eq_old_to_new = mvzip(field_eq_old, new_list, \" -> \")\n| eval NL = printf(\"%c\",10)\n| eval tmp = mvjoin(field_eq_old_to_new, NL)\n\n| eval \"Change Details\" = replace(tmp, \" -> (?=(?:\\r?\\n|$))\", \"\")\n| table Time \"Device_Name\" User \"User Source\" \"Operation Performed\" \"Change Summary\" \"Change Details\"|sort - Time"
  },
  {
    "name": "Remote access software usage",
    "description": "Reports network traffic from remote access tools (e.g., AnyDesk, GoToMyPC, LogMeIn, TeamViewer, etc.) using firewall logs. Adversaries often use these tools for unauthorized access, data theft, or malware deployment, posing a high security risk. \nConditions:\n| datamodel=Network_Traffic\n| lookup remote_access_software\n| search isutility = True\n\nSchedule: Wed at 5AM",
    "spl": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime values(All_Traffic.dest_ip) as dest_ip values(All_Traffic.src_ip) as src_ip values(All_Traffic.user) as user values(All_Traffic.rule) as rule from datamodel=Network_Traffic by All_Traffic.action All_Traffic.app All_Traffic.user\n| `drop_dm_object_name(\"All_Traffic\")`\n| `security_content_ctime(firstTime)`\n| `security_content_ctime(lastTime)`\n| lookup remote_access_software remote_appid AS app OUTPUT isutility, description as signature, comment_reference as appURL, category, remote_utility\n| search isutility = True\n| `remote_access_software_usage_exceptions`\n| `detect_remote_access_software_usage_traffic_filter`\n| table app, user, action, firstTime, lastTime, src_ip, dest_ip, category, rule, remote_utility"
  },
  {
    "name": "Suspicious login attempts to network devices",
    "description": "An 15-minute alert that detects suspicious login attempts to network devices. The alert is triggered when the overall risk score, calculated based on the number of attempts, login time, and IP information, exceeds the risk threshold.\nConditions:\n12AM-7AM: risk_multiplier =2,\n7AM-19PM: risk_multiplier=1\n19PM-12AM: risk_multiplier= 1.5\nrisk_score = num_fail_attempts * risk_multiplier\nrisk_score > 2\n\nSchedule: Every hour",
    "spl": "index=netops \n(tag=authentication NOT subtype=\"vpn\" NOT action=success) \nOR \n(sourcetype=\"fortigate_event\" subtype=Authentication status=\"failed\" NOT (logdesc=AUTH_FAIL_LOCK_USER OR logdesc=AUTH_FAIL_LOCK_IP)) \nOR\n(host=*faz* operation=*login*)\n\n| eval userfrom=if(isnull(userfrom) OR userfrom=\"\", \"N/A\", userfrom) \n| eval EventTime = strftime(_time, \"%Y-%m-%d %H:%M:%S\") \n| eval src_ip=coalesce(srcip, src, userfrom) \n| eval msg=coalesce(msg, description) \n| eval device_name=coalesce(devname, dvc_name)\n\n| eval user = if(\n    dvc_name=\"BIC_DC_INT_FW01\"\n    AND match(description, \"(?i)failed authentication for user\\s+['\\\"][^'\\\"\\r\\n]+['\\\"]?\"),\n    replace(description, \".*(?i)failed authentication for user\\s+['\\\"]([^'\\\"\\r\\n]+)['\\\"]?.*\", \"\\1\"),\n    user\n)\n\n\n| rex field=src_ip max_match=1 \"(?<src_ip>\\d{1,3}(?:\\.\\d{1,3}){3})\" \n| eval is_internal = if(\n    cidrmatch(\"10.0.0.0/8\", src_ip)\n    OR cidrmatch(\"172.16.0.0/12\", src_ip)\n    OR cidrmatch(\"192.168.0.0/16\", src_ip),\n    1, 0\n    ) \n| rename \n    device_name as \"Device Name\", \n    user as \"User\",\n    action as \"Action\", \n    subtype as \"Login type\" \n\n| stats\n    values(logid) as Logid\n    values(src_ip) as src_ips\n    values(msg) as msg_list\n  by User, _time, \"Device Name\", EventTime\n| eval line = EventTime.\" | \".mvjoin(msg_list, \"; \")\n\n| stats\n    count as fail_count                  \n    values(Logid) as Logid\n    values(src_ips) as src_ips\n    values(line) as lines\n  by User, _time, \"Device Name\"\n\n| where NOT [\n    search index=netfw sourcetype=\"pan:globalprotect\" log_subtype=\"login\"\n    | stats values(user) as User by _time\n    | fields User _time\n]\n\n| eval NL = printf(\"%c\",10)\n| eval \"Login Activity\" = mvjoin(lines, NL)\n\n| eval hour = tonumber(strftime(_time, \"%H\")) \n| eval tod_multiplier = case(\n    hour>=0 AND hour<7, 2,\n    hour>=7 AND hour<19, 1,\n    hour>=19, 1.5\n    ) \n| eval ext_multiplier = if(external_suspicious=1, 5, 1) \n| eval adjusted_fail_score = fail_count * tod_multiplier * ext_multiplier\n| where adjusted_fail_score >= 3 OR external_suspicious=1\n\n| rename fail_count AS \"Number of attempts\" \n| table \"Device Name\", \"User\", src_ips, \"Login Activity\" _time\n| rename src_ips as \"Source IP\""
  },
  {
    "name": "Path traversal attempt on web server detected",
    "description": "Triggered when web requests match path traversal attack patterns that attempt to access files outside the intended web directory\nConditions:\nsearch http_url IN (\"*../..*\", \"*..\\\\..*\", \"*%2e%2e%2f*\", \"*%2e%2e%5c*\", \"*%c0%af*\", \"*%c1%9c*\", \"*etc/passwd*\", \"*win.ini*\", \"*boot.ini*\",*\"..%5C\"*, \"*..%2f*\")",
    "spl": "index=* host=fortiweb_vm type=traffic original_src!=115.79.4.73 original_src!=171.252.189.236\n| search http_url IN (\"*../..*\", \"*..\\\\..*\", \"*%2e%2e%2f*\", \"*%2e%2e%5c*\", \"*%c0%af*\", \"*%c1%9c*\", \"*etc/passwd*\", \"*win.ini*\", \"*boot.ini*\")\n| stats count as total_traffic,\n        max(http_response_bytes) as max_response_bytes,\n        avg(http_response_time) as avg_response_time,\n        values(http_url) as path_payloads \n  by _time, original_src, service, http_agent, http_method, http_host\n| search avg_response_time > 1\n| rename original_src as src_ip\n| table _time, src_ip, http_agent, http_method, http_host, avg_response_time, path_payloads, max_response_bytes"
  },
  {
    "name": "User/Group Account Modification Report",
    "description": "Daily report capturing all events related to user/group creation, modification, and deletion on Windows servers.\nConditions:\n+ EventID IN (4720,4726), \"User Account Created/Deleted\",\n+ EventID IN (4704,4705), \"User Right Assigned/Removed\",\n+ EventID IN (4722,4725), \"User Account Enabled/Disabled\"",
    "spl": "index=\"wineventlog\" sourcetype=\"XmlWinEventLog\" \n(EventID IN (4720,4726) OR EventID IN (4704,4705) OR EventID IN (4722,4725))\n| eval Time=strftime(_time,\"%m/%d %H:%M:%S\")\n| rename Caller_User_Name as \"Performed by\", \n        TargetUserName as \"Target Account\", \n        result as \"Action\", \n        host as \"Host\"\n| eval Event_Type=case(\n        EventID IN (4720,4726), \"User Account Created/Deleted\",\n        EventID IN (4704,4705), \"User Right Assigned/Removed\",\n        EventID IN (4722,4725), \"User Account Enabled/Disabled\",\n        true(), \"Other\"\n)\n| table Time, \"Host\", \"Performed by\", \"Target Account\", \"Action\", Event_Type\n| sort - Time"
  },
  {
    "name": "Audit log cleared",
    "description": "A 3-min alert detection leveraging Windows event logs to monitor for log clearing activities. \n\nConditions:\n+ EventID=1102\n\nSchedule: Every 3 mins",
    "spl": "index=\"wineventlog\" \n(eventtype=wineventlog_system EventCode=104) \nOR (eventtype=wineventlog_security EventCode IN (1100,1102))\n| eval Time=strftime(_time,\"%m/%d %H:%M:%S\")\n| eval User=coalesce(Caller_User_Name, TargetUserName, SubjectUserName, user)\n| eval DisplayMessage=case(EventCode=104, result, EventCode IN (1100,1102), name, true(), Message)\n| rename Caller_User_Name as \"Caller_User_Name\", host as \"Host\", source as \"Source\"\n| table Time Host EventCode Source DisplayMessage User"
  },
  {
    "name": "User account lockout caused by multiple failed login attempts",
    "description": "A 15-min alert that detect the user account lockout caused by multiple failed login attempts.\nConditions:\nXmlWinEventLog return EventID=4740",
    "spl": "index=wineventlog AND sourcetype=\"XmlWinEventLog\" AND EventID=4740\n| eval Time=strftime(_time,\"%m/%d %H:%M:%S\"), User = Target_Domain + TargetUserName\n| rename User as \"Performed by\", src_ip as \"Source IP\"\n| table Time, \"Source IP\", \"Performed by\""
  },
  {
    "name": "SMB outbound traffic detected",
    "description": "An hourly alert that detects outbound SMB (Server Message Block) connections from internal hosts to external servers. \n\nConditions:\nAll_Traffic.action IN (\"allowed\", \"allow\") \nAND (All_Traffic.dest_port=139 OR All_Traffic.dest_port=445 OR All_Traffic.app=\"smb\") \nAND All_Traffic.src_ip IN ( \"10.0.0.0/8\",\"172.16.0.0/12\",\"192.168.0.0/16\" )  \nAND NOT All_Traffic.dest_ip IN ( \"10.0.0.0/8\", \"172.16.0.0/12\", \"192.168.0.0/16\", \"100.64.0.0/10\",  127.0.0.0/8\", \"169.254.0.0/16\", \"192.0.0.0/24\", \"192.0.0.0/29\", \"192.0.0.8/32\",  \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\",  \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"192.175.48.0/24\",  \"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\" ) \n\nSchedule: Every hour",
    "spl": "| tstats `security_content_summariesonly`  \nearliest(_time) as start_time  \nlatest(_time) as end_time  \nvalues(All_Traffic.action) as action  \nvalues(All_Traffic.app) as app \nvalues(sourcetype) as sourcetype count  \nfrom datamodel=Network_Traffic where \n  All_Traffic.action IN (\"allowed\", \"allow\") AND \n  (All_Traffic.dest_port=139 OR All_Traffic.dest_port=445 OR All_Traffic.app=\"smb\") \nAND All_Traffic.src_ip IN ( \n  \"10.0.0.0/8\",\"172.16.0.0/12\",\"192.168.0.0/16\" \n)  \nAND NOT All_Traffic.dest_ip IN ( \n\"10.0.0.0/8\", \"172.16.0.0/12\", \"192.168.0.0/16\", \"100.64.0.0/10\",  \n\"127.0.0.0/8\", \"169.254.0.0/16\", \"192.0.0.0/24\", \"192.0.0.0/29\", \"192.0.0.8/32\",  \n\"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\",  \n\"192.31.196.0/24\", \"192.52.193.0/24\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"192.175.48.0/24\",  \n\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\" \n) \nby All_Traffic.action All_Traffic.app All_Traffic.bytes All_Traffic.bytes_in All_Traffic.bytes_out \nAll_Traffic.dest All_Traffic.dest_ip All_Traffic.dest_port All_Traffic.dvc All_Traffic.protocol \nAll_Traffic.protocol_version All_Traffic.src All_Traffic.src_ip All_Traffic.src_port \nAll_Traffic.transport All_Traffic.user All_Traffic.vendor_product All_Traffic.rule  \n| `drop_dm_object_name(\"All_Traffic\")`   \n| `security_content_ctime(start_time)`   \n| `security_content_ctime(end_time)`  \n| iplocation dest_ip  \n| `detect_outbound_smb_traffic_filter`\n| rename Region AS dest_region\n| table action, user, app, src_ip, src_port, dest_ip, dest_port, dest_region, protocol, vendor_product, rule, start_time, end_time, bytes, bytes_out"
  },
  {
    "name": "Cleartext network protocols usage",
    "description": "List all network traffic on cleartext protocols such as Telnet (port 23), POP3 (port 110), IMAP (port 143), TFTP (port 69), Finger (port 79), SMB (port 137-139) and non-anonymous FTP (port 21) in last 7 days.\n\nConditions:\ndest_port IN (23, 143, 110, 21) AND protocol=tcp\nexclude dest=\"172.17.22.11\" AND port=\"21\"\nexclude port=139 AND service=SAMBA\n\nSchedule: Wed at 6AM",
    "spl": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Network_Traffic where NOT All_Traffic.action IN (\"blocked\", \"block\") AND All_Traffic.transport=\"tcp\" AND (All_Traffic.dest_port IN (23,143,110,69,79, 137, 138, 139) OR (All_Traffic.dest_port=\"21\" AND All_Traffic.user != \"anonymous\")) NOT (All_Traffic.dest=\"172.17.22.11\" AND All_Traffic.dest_port=\"21\") NOT (All_Traffic.dest_port=\"139\" All_Traffic.service=\"SAMBA\") by All_Traffic.user All_Traffic.src_ip All_Traffic.dest All_Traffic.dest_port All_Traffic.rule | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `drop_dm_object_name(\"All_Traffic\")` | `protocols_passing_authentication_in_cleartext_filter`"
  },
  {
    "name": "Windows Sensitive Privilege Usage Detected",
    "description": "This alert detects the use of sensitive privileges on Windows Server, which may indicate attempt to escalate privileges or tamper with system security.\nConditions:\n+ EventID 4672: Special privileges assigned to new logon.\n+ EventID 4673: A privileged service was called.\n+ EventID 4674: An operation was attempted on a privileged object.\n+ Whitelist: System users",
    "spl": "index=wineventlog (EventCode=4672 OR EventCode=4673 OR EventCode=4674)\n| where NOT `ibank_AD_user`\n| eval Time=strftime(_time,\"%Y-%m-%d %H:%M:%S\")\n| eval EventDesc=case(\n        EventCode=4672, \"Special privileges assigned to new logon\",\n        EventCode=4673, \"A privileged service was called\",\n        EventCode=4674, \"An operation was attempted on a privileged object\"\n  )\n| table Time, host, Caller_User_Name, EventCode, EventDesc, PrivilegeList\n| sort - Time"
  },
  {
    "name": "Device Stopped Sending Logs",
    "description": "An hourly alert that triggers when a monitored device has not sent any logs in the past 2 hours, indicating possible device downtime, logging misconfiguration, or connectivity issues.\nIf the issue persists, the alert will continue to notify for the next 12 hours.\n\nConditions:\nofflinetime >= 7200",
    "spl": "| metadata index=* type=hosts\n| eval last_time=strftime(lastTime,\"%d/%m %H:%M:%S\"), offlinetime=now() - lastTime\n| search offlinetime >= 7200 AND totalCount > 0\n| eval offlinetime=round(offlinetime/3600,2)\n| join host type=inner max=0 field_name\n    [ | tstats count where index=* by index host source sourcetype ]\n| stats values(sourcetype) as sourcetypes,\n        values(index) as indexes,\n        values(source) as sources,\n        max(last_time) as last_time,\n        max(offlinetime) as offlinetime\n    by host\n| search NOT host=.self NOT host=*techlabcorp* NOT host=172.17.28.130 \n        NOT host=failure NOT host=dc_fac_vm01 NOT host=0 NOT host=splunklog NOT sourcetypes=\"*cef\"\n| table host, indexes, sources, sourcetypes, last_time, offlinetime\n\n| append\n    [ | tstats max(_time) as lastTime where index=* sourcetype=\"*cef\" by index, source, sourcetype\n      | stats values(sourcetype) as sourcetype, max(lastTime) as lastTime by index, source\n      | eval host=\"CyberArk-vault-server\"\n      | eval offlinetime=round((now()-lastTime)/3600,2)\n      | eval last_time=strftime(lastTime,\"%d/%m %H:%M:%S\")\n      | eval sourcetypes=sourcetype\n      | eval indexes=index\n      | eval sources=source\n      | search offlinetime >= 7200 AND totalCount > 0\n      | table host, indexes, sources, sourcetypes, last_time, offlinetime\n    ]"
  },
  {
    "name": " Suspicious Login to Windows Server",
    "description": "An 15-minute alert that detects suspicious login attempts to windows servers. The alert is triggered when the overall risk score, calculated based on the number of attempts, login time, and IP information, exceeds the risk threshold.\nConditions:\n12AM-7AM: risk_multiplier =2,\n7AM-19PM: risk_multiplier=1\n19PM-12AM: risk_multiplier= 1.5\nrisk_score = num_fail_attempts * risk_multiplier\nrisk_score > 3\n\nSchedule: Every hour",
    "spl": "index=\"wineventlog\" \nEventCode=\"4625\" OR EventCode=\"4672\"\n| where NOT `ibank_AD_user`\n| where NOT Caller_User_Name=\"IUSR\" AND NOT Caller_User_Name=\"CLIUSR\"\n| eval EventTime=strftime(_time,\"%Y-%m-%d %H:%M:%S\")\n| eval priv_list=subject.\": \".PrivilegeList\n| eval msg=coalesce(priv_list, name)\n| eval src_ip= if(isnull(IpAddress) OR IpAddress=\"\" OR IpAddress=\"-\",\"N/A\",if(match(IpAddress,\"::ffff:\"), replace(IpAddress,\"::ffff:\",\"\"), IpAddress))\n| eval device_name=host\n| eval Error_Code=coalesce(FailureReason, Error_Code, \"\")\n| eval TargetUserName=coalesce(TargetUserName, Caller_User_Name)\n| eval line = EventTime.\" | \".src_ip.\" | \".msg.\" | \".Error_Code\n\n| eval is_fail = if(EventCode=4625, 1, 0)\n| eval priv_flag = if(EventCode=4672 AND mvfind(msg, \"Special privileges assigned to new logon\") >= 0, 1, 0)\n| bin _time span=15m\n\n| stats  sum(is_fail) as fail_count\n         max(priv_flag) as priv_seen\n         values(src_ip) as src_ips\n         values(line) as lines\n         min(_time) as first_evt\n         max(_time) as last_evt\n  by device_name TargetUserName _time\n\n| eval fail_count = if(fail_count=0,1,fail_count)\n| eval external_ips = if(\n    isnull(src_ips) OR mvcount(src_ips)=0 OR src_ips=\"N/A\",\n    null(),\n    mvfilter(\n        NOT cidrmatch(\"10.0.0.0/8\", src_ips)\n        AND NOT cidrmatch(\"172.16.0.0/12\", src_ips)\n        AND NOT cidrmatch(\"192.168.0.0/16\", src_ips)\n    )\n)\n| eval ext_multiplier = if(mvcount(external_ips)>0, 5, 1)\n| eval hour = tonumber(strftime(_time, \"%H\"))\n| eval tod_multiplier = case(hour>=0 AND hour<7, 2, hour>=7 AND hour<19, 1, true(), 1.5)\n| eval priv_multiplier = if(priv_seen=1, 4, 1)\n| eval risk = fail_count * tod_multiplier * ext_multiplier * priv_multiplier\n\n| where risk >= 5\n\n| rename lines as \"Login Activity (Time | Source IP | Message | Error Code)\"\n| rename risk as \"Risk Score\"\n| rename src_ips as \"Source IPs\"\n| rename device_name as \"Device Name\"\n| rename TargetUserName as \"User\"\n| table \"Device Name\" User \"Source IPs\" \"Login Activity (Time | Source IP | Message | Error Code)\" \"Risk Score\""
  },
  {
    "name": "Suspicious VPN Login Activity",
    "description": "This alert is designed to detect suspicious VPN login activities. It identifies potential threats by searching for the number of failure attempts and successful off-hours access.\n\nConditions:\n- From 00:00 → 06:00 and 22:00 → 24:00, if a user fails to log in 2 times, trigger an alert.\n- From 06:00 → 22:00, if a user fails to log in 3 times, trigger an alert.\nFrom 22:00 → 06:00, if a user has at least one failed and one successful login attempt, trigger an alert.",
    "spl": "index=* sourcetype=\"pan:globalprotect\"\n| where src_ip!=\"0.0.0.0\"\n| stats count(eval(result=\"failure\" AND log_subtype=\"login\")) as num_failed_logins,\n        count(eval(result=\"success\" AND log_subtype=\"login\" AND event_id=\"gateway-auth\" AND isnull(opaque))) as num_successful_logins,\n        min(_time) as first_event_time,\n        max(_time) as last_event_time,\n        by user, src_ip\n| eval current_hour = tonumber(strftime(last_event_time, \"%H\")),\n       first_event_time = strftime(first_event_time, \"%Y-%m-%d %H:%M:%S\"),\n       last_event_time = strftime(last_event_time, \"%Y-%m-%d %H:%M:%S\")\n| eval success_risk_score   = if((current_hour<=8 OR current_hour>=18) AND num_successful_logins>=1 AND num_failed_logins>=1, 3, 0),\n       risk_multiplier      = if(current_hour>=6 AND current_hour<=22, 1.0, 2.0), \n       fail_risk_score      = num_failed_logins * risk_multiplier\n| eval total_risk_score = fail_risk_score + success_risk_score\n| eval event_message = (if(total_risk_score>2, \"Total Risk Score Exceeded (\" + tostring(total_risk_score) + \")\", null()))\n| where isnotnull(event_message)\n| table first_event_time, user, src_ip, num_failed_logins, num_successful_logins, total_risk_score"
  },
  {
    "name": "Exchange Transport Rule Modification",
    "description": "This alert monitors the Exchange admin audit logs to detect when a user creates, modifies, or removes a mail flow rule (transport rule). The alert provides details on who made the change, what command was used, and the parameters involved for immediate security review.\n\nConditions:\nCmdlet = *TransportRule*",
    "spl": "index=\"msexchange\" sourcetype=*AdminAudit*\n| search Cmdlet = *TransportRule*\n| rename User as user, Cmdlet as action, Param as param, Success as success_status\n| table _time, host, user, action, param, success_status"
  },
  {
    "name": "Firewall Policy Configuration Change Report",
    "description": "This report lists firewall policy changes that have been made in the past 7 days. The purpose is to help system administrators review unauthorize or improperly configured firewall policies.\n\nConditions:\n       Firewall policies modification or creation and related setting like configuring interfaces\n\nSchedule: Every week - Wednesday - 8:00 AM\nTime range: Last 7 days",
    "spl": "index=\"netops\" \n    (\n    user!=\"system\" \n    user!=\"update_manager\" \n    user!=\"fgdlinkd\" \n    operation!=login* \n    operation!=logout* \n    operation!=\"system session\"\n    )\n    OR\n    (\n    tag=change sourcetype!=\"pan:system\" NOT ui=\"ha_daemon\" NOT action=\"logoff\" NOT action=\"read\" NOT logid=\"0100041000\" NOT logid=\"0100032040\" NOT logid=\"0100032029\"\n    ) \n    NOT changes=\"Send a test*\"\n    NOT cmd=\"commit\"\n    NOT msg=\"Configuration is changed in the admin session\"    \n    | where like(msg,\"Add firewall.policy%\") \n   OR like(msg,\"Edit firewall.policy%\") \n   OR like(msg,\"%firewall.address%\") \n   OR like(msg,\"%firewall.addrgrp%\") \n   OR like(msg,\"%firewall.service.custom%\") \n   OR like(path,\"%address%\") \n   OR like(path,\"%rulebase security rules%\")\n| eval Time = strftime(_time, \"%Y-%m-%d %H:%M:%S\") \n| eval \"Device Name\" = coalesce(devname, dvc) \n| eval \"User\" = coalesce(user, 'User') \n| eval \"User Source\" = coalesce(userfrom, ui, \"N/A\") \n| eval \"Operation Performed\" = coalesce(operation, action, cmd) \n| rex field=cfgattr \"uuid\\\\s*\\\\[(?<policy_id>.*?)(?=\\\\\\\\*\\\\])\\\\\\\\*\\\\]\"\n| lookup firewall_policies_record _key AS policy_id OUTPUT policy_name\n| eval policy_label = coalesce(policy_name, policy_id, \"unknown\")\n| eval \"Change Summary\" = case(\n    isnotnull(changes) AND changes!=\"\", changes,\n    like(msg,\"Edit firewall.policy%\"), \"Edit firewall policy \\\"\" . policy_label . \"\\\"\",\n    like(msg,\"Add firewall.policy%\"),  \"Add firewall policy \\\"\"  . policy_label . \"\\\"\",\n    isnotnull(msg) AND msg!=\"\", msg,\n    isnotnull(desc) AND desc!=\"\", desc,\n    isnotnull(path) AND path!=\"\", path,\n    cmd==\"commit\", \"Commit changes\",\n    true(), null()\n)\n| rex field=cfgattr max_match=0 \"(?<!\\w)(?<policy_field>(?!uuid\\b)[A-Za-z0-9_/\\-]+)\\[(?<policy_field_old_value>.*?)(?=->|\\\\\\\\*\\])(?:->(?<policy_field_new_value>.*?))?\\\\\\\\*\\]\"\n| eval old_len = mvcount(policy_field_old_value)\n| eval new_len = mvcount(policy_field_new_value)\n\n| eval new_list = if(new_len=old_len AND new_len>0,\n                     policy_field_new_value,\n                     mvmap(mvrange(0, old_len), \"\"))\n| eval field_eq_old        = mvzip(policy_field, policy_field_old_value, \": \")\n| eval field_eq_old_to_new = mvzip(field_eq_old, new_list, \" -> \")\n| eval NL = printf(\"%c\",10)\n| eval tmp = mvjoin(field_eq_old_to_new, NL)\n\n| eval \"Change Details\" = replace(tmp, \" -> (?=(?:\\r?\\n|$))\", \"\")\n\n| table Time \"Device Name\" User \"User Source\" \"Operation Performed\" \"Change Summary\" \"Change Details\"\n| sort - Time"
  }
]