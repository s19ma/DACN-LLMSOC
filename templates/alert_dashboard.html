<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOC AI Assistant - Splunk Alert Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .severity-critical { background-color: #dc3545; color: white; }
        .severity-high { background-color: #fd7e14; color: white; }
        .severity-medium { background-color: #ffc107; color: black; }
        .severity-low { background-color: #28a745; color: white; }
        
        .status-new { background-color: #6f42c1; color: white; }
        .status-in-progress { background-color: #17a2b8; color: white; }
        .status-resolved { background-color: #28a745; color: white; }
        .status-closed { background-color: #6c757d; color: white; }
        
        .alert-card {
            transition: transform 0.2s;
            border-left: 4px solid #dee2e6;
        }
        
        .alert-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .alert-card.critical { border-left-color: #dc3545; }
        .alert-card.high { border-left-color: #fd7e14; }
        .alert-card.medium { border-left-color: #ffc107; }
        .alert-card.low { border-left-color: #28a745; }
        
        .btn-action {
            margin: 2px;
            font-size: 0.875rem;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .header-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
        }

        /* Investigation Plan Modal Styles */
        .investigation-overview .alert {
            margin-bottom: 1rem;
        }
        
        .investigation-steps-summary {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .step-summary-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef !important;
            transition: all 0.2s ease;
        }
        
        .step-summary-item:hover {
            background: #e3f2fd;
            border-color: #2196f3 !important;
            transform: translateX(2px);
        }
        
        .step-summary-item .badge {
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .investigation-plan-modal .modal-body {
            padding: 1.5rem;
        }
        
        .investigation-plan-modal .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom: none;
        }
        
        .investigation-plan-modal .modal-footer {
            border-top: 1px solid #e9ecef;
            padding: 1rem 1.5rem;
        }
    </style>
</head>
<body>
    <!-- Header Section -->
    <div class="header-section">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-0"><i class="fas fa-shield-alt me-3"></i>SOC AI Assistant</h1>
                    <p class="mb-0 mt-2">Splunk Security Alert Management Dashboard</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="stats-card p-3 rounded">
                        <div class="d-flex justify-content-between">
                            <div>
                                <small>Total Alerts</small>
                                <h4 class="mb-0">{{ alerts|length }}</h4>
                            </div>
                            <div>
                                <small>Critical</small>
                                <h4 class="mb-0 text-danger">{{ alerts|selectattr('severity', 'equalto', 'Critical')|list|length }}</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-4">
        <!-- Quick Actions -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary" onclick="refreshAlerts()">
                                <i class="fas fa-sync me-1"></i>Refresh
                            </button>
                            <button type="button" class="btn btn-outline-info" onclick="filterByStatus('New')">
                                <i class="fas fa-filter me-1"></i>New Alerts
                            </button>
                            <button type="button" class="btn btn-outline-warning" onclick="filterBySeverity('Critical')">
                                <i class="fas fa-exclamation-triangle me-1"></i>Critical
                            </button>
                            <button type="button" class="btn btn-outline-success" onclick="showAllAlerts()">
                                <i class="fas fa-list me-1"></i>Show All
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alerts Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-exclamation-circle me-2"></i>Security Alert List</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>ID</th>
                                        <th>Title</th>
                                        <th>Severity</th>
                                        <th>Status</th>
                                        <th>Timestamp</th>
                                        <th>Last Updated</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for alert in alerts %}
                                    <tr class="alert-row" data-severity="{{ alert.severity }}" data-status="{{ alert.status }}">
                                        <td>
                                            <span class="badge bg-secondary">{{ alert.id }}</span>
                                        </td>
                                        <td>
                                            <a href="/alert/{{ alert.alert_id }}" class="text-decoration-none">
                                                <strong>{{ alert.title }}</strong>
                                            </a>
                                            <br>
                                            <small class="text-muted">{{ alert.description[:80] }}...</small>
                                        </td>
                                        <td>
                                            <span class="badge severity-{{ alert.severity.lower() }}">
                                                {% if alert.severity == 'Critical' %}
                                                    <i class="fas fa-fire me-1"></i>
                                                {% elif alert.severity == 'High' %}
                                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                                {% elif alert.severity == 'Medium' %}
                                                    <i class="fas fa-exclamation-circle me-1"></i>
                                                {% else %}
                                                    <i class="fas fa-info-circle me-1"></i>
                                                {% endif %}
                                                {{ alert.severity }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge status-{{ alert.status.lower().replace(' ', '-') }}">
                                                {{ alert.status }}
                                            </span>
                                        </td>
                                        <td>
                                            <small>{{ alert.timestamp }}</small>
                                        </td>
                                        <td>
                                            <small>
                                                {% if alert.last_updated %}
                                                    {{ alert.last_updated }}
                                                {% else %}
                                                    {{ last_excel_modified }}
                                                {% endif %}
                                            </small>
                                        </td>
                                        <td>
                                            <div class="btn-group-vertical btn-group-sm">
                                                <button class="btn btn-outline-primary btn-action" 
                                                        onclick="explainStatus('{{ alert.alert_id }}')">
                                                    <i class="fas fa-info-circle me-1"></i>Explain
                                                </button>
                                                <button class="btn btn-outline-success btn-action" 
                                                        onclick="openQAAssistant('{{ alert.alert_id }}')">
                                                    <i class="fas fa-question-circle me-1"></i>Q&A
                                                </button>
                                                <button class="btn btn-outline-warning btn-action" 
                                                        onclick="startInvestigation('{{ alert.alert_id }}')">
                                                    <i class="fas fa-search me-1"></i>Investigate
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Status Explanation -->
    <div class="modal fade" id="statusModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-info-circle me-2"></i>Alert Status Explanation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-start">
                    <div id="statusExplanation" class="text-start">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Analyzing...</span>
                        </div>
                        <p class="mt-2">AI is analyzing the alert...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary me-2" id="reanalyzeStatusBtn" onclick="reanalyzeStatusExplanation()">
                        <i class="fas fa-sync-alt"></i> Re-analyze
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Q&A Assistant -->
    <div class="modal fade" id="qaModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-question-circle me-2"></i>AI Q&A Assistant</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="questionInput" class="form-label">Ask a question about this alert:</label>
                        <textarea class="form-control" id="questionInput" rows="3" 
                                  placeholder="Example: What is the threat level of this scanning activity?"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Suggested questions:</label>
                        <div id="predefinedQuestions"></div>
                    </div>
                    <div id="qaResponse" style="display: none;">
                        <label class="form-label">AI Response:</label>
                        <div class="alert alert-info" id="qaAnswer"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="askQuestion()">Ask AI</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Investigation -->
    <div class="modal fade investigation-plan-modal" id="investigationModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-search me-2"></i>Start Investigation</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="investigationPlan" class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Initializing...</span>
                        </div>
                        <p class="mt-2">AI is creating investigation plan...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" id="proceedInvestigation" style="display: none;" onclick="proceedWithInvestigation()">
                        Proceed with Investigation
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    {% if load_error %}
        <div class="alert alert-danger mt-4" role="alert">
            <strong>{{ load_error }}</strong>
        </div>
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentAlertId = null;

        function refreshAlerts() {
            location.reload();
        }

        function filterByStatus(status) {
            const rows = document.querySelectorAll('.alert-row');
            rows.forEach(row => {
                if (row.dataset.status === status) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function filterBySeverity(severity) {
            const rows = document.querySelectorAll('.alert-row');
            rows.forEach(row => {
                if (row.dataset.severity === severity) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function showAllAlerts() {
            const rows = document.querySelectorAll('.alert-row');
            rows.forEach(row => {
                row.style.display = '';
            });
        }

        function explainStatus(alertId) {
            currentAlertId = alertId;
            document.getElementById('statusExplanation').innerHTML = `
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Analyzing...</span>
                </div>
                <p class="mt-2">AI is analyzing the alert...</p>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('statusModal'));
            modal.show();
            
            fetch('/api/explain-status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ alert_id: alertId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('statusExplanation').innerHTML = data.explanation;
                } else {
                    document.getElementById('statusExplanation').innerHTML = 
                        `<div class="alert alert-danger">Error: ${data.error}</div>`;
                }
            })
            .catch(error => {
                document.getElementById('statusExplanation').innerHTML = 
                    `<div class="alert alert-danger">Connection error: ${error.message}</div>`;
            });
        }

        function openQAAssistant(alertId) {
            currentAlertId = alertId;
            document.getElementById('questionInput').value = '';
            document.getElementById('qaResponse').style.display = 'none';
            
            const modal = new bootstrap.Modal(document.getElementById('qaModal'));
            modal.show();
            
            // Load predefined questions (this would be populated from server data)
            const predefinedDiv = document.getElementById('predefinedQuestions');
            predefinedDiv.innerHTML = `
                <button class="btn btn-sm btn-outline-primary me-2 mb-2" onclick="setQuestion('What is the threat level of this scanning activity?')">
                    Threat Level
                </button>
                <button class="btn btn-sm btn-outline-primary me-2 mb-2" onclick="setQuestion('Which systems are being targeted?')">
                    Targeted Systems
                </button>
                <button class="btn btn-sm btn-outline-primary me-2 mb-2" onclick="setQuestion('What is the source IP reputation?')">
                    IP Reputation
                </button>
                <button class="btn btn-sm btn-outline-primary me-2 mb-2" onclick="setQuestion('Are there signs of successful compromise?')">
                    Compromise Indicators
                </button>
            `;
        }

        function setQuestion(question) {
            document.getElementById('questionInput').value = question;
        }

        function askQuestion() {
            const question = document.getElementById('questionInput').value;
            if (!question.trim()) {
                alert('Please enter a question');
                return;
            }
            
            document.getElementById('qaResponse').style.display = 'block';
            document.getElementById('qaAnswer').innerHTML = 
                '<div class="spinner-border spinner-border-sm me-2"></div>AI is processing question...';
            
            fetch('/api/qa-assistant', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    alert_id: currentAlertId,
                    question: question 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('qaAnswer').innerHTML = data.answer;
                } else {
                    document.getElementById('qaAnswer').innerHTML = 
                        `<span class="text-danger">Error: ${data.error}</span>`;
                }
            })
            .catch(error => {
                document.getElementById('qaAnswer').innerHTML = 
                    `<span class="text-danger">Connection error: ${error.message}</span>`;
            });
        }

        function startInvestigation(alertId) {
            currentAlertId = alertId;
            document.getElementById('investigationPlan').innerHTML = `
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Initializing...</span>
                </div>
                <p class="mt-2">AI is creating investigation plan...</p>
            `;
            document.getElementById('proceedInvestigation').style.display = 'none';
            
            const modal = new bootstrap.Modal(document.getElementById('investigationModal'));
            modal.show();
            
            fetch('/api/start-investigation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ alert_id: alertId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Enhanced investigation plan display with step summaries
                    let stepSummariesHtml = '';
                    if (data.steps && data.steps.length > 0) {
                        stepSummariesHtml = '<div class="investigation-steps-summary mt-3">';
                        stepSummariesHtml += '<h6 class="text-primary mb-3"><i class="fas fa-list-ol me-2"></i>Investigation Steps:</h6>';
                        
                        data.steps.forEach((step, index) => {
                            const stepNumber = index + 1;
                            const stepTitle = step.title || step.phase || `Step ${stepNumber}`;
                            const stepDescription = step.description || step.phase_description || 'No description available';
                            
                            stepSummariesHtml += `
                                <div class="step-summary-item d-flex align-items-start mb-3 p-3 border rounded">
                                    <span class="badge bg-primary me-3" style="min-width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;">${stepNumber}</span>
                                    <div class="flex-grow-1">
                                        <div class="fw-bold text-dark mb-1">${stepTitle}</div>
                                        <div class="text-muted small">${stepDescription}</div>
                                        ${step.detail_actions ? `
                                            <div class="mt-2">
                                                <small class="text-info"><i class="fas fa-info-circle me-1"></i>Actions: ${step.detail_actions.substring(0, 100)}${step.detail_actions.length > 100 ? '...' : ''}</small>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        });
                        stepSummariesHtml += '</div>';
                    }
                    
                    document.getElementById('investigationPlan').innerHTML = `
                        <div class="investigation-overview">
                            <div class="alert alert-info border-0 shadow-sm">
                                <div class="row">
                                    <div class="col-md-4">
                                        <h6 class="mb-1"><i class="fas fa-id-badge me-2 text-primary"></i>Investigation ID</h6>
                                        <span class="badge bg-light text-dark fs-6">${data.investigation_id}</span>
                                    </div>
                                    <div class="col-md-4">
                                        <h6 class="mb-1"><i class="fas fa-book me-2 text-primary"></i>Playbook</h6>
                                        <span class="text-dark fw-semibold">${data.playbook_name || 'Unknown Playbook'}</span>
                                    </div>
                                    <div class="col-md-4">
                                        <h6 class="mb-1"><i class="fas fa-clock me-2 text-primary"></i>Started</h6>
                                        <span class="text-muted">${new Date().toLocaleString()}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="alert alert-success border-0 shadow-sm">
                                <h6 class="mb-2"><i class="fas fa-check-circle me-2"></i>Investigation Plan Ready</h6>
                                <p class="mb-2">
                                    <strong>${data.steps ? data.steps.length : 0} step investigation playbook</strong> has been loaded for 
                                    <span class="text-primary fw-semibold">${data.playbook_name || 'this alert'}</span>.
                                </p>
                                <p class="mb-0 small text-muted">
                                    This playbook will guide you through a comprehensive investigation process with AI-powered analysis at each step.
                                </p>
                            </div>
                            
                            ${stepSummariesHtml}
                        </div>
                    `;
                    document.getElementById('proceedInvestigation').style.display = 'block';
                } else {
                    document.getElementById('investigationPlan').innerHTML = 
                        `<div class="alert alert-danger">Error: ${data.message || data.error || 'Unknown error'}</div>`;
                }
            })
            .catch(error => {
                document.getElementById('investigationPlan').innerHTML = 
                    `<div class="alert alert-danger">Connection error: ${error.message}</div>`;
            });
        }

        function proceedWithInvestigation() {
            if (currentAlertId) {
                // Close the modal and navigate to the alert detail page
                const modal = bootstrap.Modal.getInstance(document.getElementById('investigationModal'));
                if (modal) {
                    modal.hide();
                }
                // Navigate to the alert detail page where the full investigation interface is available
                window.location.href = `/alert/${currentAlertId}`;
            } else {
                alert('No alert selected for investigation');
            }
        }

        function reanalyzeStatusExplanation() {
            const btn = document.getElementById('reanalyzeStatusBtn');
            btn.disabled = true;
            const statusDiv = document.getElementById('statusExplanation');
            statusDiv.innerHTML = `
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Re-analyzing...</span>
                </div>
                <p class="mt-2">AI is re-analyzing the alert...</p>
            `;
            fetch('/api/explain-status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ alert_id: currentAlertId, reanalyze: true })
            })
            .then(resp => resp.json())
            .then(data => {
                if (data.status === 'success') {
                    statusDiv.innerHTML = data.explanation;
                } else {
                    statusDiv.innerHTML = `<div class='alert alert-danger'>${data.error || 'Re-analysis failed.'}</div>`;
                }
            })
            .catch(() => { statusDiv.innerHTML = `<div class='alert alert-danger'>Re-analysis failed.';</div>`; })
            .finally(() => { btn.disabled = false; });
        }
    </script>
</body>
</html>