<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Alert Details {{ alert.id }} - SOC AI Assistant</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      .severity-critical {
        background-color: #dc3545;
        color: white;
      }
      .severity-high {
        background-color: #fd7e14;
        color: white;
      }
      .severity-medium {
        background-color: #ffc107;
        color: black;
      }
      .severity-low {
        background-color: #28a745;
        color: white;
      }

      .header-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 0;
        position: relative;
        overflow: hidden;
      }

      .header-section::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" patternUnits="userSpaceOnUse" width="100" height="100"><circle cx="20" cy="20" r="1" fill="white" opacity="0.1"/><circle cx="60" cy="60" r="1" fill="white" opacity="0.1"/><circle cx="80" cy="30" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>')
          repeat;
        opacity: 0.3;
        pointer-events: none; /* Allow clicks through overlay */
      }

      .detail-card {
        border: none;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border-radius: 12px;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .detail-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .query-box {
        background: linear-gradient(145deg, #f8f9fa, #e9ecef);
        border-left: 4px solid #007bff;
        font-family: "Courier New", monospace;
        border-radius: 8px;
        position: relative;
        overflow: hidden;
      }

      .query-box::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(to bottom, #007bff, #0056b3);
      }

      .ai-reasoning-card {
        background: linear-gradient(145deg, #fff, #f8f9fa);
        border: 2px solid #e3f2fd;
        border-radius: 15px;
        position: relative;
        overflow: hidden;
        line-height: 1.6;
      }

      .ai-reasoning-card::before {
        content: "ðŸ¤–";
        position: absolute;
        top: -10px;
        right: -10px;
        font-size: 3rem;
        opacity: 0.1;
      }

      .ai-reasoning-card h6 {
        color: #0d6efd;
        border-bottom: 2px solid #e3f2fd;
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
      }

      .ai-reasoning-card ul {
        background-color: rgba(13, 110, 253, 0.05);
        padding: 1rem;
        border-radius: 8px;
        border-left: 4px solid #0d6efd;
      }

      .ai-reasoning-card code {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        color: #d63384;
      }

      .conclusion-box {
        background: linear-gradient(145deg, #f8fff8, #e8f5e8);
        border: 2px solid #d1ecf1;
        border-radius: 15px;
        position: relative;
        overflow: hidden;
        line-height: 1.6;
      }

      .conclusion-box::before {
        content: "ðŸ’¡";
        position: absolute;
        top: -10px;
        right: -10px;
        font-size: 3rem;
        opacity: 0.2;
      }

      .conclusion-box h6 {
        color: #198754;
        border-bottom: 2px solid #d1ecf1;
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
      }

      .conclusion-box ul {
        background-color: rgba(25, 135, 84, 0.05);
        padding: 1rem;
        border-radius: 8px;
        border-left: 4px solid #198754;
      }

      .progress-step {
        padding: 1rem;
        margin: 0.5rem 0;
        border-radius: 10px;
        border-left: 4px solid #28a745;
        background: linear-gradient(145deg, #f8fff8, #e8f5e8);
        transition: all 0.3s ease;
      }

      .progress-step.active {
        border-left-color: #007bff;
        background: linear-gradient(145deg, #f0f8ff, #e6f3ff);
        animation: pulse 2s infinite;
      }

      /* Highly visible running state */
      .progress-step.step-running {
        border-left-color: #0d6efd;
        background: linear-gradient(145deg, #eaf4ff, #dfeeff);
        box-shadow: 0 8px 30px rgba(13, 110, 253, 0.18);
        transform: translateY(-2px);
        position: relative;
        z-index: 2;
      }

      .progress-step.step-running .playbook-step-number {
        background: linear-gradient(145deg, #0d6efd, #004bb5);
        color: #fff;
        border-radius: 50%;
        width: 42px;
        height: 42px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 6px 18px rgba(13, 110, 253, 0.25);
      }

      /* subtle pulse on the icon to indicate activity */
      .progress-step.step-running .playbook-step-number i {
        animation: iconPulse 1.6s infinite;
      }

      @keyframes iconPulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.08);
        }
        100% {
          transform: scale(1);
        }
      }

      .progress-step.completed {
        border-left-color: #28a745;
        background: linear-gradient(145deg, #f8fff8, #e8f5e8);
      }

      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(0, 123, 255, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(0, 123, 255, 0);
        }
      }

      .reasoning-timeline {
        position: relative;
        padding-left: 2rem;
      }

      .reasoning-timeline::before {
        content: "";
        position: absolute;
        left: 0.5rem;
        top: 0;
        bottom: 0;
        width: 2px;
        background: linear-gradient(to bottom, #007bff, #28a745);
      }

      .reasoning-step {
        position: relative;
        padding: 1rem;
        margin-bottom: 1rem;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .reasoning-step:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
      }

      .reasoning-step.expandable {
        border-left: 4px solid #007bff;
      }

      .reasoning-step.expandable:hover {
        border-left-color: #0056b3;
      }

      .reasoning-step::before {
        content: "";
        position: absolute;
        left: -1.75rem;
        top: 1.5rem;
        width: 12px;
        height: 12px;
        background: #007bff;
        border-radius: 50%;
        border: 3px solid white;
      }

      .reasoning-step.completed::before {
        background: #28a745;
      }

      .btn-enhanced {
        background: linear-gradient(145deg, #007bff, #0056b3);
        border: none;
        border-radius: 10px;
        padding: 0.75rem 1.5rem;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .btn-enhanced::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.3),
          transparent
        );
        transition: left 0.5s;
      }

      .btn-enhanced:hover::before {
        left: 100%;
      }

      .btn-enhanced:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 123, 255, 0.3);
      }

      .interactive-hint {
        background: linear-gradient(145deg, #fff3cd, #ffeaa7);
        border: 1px solid #ffc107;
        border-radius: 10px;
        padding: 1rem;
        position: relative;
        overflow: hidden;
      }

      .interactive-hint::before {
        content: "ðŸ’¡";
        position: absolute;
        top: -5px;
        right: -5px;
        font-size: 2rem;
        opacity: 0.3;
      }

      .qa-container {
        background: linear-gradient(145deg, #ffffff, #f8f9fa);
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .api-result-card {
        background: linear-gradient(145deg, #f8f9fa, #e9ecef);
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1rem;
        position: relative;
        margin-bottom: 0.75rem;
      }

      .api-result-card::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background: linear-gradient(to bottom, #007bff, #28a745);
        border-radius: 8px 0 0 8px;
      }

      .step-detail-panel {
        background: #fff;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .step-header {
        background: linear-gradient(145deg, #f8f9fa, #e9ecef);
        padding: 1rem;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .step-content {
        padding: 1.5rem;
      }

      .conversation-bubble {
        background: linear-gradient(145deg, #e3f2fd, #bbdefb);
        border-radius: 15px 15px 5px 15px;
        padding: 1rem 1.5rem;
        margin: 0.5rem 0;
        position: relative;
        animation: slideIn 0.3s ease;
      }

      .conversation-bubble.ai {
        background: linear-gradient(145deg, #f3e5f5, #e1bee7);
        border-radius: 15px 15px 15px 5px;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 0.5rem;
        animation: pulse 2s infinite;
      }

      .status-indicator.success {
        background: #28a745;
      }
      .status-indicator.warning {
        background: #ffc107;
      }
      .status-indicator.danger {
        background: #dc3545;
      }
      .status-indicator.info {
        background: #17a2b8;
      }

      /* Text alignment - force left alignment throughout */
      .text-left-force,
      .text-left-force * {
        text-align: left !important;
      }

      /* Enhanced chat styling */
      .conversation-bubble {
        text-align: left !important;
        border-radius: 18px;
        margin: 1rem 0;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
      }

      .conversation-bubble.user {
        background: linear-gradient(145deg, #007bff, #0056b3);
        color: white;
        margin-left: auto;
        margin-right: 0;
        max-width: 85%;
        border-radius: 18px 18px 4px 18px;
      }

      .conversation-bubble.ai {
        background: linear-gradient(145deg, #f8f9fa, #e9ecef);
        border: 1px solid #dee2e6;
        margin-left: 0;
        margin-right: auto;
        max-width: 95%;
        border-radius: 18px 18px 18px 4px;
      }

      .conversation-bubble .response-content {
        line-height: 1.6;
        color: #333;
      }

      .conversation-bubble.ai .response-content {
        font-size: 14px;
      }

      .conversation-bubble.user .response-content {
        color: white;
        font-weight: 500;
      }

      /* Quick questions styling - FIXED RIGHT SIDEBAR */
      .quick-questions-sidebar {
        display: none;
      }

      .quick-questions-header {
        background: linear-gradient(135deg, #ffc107, #ff9800);
        color: white;
        padding: 16px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .quick-questions-container {
        overflow-y: auto;
        padding: 0;
        background: #f5f5f5;
      }

      .quick-questions-container::-webkit-scrollbar {
        width: 6px;
      }

      .quick-questions-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
      }

      .quick-questions-container::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
      }

      .quick-questions-container::-webkit-scrollbar-thumb:hover {
        background: #555;
      }

      .quick-question-btn {
        display: block;
        width: 100%;
        padding: 12px 14px;
        margin-bottom: 10px;
        text-align: left !important;
        border-radius: 12px;
        border: 1px solid #d0d0d0 !important;
        background: #ffffff !important;
        transition: all 0.3s ease;
        font-size: 13px !important;
        line-height: 1.5;
        cursor: pointer;
        color: #1a1a1a !important;
        font-weight: 500;
      }

      .quick-question-btn:hover {
        background: linear-gradient(135deg, #007bff, #0056b3) !important;
        color: #ffffff !important;
        border-color: #007bff !important;
        transform: translateX(4px);
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        font-size: 13px !important;
        font-weight: 600 !important;
      }

      .quick-question-btn:active {
        background: linear-gradient(135deg, #0056b3, #003d82) !important;
        color: #ffffff !important;
        border-color: #0056b3 !important;
      }

      .quick-question-btn:focus {
        background: linear-gradient(135deg, #007bff, #0056b3) !important;
        color: #ffffff !important;
        border-color: #007bff !important;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25) !important;
      }

      @media (max-width: 1400px) {
        .quick-questions-sidebar {
          position: static;
          width: 100%;
          max-height: none;
          margin-top: 20px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
      }

      /* Enhanced ChatBot Container */
      .qa-container {
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        border-radius: 16px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      }

      .qa-container .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 16px 16px 0 0;
        border: none;
        padding: 20px;
      }

      .qa-container .card-body {
        padding: 24px;
      }

      #conversationHistory {
        background: white;
        border-radius: 12px;
        padding: 16px;
        border: 1px solid #e9ecef;
      }

      .conversation-bubble {
        margin-bottom: 16px;
        padding: 14px 16px;
        border-radius: 14px;
        line-height: 1.6;
        animation: slideIn 0.3s ease-out;
      }

      .conversation-bubble.ai {
        background: linear-gradient(135deg, #e7f3ff 0%, #f0f9ff 100%);
        border-left: 4px solid #007bff;
        margin-right: 20px;
      }

      .conversation-bubble.user {
        background: linear-gradient(
          135deg,
          #c8e6c9 0%,
          #d4f1d4 100%
        ) !important;
        border-right: 4px solid #28a745;
        margin-left: 20px;
        text-align: right;
        color: #000000 !important;
        font-weight: 600;
      }

      .conversation-bubble.user * {
        color: #000000 !important;
      }

      .conversation-bubble.user p,
      .conversation-bubble.user span,
      .conversation-bubble.user div,
      .conversation-bubble.user strong,
      .conversation-bubble.user b,
      .conversation-bubble.user i,
      .conversation-bubble.user small {
        color: #000000 !important;
      }

      .input-group-lg {
        margin-top: 12px;
      }

      .input-group-lg .form-control {
        border-radius: 12px 0 0 12px !important;
        border: 2px solid #e9ecef;
        font-size: 14px;
        padding: 12px 16px;
      }

      .input-group-lg .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .input-group-lg .btn {
        border-radius: 0 12px 12px 0 !important;
      }

      /* SPL Query results styling */
      .spl-query-card {
        background: linear-gradient(145deg, #fff, #f8f9fa);
        border: 1px solid #e9ecef;
        border-radius: 12px;
        margin-bottom: 15px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .spl-query-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
      }

      .spl-query-header {
        background: linear-gradient(145deg, #6c757d, #495057);
        color: white;
        padding: 12px 16px;
        border-radius: 12px 12px 0 0;
        font-weight: 600;
      }

      .spl-query-body {
        padding: 16px;
      }

      .spl-query-text {
        background: #f8f9fa;
        color: #2d3748;
        border-radius: 8px;
        padding: 12px;
        font-family: "Courier New", monospace;
        font-size: 13px;
        overflow-x: auto;
        border-left: 4px solid #4299e1;
        border: 1px solid #e2e8f0;
        line-height: 1.5;
        white-space: pre-wrap;
        word-break: break-all;
      }

      .spl-query-text code {
        background: transparent;
        color: inherit;
        padding: 0;
        border: none;
        font-size: inherit;
        line-height: inherit;
        white-space: pre-wrap;
        word-break: break-all;
      }

      /* Loading indicator improvements */
      .typing-indicator {
        display: flex;
        align-items: center;
        padding: 1rem 1.5rem;
        background: linear-gradient(145deg, #f8f9fa, #e9ecef);
        border-radius: 18px 18px 18px 4px;
        margin: 1rem 0;
        animation: pulse 1.5s infinite;
      }

      /* Progress steps styling */
      .progress-step {
        padding: 0.25rem 0;
        font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
        font-size: 0.85em;
        line-height: 1.3;
        border-left: 2px solid #e9ecef;
        padding-left: 0.5rem;
        margin-left: 0.5rem;
        transition: all 0.3s ease;
      }

      .progress-step:first-child {
        border-left: none;
        margin-left: 0;
        padding-left: 0;
      }

      .progress-step .text-success {
        color: #28a745 !important;
      }

      .progress-step .fa-spinner {
        color: #007bff;
      }

      .progress-step .fa-check-circle {
        color: #28a745;
      }

      #progress-steps {
        margin-top: 0.5rem;
        background: rgba(0, 123, 255, 0.05);
        border-radius: 8px;
        padding: 0.75rem;
        border: 1px solid rgba(0, 123, 255, 0.1);
      }

      .typing-dots {
        display: flex;
        gap: 4px;
        margin-left: 8px;
      }

      .typing-dots span {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #6c757d;
        animation: typingDots 1.4s infinite ease-in-out;
      }

      .typing-dots span:nth-child(1) {
        animation-delay: -0.32s;
      }
      .typing-dots span:nth-child(2) {
        animation-delay: -0.16s;
      }

      @keyframes typingDots {
        0%,
        80%,
        100% {
          transform: scale(0.8);
          opacity: 0.5;
        }
        40% {
          transform: scale(1.2);
          opacity: 1;
        }
      }

      /* Ensure header actions (Back button) are above decorative overlay */
      .header-section .btn-light {
        position: relative;
        z-index: 5;
      }

      /* ===========================
           BEAUTIFIED AI RESPONSE STYLES
           =========================== */

      /* Agent headers */
      .agent-header {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white !important;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        margin: 1rem 0;
        box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2);
      }

      /* Section headers */
      .section-header {
        font-weight: 600;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        font-size: 0.9rem;
      }

      /* Investigation step sections */
      .step-section {
        margin: 1rem 0;
      }

      .step-section .alert {
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        background: linear-gradient(145deg, #fff, #f8f9fa);
      }

      /* Enhanced bullet points */
      .bullet-item {
        padding-left: 1rem;
        border-left: 2px solid transparent;
        transition: border-color 0.3s ease;
      }

      .bullet-item:hover {
        border-left-color: #007bff;
        background: rgba(0, 123, 255, 0.05);
      }

      /* Enhanced numbered items */
      .numbered-item {
        padding: 0.5rem;
        border-radius: 6px;
        background: rgba(0, 123, 255, 0.05);
        border-left: 3px solid #007bff;
      }

      /* Enhanced SPL blocks */
      .spl-block {
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin: 1rem 0;
      }

      .spl-header {
        font-weight: 600;
        font-size: 0.9rem;
        letter-spacing: 0.5px;
      }

      .spl-code {
        font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
        font-size: 0.85rem;
        line-height: 1.4;
        overflow-x: auto;
        border: none;
        background: #f8f9fa !important;
        color: #333 !important;
      }

      .spl-inline {
        margin: 0.5rem 0;
      }

      .spl-inline code {
        font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
        font-size: 0.85rem;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        display: block;
        overflow-x: auto;
      }

      /* Enhanced code blocks */
      .code-block {
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .code-block pre {
        margin: 0;
        font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
        font-size: 0.85rem;
        line-height: 1.4;
      }

      /* Badge enhancements */
      .badge {
        font-size: 0.75rem;
        padding: 0.35em 0.6em;
        border-radius: 4px;
        font-weight: 500;
      }

      /* Status-specific badge colors */
      .badge.bg-info {
        background-color: #17a2b8 !important;
      }

      .badge.bg-warning {
        background-color: #ffc107 !important;
        color: #212529 !important;
      }

      /* Link styling in formatted content */
      .formatted-content a {
        text-decoration: none;
        border-bottom: 1px dotted;
        transition: all 0.3s ease;
      }

      .formatted-content a:hover {
        border-bottom: 1px solid;
        background: rgba(0, 123, 255, 0.1);
        padding: 2px 4px;
        border-radius: 4px;
      }

      /* Responsive typography */
      @media (max-width: 768px) {
        .agent-header {
          font-size: 1rem;
          padding: 0.5rem 0.75rem;
        }

        .spl-code,
        .spl-inline code {
          font-size: 0.75rem;
        }

        .badge {
          font-size: 0.7rem;
          padding: 0.25em 0.5em;
        }
      }

      /* Force Smart Investigation button text color to white for contrast */
      .btn-enhanced.btn-warning {
        color: white !important;
      }

      /* IOC Query Modal Styles */
      .border-success {
        border-color: #198754 !important;
      }

      #iocQueryModal .modal-header {
        background: linear-gradient(135deg, #198754 0%, #20c997 100%);
      }

      #iocQueryModal .card-header {
        background-color: #f8f9fa !important;
        border-bottom: 2px solid #198754;
      }

      #iocQueryModal .badge.bg-success {
        background-color: #198754 !important;
      }

      /* Loading animation for IOC queries */
      @keyframes loadingPulse {
        0% {
          opacity: 0.6;
        }
        50% {
          opacity: 1;
        }
        100% {
          opacity: 0.6;
        }
      }

      #iocQueryModal .spinner-border {
        animation: loadingPulse 1.5s ease-in-out infinite;
      }

      /* Playbook Steps Styles */
      .playbook-steps {
        max-height: 400px;
        overflow-y: auto;
      }

      .playbook-step {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        margin-bottom: 8px;
        padding: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
      }

      .playbook-step:hover {
        border-color: #007bff;
        box-shadow: 0 2px 5px rgba(0, 123, 255, 0.1);
      }

      .playbook-step.active {
        border-color: #007bff;
        background: #f8f9ff;
      }

      .playbook-step.step-completed {
        border-color: #28a745;
        background: #f8fff8;
      }

      .playbook-step.step-running {
        border-color: #ffc107;
        background: #fffdf5;
        animation: pulse-yellow 2s infinite;
      }

      .playbook-step.step-pending {
        border-color: #e0e0e0;
        background: white;
      }

      .playbook-step.step-error {
        border-color: #dc3545;
        background: #fff8f8;
      }

      .playbook-step.step-canceled {
        border-color: #fd7e14;
        background: #fff5f0;
      }

      .playbook-step.step-canceling {
        border-color: #fd7e14;
        background: #fff5f0;
        animation: pulse-orange 2s infinite;
      }

      .step-details {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #e9ecef;
        display: none;
      }

      .step-reasoning,
      .step-conclusion {
        margin-bottom: 15px;
      }

      .step-reasoning h6,
      .step-conclusion h6 {
        color: #495057;
        font-weight: 600;
        margin-bottom: 8px;
      }

      .playbook-step-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .playbook-step-number {
        flex-shrink: 0;
        width: 40px;
        height: 40px;
        background: #6c757d;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 15px;
      }

      .step-completed .playbook-step-number {
        background: #28a745;
      }

      .step-running .playbook-step-number {
        background: #ffc107;
      }

      .step-pending .playbook-step-number {
        background: #6c757d;
      }

      .step-error .playbook-step-number {
        background: #dc3545;
      }

      .step-canceled .playbook-step-number {
        background: #fd7e14;
      }

      .step-canceling .playbook-step-number {
        background: #fd7e14;
      }

      .playbook-step-info {
        flex-grow: 1;
      }

      .playbook-step-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
      }

      .playbook-step-description {
        color: #666;
        font-size: 0.9em;
      }

      .playbook-step-action {
        flex-shrink: 0;
      }

      @keyframes pulse-yellow {
        0% {
          box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7);
        }
        70% {
          box-shadow: 0 0 0 5px rgba(255, 193, 7, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(255, 193, 7, 0);
        }
      }

      @keyframes pulse-orange {
        0% {
          box-shadow: 0 0 0 0 rgba(253, 126, 20, 0.7);
        }
        70% {
          box-shadow: 0 0 0 5px rgba(253, 126, 20, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(253, 126, 20, 0);
        }
      }

      .step-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 5px;
      }

      .step-number {
        background: #007bff;
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
      }

      .step-number.completed {
        background: #28a745;
      }

      .step-number.in-progress {
        background: #ffc107;
      }

      .step-status {
        font-size: 11px;
        padding: 2px 8px;
        border-radius: 12px;
        text-transform: uppercase;
        font-weight: bold;
      }

      .step-status.pending {
        background: #e9ecef;
        color: #6c757d;
      }

      .step-status.completed {
        background: #d4edda;
        color: #155724;
      }

      .step-status.in-progress {
        background: #fff3cd;
        color: #856404;
      }

      .step-details-panel {
        background: white;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
        padding: 20px;
      }

      .ai-analysis-section {
        background: #f8f9ff;
        border: 1px solid #e3f2fd;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
      }

      .analysis-item {
        margin-bottom: 10px;
      }

      .analysis-label {
        font-weight: bold;
        color: #1976d2;
        margin-bottom: 5px;
      }

      .conclusion-box {
        background: #e8f5e8;
        border: 1px solid #c3e6c3;
        border-radius: 6px;
        padding: 10px;
        margin-top: 10px;
      }

      /* Small alert style for cache indicators */
      .alert-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.825rem;
        border-radius: 0.25rem;
      }

      .alert-sm i {
        font-size: 0.75rem;
      }

      /* Enhanced AI Response Formatting */
      .ai-response-content {
        line-height: 1.7;
        font-size: 14px;
      }

      .ai-response-content h6 {
        color: #0d47a1;
        font-size: 1rem;
        font-weight: 600;
        margin-top: 1rem;
        margin-bottom: 0.5rem;
      }

      .ai-response-content .emphasis-section {
        border-left: 4px solid #ffc107;
        padding-left: 1rem;
        margin: 1rem 0;
      }

      .ai-response-content .numbered-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 0.75rem;
        margin: 0.5rem 0;
      }

      .ai-response-content .numbered-section .badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
      }

      .spl-code-block {
        background: #1a1a1a;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .spl-header {
        background: #343a40;
        color: #fff;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        font-weight: 600;
      }

      .spl-code {
        background: #1a1a1a;
        color: #f8f8f2;
        padding: 1rem;
        margin: 0;
        font-family: "Consolas", "Monaco", "Courier New", monospace;
        font-size: 13px;
        line-height: 1.4;
        border: none;
        overflow-x: auto;
      }

      .code-block {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 1rem;
        margin: 0.5rem 0;
        font-family: "Consolas", "Monaco", "Courier New", monospace;
        font-size: 13px;
        overflow-x: auto;
      }

      .welcome-message {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 12px;
        padding: 1.25rem;
        border: 1px solid #dee2e6;
      }

      .welcome-message ul li {
        padding: 0.25rem 0;
      }

      .text-purple {
        color: #6f42c1 !important;
      }

      /* Query Results Styles */
      .stat-card {
        background: linear-gradient(145deg, #f8f9fa, #e9ecef);
        border-radius: 10px;
        padding: 1rem;
        text-align: center;
        border: 1px solid #dee2e6;
        transition: transform 0.2s ease;
      }

      .stat-card:hover {
        transform: translateY(-2px);
      }

      .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #0d6efd;
      }

      .stat-label {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 0.25rem;
      }

      .query-display {
        background: linear-gradient(145deg, #f8f9fa, #e9ecef);
        border-radius: 8px;
        padding: 1rem;
        border: 1px solid #dee2e6;
      }

      .query-display code {
        background: #ffffff;
        border: 1px solid #ced4da;
        color: #495057;
        font-size: 0.875rem;
        max-height: 150px;
        overflow-y: auto;
      }

      .results-table-container {
        max-height: 500px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 8px;
      }

      .results-table-container .table {
        margin-bottom: 0;
      }

      .results-table-container .table td {
        max-width: 200px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 0.875rem;
      }

      .results-table-container .table th {
        position: sticky;
        top: 0;
        z-index: 10;
        background: #212529;
        border-bottom: 2px solid #495057;
      }

      .query-results-header {
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 1rem;
      }

      .query-results-header h6 {
        margin-bottom: 1rem;
      }

      /* Cache indicator styles */
      .alert-sm {
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
      }
    </style>
  </head>
  <body>
    <!-- Header Section -->
    <div class="header-section">
      <div class="container">
        <div class="row align-items-center">
          <div class="col-md-8">
            <h1 class="mb-0">
              <i class="fas fa-exclamation-triangle me-3"></i>
              Alert Details {{ alert.id }}
            </h1>
            <p class="mb-0 mt-2">{{ alert.title }}</p>
          </div>
          <div class="col-md-4 text-end">
            <a href="/" class="btn btn-light">
              <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>
          </div>
        </div>
      </div>
    </div>

    <div class="container mt-4">
      <!-- Alert Overview -->
      <div class="row mb-4">
        {% if result_table %}
        <div class="col-12 mb-4">
          <div class="card detail-card">
            <div
              class="card-header bg-gradient"
              style="background: linear-gradient(145deg, #4299e1, #38b2ac)"
            >
              <h5 class="mb-0 text-white">
                <i class="fas fa-table me-2"></i>Splunk Query Results
              </h5>
            </div>
            <div class="card-body">
              {% if result_table.error %}
              <div class="alert alert-danger">{{ result_table.error }}</div>
              {% else %}
              <div class="results-table-container">
                <table class="table table-bordered table-striped table-hover">
                  <thead class="table-dark">
                    <tr>
                      {% for col in result_table.columns %}
                      <th>{{ col }}</th>
                      {% endfor %}
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in result_table.rows %}
                    <tr>
                      {% for col in result_table.columns %}
                      <td>{{ row[col] }}</td>
                      {% endfor %}
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
        {% endif %}
        <div class="col-md-8">
          <div class="card detail-card">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-info-circle me-2"></i>Alert Information
              </h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <dl class="row">
                    <dt class="col-sm-4">Alert ID:</dt>
                    <dd class="col-sm-8">
                      <span class="badge bg-secondary">{{ alert.id }}</span>
                    </dd>

                    <dt class="col-sm-4">Severity:</dt>
                    <dd class="col-sm-8">
                      <span
                        class="badge severity-{{ alert.severity.lower() if alert.severity else 'medium' }}"
                      >
                        {% if alert.severity == 'Critical' %}
                        <i class="fas fa-fire me-1"></i>
                        {% elif alert.severity == 'High' %}
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        {% elif alert.severity == 'Medium' %}
                        <i class="fas fa-exclamation-circle me-1"></i>
                        {% else %}
                        <i class="fas fa-info-circle me-1"></i>
                        {% endif %} {{ alert.severity or 'Assessing...' }}
                      </span>
                      <small class="text-muted d-block">AI-Assessed</small>
                    </dd>

                    <dt class="col-sm-4">Status:</dt>
                    <dd class="col-sm-8">
                      <span
                        class="badge {% if alert.status == 'New' %}bg-primary {% elif alert.status == 'In Progress' %}bg-warning {% elif alert.status == 'Closed' %}bg-success {% else %}bg-secondary{% endif %}"
                      >
                        {{ alert.status or 'New' }}
                      </span>
                    </dd>

                    <dt class="col-sm-4">Timestamp:</dt>
                    <dd class="col-sm-8">{{ alert.timestamp }}</dd>
                  </dl>
                </div>
                <div class="col-md-6">
                  <dl class="row">
                    <dt class="col-sm-4">Source IP:</dt>
                    <dd class="col-sm-8">
                      {% if alert.src_ip %}
                      <code>{{ alert.src_ip }}</code>
                      {% else %}
                      <span class="text-muted">Not available</span>
                      {% endif %}
                    </dd>

                    <dt class="col-sm-4">Destination IP:</dt>
                    <dd class="col-sm-8">
                      {% if alert.dest_ip %}
                      <code>{{ alert.dest_ip }}</code>
                      {% else %}
                      <span class="text-muted">Not available</span>
                      {% endif %}
                    </dd>

                    <dt class="col-sm-4">Playbook:</dt>
                    <dd class="col-sm-8">
                      <span class="badge bg-info"
                        >{{ alert.playbook or 'Selecting...' }}</span
                      >
                      <small class="text-muted d-block">AI-Selected</small>
                    </dd>
                  </dl>
                </div>
              </div>

              <hr />

              <h6><i class="fas fa-file-alt me-2"></i>Detailed Description:</h6>
              <p class="mb-0">{{ alert.description }}</p>

              <hr />
              <h6><i class="fas fa-list me-2"></i>All Alert Fields</h6>
              <div class="table-responsive">
                <table class="table table-bordered table-striped">
                  <thead>
                    <tr>
                      <th>Field</th>
                      <th>Value</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for key, value in alert.items() %}
                    <tr>
                      <td><strong>{{ key }}</strong></td>
                      <td>
                        {% if value is mapping or value is sequence and not
                        value is string %}
                        <pre>{{ value | tojson(indent=2) }}</pre>
                        {% else %} {{ value }} {% endif %}
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card detail-card">
            <div
              class="card-header bg-gradient"
              style="background: linear-gradient(145deg, #28a745, #20c997)"
            >
              <h5 class="mb-0 text-white">
                <i class="fas fa-bolt me-2"></i>Smart Actions
                <small class="ms-2 opacity-75">AI-Powered</small>
              </h5>
            </div>
            <div class="card-body">
              <div class="d-grid gap-3">
                <button
                  class="btn btn-enhanced btn-primary"
                  onclick="explainStatus('{{ alert.id }}')"
                >
                  <i class="fas fa-info-circle me-2"></i>Explain Status
                  <small class="d-block opacity-75"
                    >AI analysis of current state</small
                  >
                </button>
                <button
                  class="btn btn-enhanced btn-success"
                  onclick="openQAAssistant('{{ alert.id }}')"
                >
                  <i class="fas fa-comments me-2"></i>Chat with AI
                  <small class="d-block opacity-75"
                    >Ask questions about this alert</small
                  >
                </button>
                <button
                  class="btn btn-enhanced btn-warning"
                  onclick="InvestigationOnline('{{ alert.id }}')"
                >
                  <i class="fas fa-search me-2"></i>Smart Investigation
                  <small class="d-block opacity-75"
                    >AI-query online (virustotal, abuseip, ...)</small
                  >
                </button>

                <hr class="my-2" />

                <div class="row g-2">
                  <div class="col-4">
                    <button
                      class="btn btn-outline-primary btn-sm w-100"
                      onclick="generateIOCQueries('{{ alert.id }}')"
                    >
                      <i class="fas fa-code me-1"></i>Get SPL
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Playbook Status Card -->
          <div
            class="card detail-card mt-3"
            id="playbookStatusCard"
            style="display: none"
          >
            <div
              class="card-header bg-gradient"
              style="background: linear-gradient(145deg, #6f42c1, #8b5cf6)"
            >
              <h5 class="mb-0 text-white">
                <i class="fas fa-book-open me-2"></i>Playbook Status
                <small class="ms-2 opacity-75">Investigation Progress</small>
              </h5>
            </div>
            <div class="card-body">
              <div id="playbookStatusContent">
                <div class="text-center">
                  <i
                    class="fas fa-play-circle text-muted"
                    style="font-size: 2rem"
                  ></i>
                  <p class="text-muted mt-2">No active investigation</p>
                  <button
                    class="btn btn-sm btn-primary"
                    onclick="startInvestigation('{{ alert.id }}')"
                  >
                    <i class="fas fa-search me-1"></i>Start Investigation
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Q&A Section - Full Width -->
      <div class="row mb-4">
        <div class="col-12">
          <div
            class="card detail-card mx-auto"
            style="min-height: 800px; width: 110%"
          >
            <div
              class="card-header bg-gradient"
              style="background: linear-gradient(145deg, #007bff, #0056b3)"
            >
              <h5 class="mb-0 text-white fw-bold" style="font-size: 1.3rem">
                <i class="fas fa-robot me-2"></i>AI Security Analyst
              </h5>
            </div>
            <div
              class="card-body qa-container"
              style="
                padding: 0;
                height: 800px;
                display: flex;
                flex-direction: column;
              "
            >
              <div class="row g-0" style="height: 100%; flex: 1">
                <!-- Chat Section (Left - 70%) -->
                <div
                  class="col-md-8"
                  style="
                    border-right: 1px solid #e9ecef;
                    padding: 24px;
                    display: flex;
                    flex-direction: column;
                    height: 100%;
                    overflow: hidden;
                  "
                >
                  <!-- Conversation History -->
                  <div
                    id="conversationHistory"
                    class="mb-3"
                    style="overflow-y: auto; flex: 1; min-height: 0"
                  >
                    <div class="conversation-bubble ai">
                      <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-robot text-primary me-2"></i>
                        <strong style="font-size: 0.95rem; color: #1a1a1a"
                          >AI Security Analyst</strong
                        >
                        <small
                          class="ms-2"
                          style="color: #666; font-size: 0.8rem"
                          >Ready to help</small
                        >
                      </div>
                      <p
                        class="mb-0"
                        style="
                          font-size: 0.95rem;
                          color: #333;
                          line-height: 1.6;
                        "
                      >
                        Hello! I'm your AI Security Analyst. I can help you
                        understand this alert, assess its threat level, suggest
                        investigation steps, and answer any security-related
                        questions. What would you like to know?
                      </p>
                    </div>
                  </div>

                  <!-- Question Input Section -->
                  <div>
                    <label
                      for="questionInput"
                      class="form-label fw-bold"
                      style="font-size: 0.95rem; color: #1a1a1a"
                    >
                      <i class="fas fa-comment-dots me-2 text-primary"></i>Your
                      Question:
                    </label>
                    <div class="input-group">
                      <textarea
                        class="form-control"
                        id="questionInput"
                        rows="2"
                        placeholder="Example: How dangerous is this activity? What should I investigate first?"
                        onkeypress="handleEnterKey(event)"
                        style="
                          border-radius: 12px 0 0 12px;
                          border: 2px solid #e9ecef;
                        "
                      ></textarea>
                      <button
                        class="btn btn-primary px-4"
                        onclick="askQuestion()"
                        id="askButton"
                        style="
                          border-radius: 0 12px 12px 0;
                          border: 2px solid #e9ecef;
                        "
                      >
                        <i class="fas fa-paper-plane me-1"></i>Ask
                      </button>
                    </div>
                  </div>
                </div>

                <!-- AI Quick Questions Section (Right - 30%) -->
                <div
                  class="col-md-4"
                  style="
                    padding: 24px;
                    background: #fafafa;
                    display: flex;
                    flex-direction: column;
                    height: 100%;
                    overflow: hidden;
                  "
                >
                  <label
                    class="form-label fw-bold mb-3"
                    style="font-size: 0.95rem; color: #1a1a1a"
                  >
                    <i class="fas fa-lightbulb me-2 text-warning"></i>Quick
                    Questions:
                  </label>
                  <div
                    class="quick-questions-container"
                    id="quickQuestionsContainer"
                    style="flex: 1; overflow-y: auto; min-height: 0"
                  >
                    <div class="text-center" style="padding: 20px 0">
                      <div
                        class="spinner-border spinner-border-sm"
                        role="status"
                      >
                        <span class="visually-hidden">Loading...</span>
                      </div>
                      <p class="mt-3 mb-0 small text-muted">
                        Generating questions...
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modals (reuse from dashboard) -->
    <!-- Modal for Status Explanation -->
    <div class="modal fade" id="statusModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-info-circle me-2"></i>Alert Status Explanation
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div id="statusExplanation" class="text-center">
              <div class="spinner-border" role="status">
                <span class="visually-hidden">Analyzing...</span>
              </div>
              <p class="mt-2">AI is analyzing the alert...</p>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal for Investigation -->
    <div class="modal fade" id="investigationModal" tabindex="-1">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">
              <i class="fas fa-book me-2"></i>Start Investigation Playbook
              <small class="ms-2 opacity-75" id="playbookTitle"
                >Data Exfiltration Playbook</small
              >
            </h5>
            <div class="d-flex gap-2">
              <button
                type="button"
                class="btn btn-warning btn-sm"
                id="runAllStepsBtn"
                onclick="runAllSteps()"
                title="Execute all remaining steps automatically"
              >
                <i class="fas fa-play-circle me-1"></i>Run All Steps
              </button>
              <button
                type="button"
                class="btn-close btn-close-white"
                data-bs-dismiss="modal"
              ></button>
            </div>
          </div>
          <div class="modal-body p-0">
            <!-- Investigation Summary Header -->
            <div class="bg-light border-bottom p-3">
              <div class="row">
                <div class="col-md-4">
                  <small class="text-muted">Investigation ID:</small>
                  <div class="fw-bold small" id="investigationId">
                    Loading...
                  </div>
                </div>
                <div class="col-md-4">
                  <small class="text-muted">Playbook:</small>
                  <div class="fw-bold small" id="playbookName">Loading...</div>
                </div>
                <div class="col-md-4">
                  <small class="text-muted">Started:</small>
                  <div class="fw-bold small" id="startedTime">Loading...</div>
                </div>
              </div>
              <div class="mt-2">
                <small class="text-muted">Investigation Plan:</small>
                <div class="fw-bold" id="investigationPlan">
                  Loading investigation plan...
                </div>
              </div>
            </div>

            <div class="row g-0">
              <!-- Playbook Steps List -->
              <div class="col-md-5 bg-light p-3">
                <div
                  class="d-flex justify-content-between align-items-center mb-3"
                >
                  <h6 class="mb-0">
                    <i class="fas fa-list-ol me-2 text-primary"></i>Playbook
                    Steps
                  </h6>
                  <span class="badge bg-secondary" id="stepProgress"
                    >0 / 0</span
                  >
                </div>

                <div id="playbookSteps" class="playbook-steps">
                  <div class="text-center py-4">
                    <div class="spinner-border text-primary mb-2" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="text-muted small">Loading playbook steps...</p>
                  </div>
                </div>
              </div>

              <!-- Step Details -->
              <div class="col-md-7 p-3">
                <div id="stepDetails">
                  <div class="text-center py-5">
                    <i
                      class="fas fa-play-circle text-muted"
                      style="font-size: 3rem"
                    ></i>
                    <h6 class="text-muted mt-3">Select a Step to Begin</h6>
                    <p class="text-muted">
                      Click on any step from the left panel to see details and
                      execute the investigation.
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer bg-light">
            <button
              type="button"
              class="btn btn-outline-info"
              onclick="showAuditTrail()"
              title="View investigation history and audit trail"
            >
              <i class="fas fa-history me-2"></i>Audit Trail
            </button>
            <button
              type="button"
              class="btn btn-outline-danger"
              onclick="clearCurrentAlertData()"
              title="Clear investigation data for this alert only"
            >
              <i class="fas fa-trash me-2"></i>Clear This Alert Data
            </button>
            <button
              type="button"
              class="btn btn-outline-secondary"
              data-bs-dismiss="modal"
            >
              <i class="fas fa-times me-2"></i>Close
            </button>
            <button
              type="button"
              class="btn btn-success"
              id="executeStepBtn"
              style="display: none"
              onclick="executeCurrentStep()"
            >
              <i class="fas fa-play me-2"></i>Execute Step
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Audit Trail Modal -->
    <div class="modal fade" id="auditTrailModal" tabindex="-1">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-history me-2"></i>Investigation Audit Trail
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div id="auditTrailContent">
              <div class="text-center py-4">
                <div class="spinner-border text-primary mb-2" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="text-muted">Loading audit trail...</p>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Step Detail Modal -->
    <div class="modal fade" id="stepDetailModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="stepDetailTitle">
              <i class="fas fa-info-circle me-2"></i>Step Details
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div class="step-detail-content">
              <!-- Step Description -->
              <div class="mb-3">
                <h6 class="text-muted mb-2">
                  <i class="fas fa-clipboard-list me-2"></i>Step Description
                </h6>
                <div class="bg-light p-3 rounded" id="stepDetailDescription">
                  <!-- Description content -->
                </div>
              </div>

              <!-- Detailed Actions -->
              <div class="mb-3">
                <h6 class="text-muted mb-2">
                  <i class="fas fa-tasks me-2"></i>Detailed Actions
                </h6>
                <div class="bg-light p-3 rounded" id="stepDetailActions">
                  <!-- Actions content -->
                </div>
              </div>

              <!-- AI Reasoning Section -->
              <div id="stepDetailReasoning">
                <!-- AI reasoning content will be added dynamically -->
              </div>

              <!-- Conclusion Section -->
              <div id="stepDetailConclusion">
                <!-- Conclusion content will be added dynamically -->
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const currentAlertId = "{{ alert.id }}";
      let currentDisplayedStep = null; // Track which step is currently displayed in right panel

      function explainStatus(alertId) {
        document.getElementById("statusExplanation").innerHTML = `
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Analyzing...</span>
                </div>
                <p class="mt-2">AI is analyzing the alert...</p>
            `;

        const modal = new bootstrap.Modal(
          document.getElementById("statusModal")
        );
        modal.show();

        fetch("/api/explain-status", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ alert_id: alertId }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              // Restoring previous behavior: insert AI-provided HTML directly
              document.getElementById("statusExplanation").innerHTML =
                data.explanation;
            } else {
              document.getElementById(
                "statusExplanation"
              ).innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
            }
          })
          .catch((error) => {
            document.getElementById(
              "statusExplanation"
            ).innerHTML = `<div class="alert alert-danger">Connection error: ${error.message}</div>`;
          });
      }

      function openQAAssistant(alertId) {
        // Store alert ID for later use
        window.currentChatAlertId = alertId;

        // Load existing chat history
        loadChatHistory(alertId);

        // Focus on the question input
        document.getElementById("questionInput").focus();
      }

      function loadChatHistory(alertId) {
        // Clear existing conversation
        const conversationHistory = document.getElementById(
          "conversationHistory"
        );
        conversationHistory.innerHTML = "";

        // Show loading indicator
        const loadingBubble = document.createElement("div");
        loadingBubble.className = "text-center p-3";
        loadingBubble.innerHTML = `
                <div class="spinner-border spinner-border-sm text-muted mb-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="text-muted small mb-0">Loading chat history...</p>
            `;
        conversationHistory.appendChild(loadingBubble);

        // Fetch chat history
        fetch(`/api/chat-history/${alertId}`)
          .then((response) => response.json())
          .then((data) => {
            conversationHistory.innerHTML = ""; // Clear loading

            if (data.status === "success" && data.messages.length > 0) {
              // Display existing messages
              data.messages.forEach((message) => {
                displayChatMessage(
                  message.message,
                  message.type === "user",
                  message.timestamp
                );
              });

              // Scroll to bottom
              scrollToBottom();
            } else {
              // Show welcome message for new conversation
              displayWelcomeMessage();
            }
          })
          .catch((error) => {
            console.error("Error loading chat history:", error);
            conversationHistory.innerHTML = "";
            displayWelcomeMessage();
          });
      }

      function displayWelcomeMessage() {
        const conversationHistory = document.getElementById(
          "conversationHistory"
        );
        const welcomeBubble = document.createElement("div");
        welcomeBubble.className = "conversation-bubble ai";
        welcomeBubble.innerHTML = `
                <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-robot text-primary me-2"></i>
                    <strong>AI Security Analyst</strong>
                    <small class="text-muted ms-2">${new Date().toLocaleTimeString()}</small>
                </div>
                <div class="mb-0">
                    <p class="mb-2">ðŸ‘‹ Hello! I'm your AI Security Analyst. I can help you analyze this alert and answer any questions you have.</p>
                    <p class="mb-0">Try asking about threat analysis, investigation steps, or potential impacts. You can also click on the suggested questions below!</p>
                </div>
            `;
        conversationHistory.appendChild(welcomeBubble);
      }

      function displayWelcomeMessage() {
        const conversationHistory = document.getElementById(
          "conversationHistory"
        );

        // Only show welcome message if there's no existing chat history
        if (conversationHistory.children.length === 0) {
          const welcomeBubble = document.createElement("div");
          welcomeBubble.className = "conversation-bubble ai mb-3";
          welcomeBubble.innerHTML = `
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-robot text-primary me-2"></i>
                        <strong>AI Security Analyst</strong>
                        <small class="text-muted ms-2">${new Date().toLocaleTimeString()}</small>
                    </div>
                    <div class="welcome-message">
                        <p class="mb-2">
                            <i class="fas fa-wave-square text-primary me-2"></i>
                            <strong>Welcome to AI Security Analysis!</strong>
                        </p>
                        <p class="mb-2">
                            I'm here to help you analyze this security alert. Here's what I can do:
                        </p>
                        <ul class="list-unstyled mb-2">
                            <li class="mb-1">
                                <i class="fas fa-search text-info me-2"></i>
                                <strong>Deep Analysis:</strong> Provide detailed threat assessment and impact analysis
                            </li>
                            <li class="mb-1">
                                <i class="fas fa-code text-warning me-2"></i>
                                <strong>SPL Queries:</strong> Generate Splunk searches for investigation
                            </li>
                            <li class="mb-1">
                                <i class="fas fa-clipboard-list text-success me-2"></i>
                                <strong>Response Guidance:</strong> Recommend next steps and containment actions
                            </li>
                            <li class="mb-1">
                                <i class="fas fa-brain text-purple me-2"></i>
                                <strong>Context Analysis:</strong> Explain technical details in clear language
                            </li>
                        </ul>
                        <div class="alert alert-light border-start border-primary border-3 ps-3 mt-3">
                            <small class="text-muted">
                                <i class="fas fa-lightbulb text-warning me-2"></i>
                                <strong>Tip:</strong> Try the quick questions below or ask me anything about this alert!
                            </small>
                        </div>
                    </div>
                `;
          conversationHistory.appendChild(welcomeBubble);
          scrollToBottom();
        }
      }

      function displayChatMessage(content, isUser, timestamp = null) {
        const conversationHistory = document.getElementById(
          "conversationHistory"
        );
        const bubble = document.createElement("div");
        bubble.className = `conversation-bubble ${isUser ? "user" : "ai"}`;

        const displayTime = timestamp
          ? new Date(timestamp).toLocaleTimeString()
          : new Date().toLocaleTimeString();

        if (isUser) {
          bubble.innerHTML = `
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-user me-2" style="color: #495057 !important;"></i>
                        <strong style="color: #1a1a1a !important; font-size: 0.95rem;">You</strong>
                        <small class="ms-2" style="color: #666 !important;">${displayTime}</small>
                    </div>
                    <p class="mb-0" style="color: #1a1a1a !important;">${content}</p>
                `;
        } else {
          // Enhanced AI response formatting
          const formattedContent = formatAIResponse(content);
          bubble.innerHTML = `
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-robot text-primary me-2"></i>
                        <strong>AI Security Analyst</strong>
                        <small class="text-muted ms-2">${displayTime}</small>
                    </div>
                    <div class="ai-response-content">${formattedContent}</div>
                `;
        }

        conversationHistory.appendChild(bubble);
      }

      // ===========================
      // UNIVERSAL AI RESPONSE BEAUTIFIER
      // ===========================
      function beautifyAIResponse(content, type = "general") {
        if (!content) return "";

        // Work with string representation
        let raw = content.toString();

        // Normalize line breaks early
        raw = raw.replace(/\r\n/g, "\n").replace(/\r/g, "\n");

        // Detect if content already contains HTML tags. If so, we will
        // assume AI returned formatted HTML and do light sanitization
        // rather than escaping everything (prevents double-escaping).
        const looksLikeHtml = /<[^>]+>/.test(raw);

        if (looksLikeHtml) {
          // Basic sanitization: remove script tags and on* attributes
          // (This is a lightweight sanitization suitable for internal use.)
          raw = raw.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi, "");
          raw = raw.replace(/ on\w+=("[^"]*"|'[^']*'|[^\s>]+)/gi, "");
          // Prevent javascript: urls
          raw = raw.replace(/href=["']javascript:[^"']*["']/gi, "");

          // We'll treat sanitized HTML as the starting formatted value
          var formatted = raw;
        } else {
          // Plain text: escape HTML to prevent XSS, then format
          let escaped = raw
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#x27;");

          var formatted = escaped;
        }

        // === AGENT-SPECIFIC FORMATTING ===
        // Format agent headers (e.g., "ðŸ“‹ PLAYBOOK RUNNER AGENT:")
        formatted = formatted.replace(
          /(ðŸ“‹|ðŸ”|âš¡|ðŸŽ¯|ðŸ›¡ï¸|ðŸ“Š)\s*([A-Z\s]+AGENT:?)/g,
          '<h5 class="agent-header text-primary mb-3"><i class="fas fa-robot me-2"></i>$1 $2</h5>'
        );

        // === SECTION HEADERS ===
        // Main sections (ALL CAPS with colon)
        formatted = formatted.replace(
          /^([A-Z][A-Z\s]{2,}):$/gm,
          '<h6 class="section-header text-success mt-4 mb-2 border-bottom border-success pb-1"><i class="fas fa-chevron-right me-2"></i>$1:</h6>'
        );

        // Investigation step headers (How and Why AI executed this step:, Quick Conclusion:, etc.)
        formatted = formatted.replace(
          /^(How and Why AI executed this step|Quick Conclusion|Investigation Summary|Analysis Result|Threat Assessment|Risk Level|Recommendations|Next Steps?|Impact Assessment):\s*/gim,
          '<div class="step-section mt-3 mb-2">' +
            '<h6 class="text-warning mb-2"><i class="fas fa-lightbulb me-2"></i>$1:</h6>' +
            '<div class="alert alert-light border-start border-warning border-3 ps-3">'
        );

        // Close step sections (look for next section or end of content)
        formatted = formatted.replace(
          /(<div class="alert alert-light border-start border-warning border-3 ps-3">)([\s\S]*?)(?=<div class="step-section|<h6 class="section-header|$)/g,
          "$1$2</div></div>"
        );

        // === TEXT FORMATTING ===
        // Bold text (**text**)
        formatted = formatted.replace(
          /\*\*(.*?)\*\*/g,
          '<strong class="text-primary">$1</strong>'
        );

        // Italic text (*text*)
        formatted = formatted.replace(
          /\*([^*\n]+)\*/g,
          '<em class="text-muted">$1</em>'
        );

        // === LISTS AND BULLETS ===
        // Bullet points with various symbols
        formatted = formatted.replace(
          /^(\s*)[â€¢Â·â–ªâ–«-]\s+(.+)$/gm,
          '$1<div class="bullet-item mb-1"><i class="fas fa-angle-right text-primary me-2"></i>$2</div>'
        );

        // Numbered lists
        formatted = formatted.replace(
          /^(\s*)(\d+)\.\s+(.+)$/gm,
          '$1<div class="numbered-item mb-2"><span class="badge bg-primary me-2">$2</span><strong>$3</strong></div>'
        );

        // === CODE AND TECHNICAL CONTENT ===
        // === SPL: handle triple-backtick spl blocks by inserting a collapsible summary + full code
        // Replace code block with a placeholder token to avoid interfering with other replacements
        const splPlaceholders = [];
        formatted = formatted.replace(
          /```spl\n([\s\S]*?)\n```/g,
          function (_, splCode) {
            const id = "spl_" + splPlaceholders.length;
            splPlaceholders.push(splCode.trim());
            return `[[SPL_PLACEHOLDER:${id}]]`;
          }
        );

        // General code blocks
        formatted = formatted.replace(
          /```\n([\s\S]*?)\n```/g,
          '<div class="code-block mb-3">' +
            '<pre class="bg-dark text-light p-3 rounded"><code>$1</code></pre>' +
            "</div>"
        );

        // Inline code
        formatted = formatted.replace(
          /`([^`\n]+)`/g,
          '<code class="bg-light text-dark px-2 py-1 rounded">$1</code>'
        );

        // SPL detection: rely on explicit markers emitted by the SPL Generator agent.
        // The SPL Generator should wrap each SPL block with:
        // <<<SPL_QUERY>>>
        // <SPL text here>
        // <<<END_SPL_QUERY>>>
        // Convert any marker-wrapped blocks into the same `[[SPL_PLACEHOLDER:spl_<n>]]` tokens
        // used by the triple-backtick handling above so rendering is uniform.
        formatted = formatted.replace(
          /<<<SPL_QUERY>>>[\s\S]*?<<<END_SPL_QUERY>>>/gim,
          function (m) {
            const inner = m
              .replace(/<<<SPL_QUERY>>>/i, "")
              .replace(/<<<END_SPL_QUERY>>>/i, "")
              .trim();
            const id = "spl_" + splPlaceholders.length;
            splPlaceholders.push(inner);
            return `[[SPL_PLACEHOLDER:${id}]]`;
          }
        );

        // No heuristic inline SPL detection here â€” the UI will only render SPL blocks
        // that the agent explicitly marked. This avoids mistaken splitting or styling.

        // === TECHNICAL IDENTIFIERS ===
        // IP addresses
        formatted = formatted.replace(
          /(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})/g,
          '<span class="badge bg-info text-white">$1</span>'
        );

        // Alert IDs
        formatted = formatted.replace(
          /(ALERT-\w+)/g,
          '<span class="badge bg-warning text-dark">$1</span>'
        );

        // URLs and domains
        formatted = formatted.replace(
          /(https?:\/\/[^\s<>"]+)/g,
          '<a href="$1" target="_blank" class="text-primary">$1 <i class="fas fa-external-link-alt ms-1"></i></a>'
        );

        // File paths
        formatted = formatted.replace(
          /([A-Za-z]:\\[^\s<>"]+|\/[^\s<>"]*\/[^\s<>"]*)/g,
          '<code class="bg-secondary text-white px-2 py-1 rounded">$1</code>'
        );

        // === TIMESTAMPS ===
        formatted = formatted.replace(
          /(\d{4}-\d{2}-\d{2}[\sT]\d{2}:\d{2}:\d{2})/g,
          '<span class="text-muted font-monospace">$1</span>'
        );

        // === STATUS AND SEVERITY ===
        // Status indicators
        formatted = formatted.replace(
          /\b(SUCCESS|COMPLETED|PASSED)\b/gi,
          '<span class="badge bg-success">$1</span>'
        );
        formatted = formatted.replace(
          /\b(ERROR|FAILED|CRITICAL)\b/gi,
          '<span class="badge bg-danger">$1</span>'
        );
        formatted = formatted.replace(
          /\b(WARNING|MEDIUM|CAUTION)\b/gi,
          '<span class="badge bg-warning text-dark">$1</span>'
        );
        formatted = formatted.replace(
          /\b(INFO|LOW|MINOR)\b/gi,
          '<span class="badge bg-info">$1</span>'
        );

        // === PARAGRAPH FORMATTING ===
        // Convert double line breaks to paragraphs
        formatted = formatted.replace(/\n\n/g, '</p><p class="mb-3">');

        // Convert single line breaks to breaks but preserve list structure
        formatted = formatted.replace(
          /\n(?!<\/?(div|h[1-6]|p|ul|ol|li))/g,
          "<br>"
        );

        // Wrap in paragraph if not already wrapped
        if (!formatted.startsWith("<")) {
          formatted = '<p class="mb-3">' + formatted + "</p>";
        }

        // === CLEANUP ===
        // Remove empty paragraphs
        formatted = formatted.replace(/<p class="mb-3">\s*<\/p>/g, "");

        // Fix unclosed step sections
        let openDivs = (formatted.match(/<div class="alert alert-light/g) || [])
          .length;
        let closedDivs = (formatted.match(/<\/div><\/div>/g) || []).length;
        while (openDivs > closedDivs) {
          formatted += "</div></div>";
          closedDivs++;
        }

        // Now expand SPL placeholders into a compact bullet + collapsible full query
        if (splPlaceholders.length > 0) {
          splPlaceholders.forEach((code, idx) => {
            const id = "spl_" + idx;
            // short preview: first line or truncated to 80 chars
            const preview = (code.split("\n")[0] || code).trim();
            const safePreview =
              preview.length > 80 ? preview.substring(0, 77) + "..." : preview;
            const block = `
                        <div class="spl-summary mb-2">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-search text-secondary me-2"></i>
                                <div>
                                    <div class="small text-muted">SPL Query Preview:</div>
                                    <div class="fw-monospace">${safePreview}</div>
                                    <a class="small" href="#" onclick="event.preventDefault(); toggleSpl('${id}');">Show full query</a>
                                    <div id="${id}" class="spl-full" style="display:none; margin-top:8px;">
                                        <pre class="spl-code bg-light p-3 rounded"><code>${code}</code></pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
            formatted = formatted.replace(`[[SPL_PLACEHOLDER:${id}]]`, block);
          });
        }

        // Collapse consecutive inline SPL tokens into a single bullet list
        // Find runs of [[SPL_INLINE:...]] tokens and group them
        formatted = formatted.replace(
          /(?:\[\[SPL_INLINE:([\s\S]*?)\]\]\s*)+/gim,
          function (match) {
            const lines = [];
            match.replace(/\[\[SPL_INLINE:([\s\S]*?)\]\]/gim, function (_, l) {
              lines.push(l.trim());
            });
            if (lines.length === 0) return "";

            // Merge continuation lines into single commands. First clean HTML tags that may have been
            // introduced by earlier formatting (badges, spans) to reconstruct clean SPL.
            const merged = [];
            let current = "";
            const topLevelCmd = /\b(index=|search\s)/i;

            lines.forEach((line) => {
              // remove any HTML tags and collapse whitespace
              let cleaned = line
                .replace(/<[^>]*>/g, " ")
                .replace(/&nbsp;|&amp;/g, " ")
                .replace(/\s+/g, " ")
                .trim();
              // Specific fix: remove leftover artifact form like 'src_ip=info text-white">192.168.100.50' => 'src_ip=192.168.100.50'
              cleaned = cleaned.replace(
                /(src_ip|dest_ip|id.orig_h)\s*=\s*(?:[^\s=]*\s*)?\"?([0-9]{1,3}(?:\.[0-9]{1,3}){3})\"?/gi,
                "$1=$2"
              );

              if (!current) {
                current = cleaned;
                return;
              }

              // If cleaned line looks like a new top-level command (starts with index= or search), start new
              if (topLevelCmd.test(cleaned)) {
                merged.push(current);
                current = cleaned;
              } else {
                // Otherwise treat as continuation and append
                current = current + " " + cleaned;
              }
            });
            if (current) merged.push(current);

            // Keep unique merged commands, limit to 6
            const unique = Array.from(new Set(merged)).slice(0, 6);
            const bullets = unique
              .map((l, idx) => {
                const safe = l
                  .replace(/&/g, "&amp;")
                  .replace(/</g, "&lt;")
                  .replace(/>/g, "&gt;");
                // If command has multiple clauses (pipes) or is long, show a short preview and collapsible full query
                // Only show 'Show full query' when the cleaned command is long enough
                // if (safe.length > 100) {
                //     const preview = safe.slice(0, 97) + '...';
                //     const id = 'spl_full_' + Math.random().toString(36).slice(2, 9);
                //     return `<li class="mb-2"><div><code class="bg-dark text-white px-2 py-1 rounded me-1">${preview}</code> <a href="#" onclick="toggleSpl('${id}');return false;">Show full query</a></div><div id="${id}" class="mt-2" style="display:none"><pre class="bg-light p-2 rounded">${safe}</pre></div></li>`;
                // }
                return `<li class="mb-2"><code class="bg-dark text-white px-2 py-1 rounded me-1">${safe}</code></li>`;
              })
              .join("");
            return `<div class="spl-inline-group mb-2"><div class="small text-muted">SPL Quick Commands:</div><ul class="mb-0">${bullets}</ul></div>`;
          }
        );

        // Final safety: remove any HTML tags that accidentally ended up inside SPL_INLINE tokens
        formatted = formatted.replace(
          /\[\[SPL_INLINE:([\s\S]*?)\]\]/gim,
          function (_, content) {
            let cleaned = content
              .replace(/<[^>]*>/g, " ")
              .replace(/\s+/g, " ")
              .trim();
            cleaned = cleaned.replace(
              /(src_ip|dest_ip|id.orig_h)\s*=\s*(?:[^\s=]*\s*)?\"?([0-9]{1,3}(?:\.[0-9]{1,3}){3})\"?/gi,
              "$1=$2"
            );
            return `[[SPL_INLINE:${cleaned}]]`;
          }
        );

        return formatted;
      }

      // Legacy function - now uses beautifyAIResponse
      function formatAIResponse(content) {
        return beautifyAIResponse(content, "chat");
      }

      // Enhanced function for investigation steps
      function formatInvestigationStep(content) {
        return beautifyAIResponse(content, "investigation");
      }

      // Enhanced function for alert status explanations
      function formatAlertStatus(content) {
        return beautifyAIResponse(content, "status");
      }

      function scrollToBottom() {
        const conversationHistory = document.getElementById(
          "conversationHistory"
        );
        conversationHistory.scrollTop = conversationHistory.scrollHeight;
      }

      // Toggle full SPL query visibility
      function toggleSpl(id) {
        const el = document.getElementById(id);
        if (!el) return;
        el.style.display =
          el.style.display === "none" || el.style.display === ""
            ? "block"
            : "none";
      }

      function setQuestion(question) {
        document.getElementById("questionInput").value = question;
        document.getElementById("questionInput").focus();
      }

      function handleEnterKey(event) {
        if (event.ctrlKey && event.key === "Enter") {
          askQuestion();
        }
      }

      function addConversationBubble(content, isUser = true) {
        // Use the new displayChatMessage function for consistency
        displayChatMessage(content, isUser);
        scrollToBottom();
      }

      function showTypingIndicator(question = "") {
        const conversationHistory = document.getElementById(
          "conversationHistory"
        );
        const typingBubble = document.createElement("div");
        typingBubble.className = "conversation-bubble ai";
        typingBubble.id = "typing-indicator";
        typingBubble.innerHTML = `
                <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-robot text-primary me-2"></i>
                    <strong>AI Security Analyst</strong>
                    <small class="text-muted ms-2">Analyzing...</small>
                </div>
                <div id="progress-steps" class="text-muted small">
                    <div class="progress-step" id="step-supervisor">
                        <i class="fas fa-spinner fa-spin me-2"></i>
                        <span>SUPERVISOR AGENT: Analyzing question${
                          question
                            ? ': "' +
                              (question.length > 50
                                ? question.substring(0, 50) + '..."'
                                : question + '"')
                            : "..."
                        }</span>
                    </div>
                </div>
            `;

        conversationHistory.appendChild(typingBubble);
        conversationHistory.scrollTop = conversationHistory.scrollHeight;

        // Start the progress simulation
        simulateProcessingSteps(question);
      }

      function simulateProcessingSteps(question = "") {
        const shortQuestion =
          question.length > 40 ? question.substring(0, 40) + "..." : question;

        // Determine which agents to show based on question content
        let steps = [
          {
            id: "step-supervisor",
            text: `SUPERVISOR AGENT: Analyzing question${
              question ? ': "' + shortQuestion + '"' : "..."
            }`,
            delay: 300,
          },
        ];

        // Add specific agent steps based on question content
        if (
          question.toLowerCase().includes("spl") ||
          question.toLowerCase().includes("query") ||
          question.toLowerCase().includes("search")
        ) {
          steps.push({
            id: "step-spl",
            text:
              "SPL GENERATOR AGENT: Creating Splunk query for: " +
              shortQuestion,
          });
        }

        if (
          question.toLowerCase().includes("reputation") ||
          question.toLowerCase().includes("threat") ||
          question.toLowerCase().includes("analysis")
        ) {
          steps.push({
            id: "step-analysis",
            text: "ANALYSIS AGENT: Processing threat intelligence and context...",
            delay: steps.length > 1 ? 1400 : 800,
          });
        }

        // Always add final response step
        steps.push({
          id: "step-response",
          text: "SUPERVISOR AGENT: Question answered successfully with enhanced formatting",
          delay: steps.length > 1 ? (steps.length > 2 ? 2000 : 1500) : 1200,
        });

        steps.forEach((step, index) => {
          setTimeout(() => {
            const progressSteps = document.getElementById("progress-steps");
            if (!progressSteps) return; // Exit if indicator was removed

            // Mark previous step as completed
            if (index > 0) {
              const prevStep = document.getElementById(steps[index - 1].id);
              if (prevStep) {
                prevStep.innerHTML = `
                                <i class="fas fa-check-circle text-success me-2"></i>
                                <span class="text-success">${
                                  steps[index - 1].text
                                } âœ…</span>
                            `;
              }
            }

            // Add current step if not the first one
            if (index > 0) {
              const newStep = document.createElement("div");
              newStep.className = "progress-step mt-1";
              newStep.id = step.id;
              newStep.innerHTML = `
                            <i class="fas fa-spinner fa-spin me-2"></i>
                            <span>${step.text}</span>
                        `;
              progressSteps.appendChild(newStep);
            } else {
              // Update first step
              const firstStep = document.getElementById(step.id);
              if (firstStep) {
                firstStep.innerHTML = `
                                <i class="fas fa-spinner fa-spin me-2"></i>
                                <span>${step.text}</span>
                            `;
              }
            }

            // Auto-scroll to bottom
            const conversationHistory = document.getElementById(
              "conversationHistory"
            );
            if (conversationHistory) {
              conversationHistory.scrollTop = conversationHistory.scrollHeight;
            }
          }, step.delay);
        });

        // Final step - mark last as completed after a delay
        setTimeout(() => {
          const progressSteps = document.getElementById("progress-steps");
          if (!progressSteps) return;

          const lastStep = document.getElementById(steps[steps.length - 1].id);
          if (lastStep) {
            lastStep.innerHTML = `
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <span class="text-success">${
                          steps[steps.length - 1].text
                        } âœ…</span>
                    `;
          }
        }, steps[steps.length - 1].delay + 300);
      }

      function removeTypingIndicator() {
        const typingIndicator = document.getElementById("typing-indicator");
        if (typingIndicator) {
          typingIndicator.remove();
        }
      }

      function askQuestion() {
        const question = document.getElementById("questionInput").value;
        if (!question.trim()) {
          // Show a nice alert instead
          const questionInput = document.getElementById("questionInput");
          questionInput.style.borderColor = "#dc3545";
          questionInput.setAttribute(
            "placeholder",
            "Please enter your question here..."
          );
          setTimeout(() => {
            questionInput.style.borderColor = "#e9ecef";
            questionInput.setAttribute(
              "placeholder",
              "Example: How dangerous is this activity? What should I investigate first?"
            );
          }, 2000);
          return;
        }

        // Add user question to conversation
        addConversationBubble(question, true);

        // Clear input and show typing indicator with question
        document.getElementById("questionInput").value = "";
        showTypingIndicator(question);

        // Disable button during processing
        const askButton = document.getElementById("askButton");
        askButton.disabled = true;
        askButton.innerHTML =
          '<div class="spinner-border spinner-border-sm me-2"></div>Processing...';

        fetch("/api/qa-assistant", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            alert_id: window.currentChatAlertId || currentAlertId,
            question: question,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            removeTypingIndicator();

            if (data.status === "success") {
              addConversationBubble(data.answer, false);
            } else {
              addConversationBubble(
                `
                        <div class="alert alert-danger mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Error:</strong> ${data.error}
                        </div>
                    `,
                false
              );
            }
          })
          .catch((error) => {
            removeTypingIndicator();
            addConversationBubble(
              `
                    <div class="alert alert-warning mb-0">
                        <i class="fas fa-wifi me-2"></i>
                        <strong>Connection Error:</strong> ${error.message}
                    </div>
                `,
              false
            );
          })
          .finally(() => {
            // Re-enable button
            askButton.disabled = false;
            askButton.innerHTML =
              '<i class="fas fa-paper-plane me-2"></i>Ask AI';
          });
      }

      function updateReasoningTimeline(step, status = "active") {
        const timeline = document.getElementById("reasoningTimeline");
        const stepElement = document.createElement("div");
        stepElement.className = `reasoning-step ${status} expandable`;
        stepElement.setAttribute(
          "data-step-id",
          step.id || Math.random().toString(36).substr(2, 9)
        );

        const statusIcon = {
          active: "info",
          completed: "success",
          processing: "warning",
        };

        stepElement.innerHTML = `
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <span class="status-indicator ${
                          statusIcon[status] || "info"
                        }"></span>
                        <strong>${step.title}</strong>
                    </div>
                    <i class="fas fa-chevron-right text-muted step-arrow" style="transition: transform 0.3s ease;"></i>
                </div>
                <small class="text-muted">${step.description}</small>
                <div class="step-details mt-2" style="display: none;">
                    <div class="bg-light rounded p-3">
                        <h6 class="text-primary mb-2">
                            <i class="fas fa-cogs me-2"></i>AI Process Details
                        </h6>
                        <div class="mb-2">
                            <strong>Tool Used:</strong> 
                            <span class="badge bg-info">${
                              step.tool || "Analysis Engine"
                            }</span>
                        </div>
                        <div class="mb-2">
                            <strong>Reasoning:</strong>
                            <p class="mb-1 small">${
                              step.reasoning
                                ? formatInvestigationStep(step.reasoning)
                                : "AI analyzed the alert characteristics and selected the most appropriate analysis method based on security patterns and threat intelligence."
                            }</p>
                        </div>
                        <div class="mb-2">
                            <strong>Assessment:</strong>
                            <div class="progress mb-1" style="height: 15px;">
                                <div class="progress-bar bg-success" style="width: ${
                                  step.confidence || 85
                                }%">
                                    ${step.confidence || 85}% Confidence
                                </div>
                            </div>
                        </div>
                        <div class="text-muted small">
                            <strong>Next Action:</strong> ${
                              step.nextAction ||
                              "Proceeding to next analysis phase..."
                            }
                        </div>
                    </div>
                </div>
            `;

        // Add click handler for expansion
        stepElement.addEventListener("click", function () {
          const details = this.querySelector(".step-details");
          const arrow = this.querySelector(".step-arrow");

          if (details.style.display === "none") {
            details.style.display = "block";
            arrow.style.transform = "rotate(90deg)";
            this.style.borderLeftColor = "#28a745";
          } else {
            details.style.display = "none";
            arrow.style.transform = "rotate(0deg)";
            this.style.borderLeftColor = "#007bff";
          }
        });

        timeline.appendChild(stepElement);
      }

      function updateAIInsights(insight) {
        document.getElementById("aiInsights").innerHTML = insight;
      }

      function startInvestigation(alertId) {
        alertId = alertId || "{{ alert.id }}"; // Fallback to template variable
        console.log(`Starting investigation for alert: ${alertId}`);

        // Show the modal
        const modal = new bootstrap.Modal(
          document.getElementById("investigationModal")
        );
        modal.show();

        // Initialize the investigation interface
        initializeInvestigation(alertId);
      }

      function initializeInvestigation(alertId) {
        // Show loading state
        document.getElementById("playbookSteps").innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <div class="mt-2">Initializing investigation...</div>
                </div>
            `;

        // Initialize investigation session (does not execute steps)
        fetch("/api/start-investigation", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ alert_id: alertId }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              window.currentInvestigationId = data.investigation_id;

              // Update investigation details in the modal header/UI
              updateInvestigationDetails(data);

              // Display the playbook steps
              displayPlaybookSteps(data);

              // Show success message with resume indication
              const message = data.resumed
                ? "Investigation resumed successfully! Your previous progress has been restored."
                : "Investigation initialized successfully!";

              // Show a brief success notification
              showNotification(message, "success");
            } else {
              document.getElementById("playbookSteps").innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Error:</strong> ${
                              data.message || data.error || "Unknown error"
                            }
                        </div>
                    `;
            }
          })
          .catch((error) => {
            document.getElementById("playbookSteps").innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-wifi me-2"></i>
                        <strong>Connection Error:</strong> ${error.message}
                    </div>
                `;
          });
      }

      function loadPlaybookSteps(investigationId) {
        // Store investigation ID for later use
        window.currentInvestigationId = investigationId;

        fetch(`/api/investigation/${investigationId}/steps`)
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              displayPlaybookSteps(data);
              // Restore any running step statuses from session storage
              restoreStepStatuses();
            } else {
              document.getElementById("playbookSteps").innerHTML = `
                            <div class="alert alert-danger">
                                Error loading steps: ${
                                  data.message || "Unknown error"
                                }
                            </div>
                        `;
            }
          })
          .catch((error) => {
            document.getElementById("playbookSteps").innerHTML = `
                        <div class="alert alert-warning">
                            Error: ${error.message}
                        </div>
                    `;
          });
      }

      function updateInvestigationDetails(data) {
        // Update investigation ID
        const invIdElement = document.getElementById("investigationId");
        if (invIdElement) {
          invIdElement.textContent = data.investigation_id;
        }

        // Update playbook name in the modal title
        const playbookTitle = document.getElementById("playbookTitle");
        if (playbookTitle) {
          playbookTitle.textContent = data.playbook_name || "Unknown Playbook";
        }

        // Update playbook name in summary
        const playbookName = document.getElementById("playbookName");
        if (playbookName) {
          playbookName.textContent = data.playbook_name || "Unknown";
        }

        // Update started time
        const startedTime = document.getElementById("startedTime");
        if (startedTime) {
          startedTime.textContent = new Date().toLocaleString();
        }

        // Update investigation plan with simplified display
        const investigationPlan = document.getElementById("investigationPlan");
        if (investigationPlan && data.steps) {
          // Simplified investigation plan - detailed view is now in dashboard
          investigationPlan.innerHTML = `
                    <span class="badge bg-success me-2">
                        <i class="fas fa-check me-1"></i>Ready
                    </span>
                    <strong>${data.steps.length} step playbook</strong> loaded for 
                    <span class="text-primary">${data.playbook_name}</span>
                `;
        }

        // Update step progress counter with current completed steps
        const stepProgress = document.getElementById("stepProgress");
        if (stepProgress) {
          const completedSteps = data.steps
            ? data.steps.filter((s) => s.status === "completed").length
            : 0;
          const totalSteps = data.steps ? data.steps.length : 0;
          stepProgress.textContent = `${completedSteps} / ${totalSteps}`;
        }
      }

      function displayPlaybookSteps(data) {
        const steps = data.steps;
        let stepsHtml = `
                <div class="investigation-header mb-3">
                    <h5>Investigation Playbook: ${
                      data.playbook_name || "Unknown"
                    }</h5>
                    <p class="text-muted">Click on each step to execute and view reasoning.</p>
                </div>
            `;

        steps.forEach((step, index) => {
          const statusClass = getStepStatusClass(step.status);
          const statusIcon = getStepStatusIcon(step.status);
          const canExecute =
            step.status === "pending" &&
            (index === 0 || steps[index - 1].status === "completed");
          const canRetry = step.status === "canceled";

          stepsHtml += `
                    <div class="playbook-step ${statusClass}" data-step="${
            step.number
          }">
                        <div class="playbook-step-header" onclick="selectStep(${
                          step.number
                        })">
                            <div class="playbook-step-number">
                                ${statusIcon}
                                ${step.number}
                            </div>
                            <div class="playbook-step-info">
                                <div class="playbook-step-title">${
                                  step.phase
                                }</div>
                                <div class="playbook-step-description">${
                                  step.phase_description
                                }</div>
                            </div>
                            <div class="playbook-step-action">
                                ${
                                  canExecute
                                    ? '<button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); executeStep(' +
                                      step.number +
                                      ')">Execute Step</button>'
                                    : ""
                                }
                                ${
                                  canRetry
                                    ? '<button class="btn btn-sm btn-warning" onclick="event.stopPropagation(); retryStep(' +
                                      step.number +
                                      ')" title="Retry cancelled step"><i class="fas fa-redo me-1"></i>Retry</button>'
                                    : ""
                                }
                            </div>
                        </div>
                        ${
                          step.reasoning || step.conclusion
                            ? `
                            <div class="step-details" id="stepDetails${
                              step.number
                            }">
                                ${
                                  step.reasoning
                                    ? `
                                    <div class="step-reasoning">
                                        <h6>How and Why AI executed this step:</h6>
                                        <div class="bg-light p-3 rounded mb-2">${formatInvestigationStep(
                                          step.reasoning
                                        )}</div>
                                    </div>
                                `
                                    : ""
                                }
                                ${
                                  step.conclusion
                                    ? `
                                    <div class="step-conclusion">
                                        <h6>Quick Conclusion:</h6>
                                        <div class="bg-success bg-opacity-10 p-3 rounded text-success">${formatInvestigationStep(
                                          step.conclusion
                                        )}</div>
                                    </div>
                                `
                                    : ""
                                }
                            </div>
                        `
                            : ""
                        }
                    </div>
                `;
        });

        document.getElementById("playbookSteps").innerHTML = stepsHtml;

        // Update progress counter after displaying steps
        const stepProgress = document.getElementById("stepProgress");
        if (stepProgress) {
          let completedSteps, totalSteps;

          if (data.investigation) {
            completedSteps = data.investigation.completed_steps;
            totalSteps = data.investigation.total_steps;
          } else {
            completedSteps = data.steps
              ? data.steps.filter((s) => s.status === "completed").length
              : 0;
            totalSteps = data.steps ? data.steps.length : 0;
          }

          stepProgress.textContent = `${completedSteps} / ${totalSteps}`;
        }
      }

      function getStepStatusClass(status) {
        switch (status) {
          case "completed":
            return "step-completed";
          case "running":
            return "step-running";
          case "in_progress":
            return "step-in-progress";
          case "failed":
            return "step-failed";
          case "pending":
            return "step-pending";
          case "canceled":
            return "step-canceled";
          case "canceling":
            return "step-canceling";
          default:
            return "step-pending";
        }
      }

      function getStepStatusIcon(status) {
        switch (status) {
          case "completed":
            return '<i class="fas fa-check-circle text-success" aria-hidden="true"></i>';
          case "running":
            return '<i class="fas fa-spinner fa-spin text-primary" aria-hidden="true"></i>';
          case "in_progress":
            return '<i class="fas fa-hourglass-half text-warning" aria-hidden="true"></i>';
          case "failed":
            return '<i class="fas fa-exclamation-circle text-danger" aria-hidden="true"></i>';
          case "pending":
            return '<i class="far fa-circle text-muted" aria-hidden="true"></i>';
          case "canceled":
            return '<i class="fas fa-times-circle text-warning" aria-hidden="true"></i>';
          case "canceling":
            return '<i class="fas fa-spinner fa-spin text-warning" aria-hidden="true"></i>';
          default:
            return '<i class="far fa-circle text-muted" aria-hidden="true"></i>';
        }
      }

      function selectStep(stepNumber) {
        // Show step details in the right panel
        showStepInRightPanel(stepNumber);
      }

      function showStepInRightPanel(stepNumber) {
        if (!window.currentInvestigationId) return;

        // Fetch current step data
        fetch(`/api/investigation/${window.currentInvestigationId}/steps`)
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              const step = data.steps.find((s) => s.number === stepNumber);
              if (step) {
                displayStepInRightPanel(step);
              }
            }
          });
      }

      function displayStepInRightPanel(step) {
        // Track which step is currently displayed
        currentDisplayedStep = step.number;

        const stepDetails = document.getElementById("stepDetails");
        const canExecute = step.status === "pending";
        const isRunning = step.status === "running";
        const canRetry = step.status === "canceled";

        stepDetails.innerHTML = `
                <div class="step-detail-panel">
                    <div class="step-header">
                        <h5>Step ${step.number}: ${step.phase}</h5>
                        <span class="badge ${getStepBadgeClass(step.status)}">${
          step.status
        }</span>
                    </div>
                    
                    <div class="step-content">
                        <div class="mb-3">
                            <h6>Description:</h6>
                            <p class="text-muted">${step.phase_description}</p>
                        </div>
                        
                        <div class="mb-3">
                            <h6>Required Actions:</h6>
                            <div class="bg-light p-3 rounded">
                                <pre style="white-space: pre-wrap; margin: 0;">${
                                  step.detail_actions
                                }</pre>
                            </div>
                        </div>
                        
                        ${
                          step.status === "completed" && step.reasoning
                            ? `
                            <div class="mb-3">
                                <h6 class="text-primary">How and Why AI executed this step:</h6>
                                <div class="bg-info bg-opacity-10 p-3 rounded border-start border-info border-3">
                                    ${formatInvestigationStep(step.reasoning)}
                                </div>
                            </div>
                        `
                            : ""
                        }
                        
                        ${
                          step.status === "completed" && step.conclusion
                            ? `
                            <div class="mb-3">
                                <h6 class="text-success">Quick Conclusion:</h6>
                                <div class="bg-success bg-opacity-10 p-3 rounded border-start border-success border-3">
                                    ${formatInvestigationStep(step.conclusion)}
                                </div>
                            </div>
                        `
                            : ""
                        }
                        
                        ${
                          step.status === "completed" && step.api_results
                            ? `
                            <div class="mb-3">
                                <h6 class="text-info">API Integration Results:</h6>
                                <div class="bg-light p-3 rounded">
                                    ${formatApiResults(step.api_results)}
                                </div>
                            </div>
                        `
                            : ""
                        }
                        
                        ${
                          step.status === "completed" && step.execution_results
                            ? `
                            <div class="mb-3">
                                <h6 class="text-warning">Execution Results:</h6>
                                <div class="bg-warning bg-opacity-10 p-3 rounded border-start border-warning border-3">
                                    ${formatInvestigationStep(
                                      step.execution_results
                                    )}
                                </div>
                            </div>
                        `
                            : ""
                        }
                        
                        ${
                          step.status === "canceled"
                            ? `
                            <div class="mb-3">
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    This step was cancelled before completion. You can retry it below.
                                </div>
                            </div>
                        `
                            : ""
                        }
                        
                        ${
                          canExecute
                            ? `
                            <div class="text-center mt-4">
                                <button class="btn btn-primary btn-lg" onclick="executeStep(${step.number})" id="executeBtn${step.number}">
                                    <i class="fas fa-play me-2"></i>Execute Step
                                </button>
                            </div>
                        `
                            : ""
                        }
                        
                        ${
                          canRetry
                            ? `
                            <div class="text-center mt-4">
                                <button class="btn btn-warning btn-lg" onclick="retryStep(${step.number})" id="retryBtn${step.number}">
                                    <i class="fas fa-redo me-2"></i>Retry Step
                                </button>
                            </div>
                        `
                            : ""
                        }
                        
                        ${
                          isRunning
                            ? `
                            <div class="text-center mt-4">
                                <div class="mb-3">
                                    <div class="d-flex align-items-center justify-content-center mb-2">
                                        <div class="spinner-border text-primary me-3" role="status" aria-hidden="true"></div>
                                        <div class="text-start">
                                            <div class="text-primary fw-bold">AI is working...</div>
                                            <div class="text-muted small">${
                                              step.current_activity ||
                                              "Initializing step execution..."
                                            }</div>
                                        </div>
                                    </div>
                                    
                                    ${
                                      step.progress_percentage
                                        ? `
                                        <div class="progress mb-3" style="height: 8px;">
                                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                                 role="progressbar" 
                                                 style="width: ${step.progress_percentage}%" 
                                                 aria-valuenow="${step.progress_percentage}" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="100"></div>
                                        </div>
                                        <div class="text-muted small mb-3">${step.progress_percentage}% complete</div>
                                    `
                                        : ""
                                    }
                                    
                                    <button class="btn btn-danger btn-lg" onclick="cancelStep(${
                                      step.number
                                    })" id="cancelBtn${step.number}">
                                        <i class="fas fa-stop me-2"></i>Cancel Step
                                    </button>
                                </div>
                            </div>
                        `
                            : ""
                        }
                    </div>
                </div>
            `;
      }

      function formatApiResults(apiResults) {
        let html = "";

        if (apiResults.ip_reputation) {
          const ip = apiResults.ip_reputation;
          html += `
                    <div class="api-result-card mb-3">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-shield-alt me-2"></i>
                            <strong>IP Reputation Check</strong>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <small class="text-muted">IP Address:</small><br>
                                <code>${ip.ip}</code>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted">Reputation Score:</small><br>
                                <span class="badge ${
                                  ip.reputation_score > 50
                                    ? "bg-danger"
                                    : ip.reputation_score > 20
                                    ? "bg-warning"
                                    : "bg-success"
                                }">
                                    ${ip.reputation_score}/100
                                </span>
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">Status:</small>
                            <span class="ms-2 ${
                              ip.is_malicious ? "text-danger" : "text-success"
                            }">
                                ${
                                  ip.is_malicious
                                    ? "ðŸš¨ Potentially Malicious"
                                    : "âœ… Clean"
                                }
                            </span>
                        </div>
                        ${
                          ip.threat_categories &&
                          ip.threat_categories.length > 0
                            ? `
                            <div class="mt-2">
                                <small class="text-muted">Threat Categories:</small><br>
                                ${ip.threat_categories
                                  .map(
                                    (cat) =>
                                      `<span class="badge bg-warning me-1">${cat}</span>`
                                  )
                                  .join("")}
                            </div>
                        `
                            : ""
                        }
                        <div class="mt-2">
                            <small class="text-muted">Sources:</small>
                            <small class="ms-2">${ip.sources.join(", ")}</small>
                        </div>
                    </div>
                `;
        }

        if (apiResults.splunk_search) {
          const splunk = apiResults.splunk_search;
          html += `
                    <div class="api-result-card mb-3">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-search me-2"></i>
                            <strong>Splunk Search Results</strong>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-6">
                                <small class="text-muted">Results Found:</small><br>
                                <span class="badge bg-info">${
                                  splunk.results_count
                                }</span>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted">Execution Time:</small><br>
                                <small>${splunk.execution_time}</small>
                            </div>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">Query:</small><br>
                            <code style="font-size: 0.8em; word-break: break-all;">${
                              splunk.query
                            }</code>
                        </div>
                        ${
                          splunk.results && splunk.results.length > 0
                            ? `
                            <div class="mt-2">
                                <small class="text-muted">Top Results:</small>
                                <div class="table-responsive mt-1">
                                    <table class="table table-sm table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                ${Object.keys(splunk.results[0])
                                                  .map(
                                                    (key) =>
                                                      `<th style="font-size: 0.75em;">${key}</th>`
                                                  )
                                                  .join("")}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${splunk.results
                                              .slice(0, 3)
                                              .map(
                                                (result) => `
                                                <tr>
                                                    ${Object.values(result)
                                                      .map(
                                                        (value) =>
                                                          `<td style="font-size: 0.75em;">${value}</td>`
                                                      )
                                                      .join("")}
                                                </tr>
                                            `
                                              )
                                              .join("")}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `
                            : ""
                        }
                    </div>
                `;
        }

        return html || "<em>No API integration data available</em>";
      }

      function getStepBadgeClass(status) {
        switch (status) {
          case "completed":
            return "bg-success";
          case "running":
            return "bg-warning";
          case "error":
            return "bg-danger";
          default:
            return "bg-secondary";
        }
      }

      function executeStep(stepNumber) {
        if (!window.currentInvestigationId) {
          alert("No active investigation found");
          return;
        }

        // Update UI to show step is running
        updateStepStatus(stepNumber, "running");
        const executeBtn = document.getElementById(`executeBtn${stepNumber}`);
        if (executeBtn) {
          executeBtn.innerHTML =
            '<i class="fas fa-spinner fa-spin me-2"></i>Executing...';
          executeBtn.disabled = true;
        }

        // Store the executing step in session storage for persistence
        sessionStorage.setItem(`step_${stepNumber}_status`, "running");
        sessionStorage.setItem(
          `step_${stepNumber}_started_at`,
          new Date().toISOString()
        );

        // Start polling for status updates during execution
        // startStatusPolling(stepNumber);

        fetch(
          `/api/investigation/${window.currentInvestigationId}/step/${stepNumber}/execute`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          }
        )
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              // Start polling for status updates during execution
              startStatusPolling(stepNumber);
              console.log(
                "Step execution started successfully, polling for completion..."
              );

              // Update session storage to reflect that step is running
              sessionStorage.setItem(`step_${stepNumber}_status`, "running");
            } else {
              stopStatusPolling(stepNumber);
              updateStepStatus(stepNumber, "error");
              sessionStorage.setItem(`step_${stepNumber}_status`, "error");
              alert(`Step execution failed: ${data.message}`);
              if (executeBtn) {
                executeBtn.innerHTML =
                  '<i class="fas fa-exclamation-triangle me-2"></i>Failed - Retry';
                executeBtn.disabled = false;
              }
            }
          })
          .catch((error) => {
            console.error("Error executing step:", error);
            // Don't stop polling on error - let it continue to check status
            // The backend might still be processing or we might get a network error
            alert(`Error starting step execution: ${error.message}`);
          });
      }

      // Cancel step execution
      function cancelStep(stepNumber) {
        const investigationId = getCurrentInvestigationId();
        if (!investigationId) {
          alert("No active investigation found");
          return;
        }

        if (confirm(`Are you sure you want to cancel Step ${stepNumber}?`)) {
          // Show canceling state
          updateStepStatus(stepNumber, "canceling");

          fetch(
            `/api/investigation/${investigationId}/step/${stepNumber}/cancel`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
            }
          )
            .then((response) => {
              if (response.ok) {
                return response.json();
              }
              throw new Error("Failed to cancel step");
            })
            .then((data) => {
              console.log("Step canceled:", data);
              // Stop polling and update UI
              stopStatusPolling(stepNumber);
              updateStepStatus(stepNumber, "canceled");
              sessionStorage.setItem(`step_${stepNumber}_status`, "canceled");

              // Update the step button to show it can be executed again
              const executeBtn = document.querySelector(
                `[data-step="${stepNumber}"] .btn-success`
              );
              if (executeBtn) {
                executeBtn.innerHTML =
                  '<i class="fas fa-play me-2"></i>Execute Step';
                executeBtn.disabled = false;
              }

              // Refresh the right panel display
              displayStepInRightPanel(stepNumber);

              // Refresh the left panel to show updated steps
              loadPlaybookSteps(window.currentInvestigationId);
            })
            .catch((error) => {
              console.error("Error canceling step:", error);
              alert(`Error canceling step: ${error.message}`);
              // Revert to running state if cancel failed
              updateStepStatus(stepNumber, "running");
            });
        }
      }

      // Retry cancelled step execution
      function retryStep(stepNumber) {
        const investigationId = getCurrentInvestigationId();
        if (!investigationId) {
          alert("No active investigation found");
          return;
        }

        if (confirm(`Are you sure you want to retry Step ${stepNumber}?`)) {
          // Show loading state
          const retryBtn = document.getElementById(`retryBtn${stepNumber}`);
          if (retryBtn) {
            retryBtn.innerHTML =
              '<i class="fas fa-spinner fa-spin me-2"></i>Resetting...';
            retryBtn.disabled = true;
          }

          // First reset the step status to pending
          fetch(
            `/api/investigation/${investigationId}/step/${stepNumber}/reset`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
            }
          )
            .then((response) => {
              if (response.ok) {
                return response.json();
              }
              throw new Error("Failed to reset step");
            })
            .then((data) => {
              console.log("Step reset to pending:", data);

              // Update step status to pending
              updateStepStatus(stepNumber, "pending");
              sessionStorage.setItem(`step_${stepNumber}_status`, "pending");

              // Now execute the step
              executeStep(stepNumber);

              // Refresh the displays
              loadPlaybookSteps(window.currentInvestigationId);
            })
            .catch((error) => {
              console.error("Error retrying step:", error);
              alert(`Error retrying step: ${error.message}`);

              // Restore button state
              if (retryBtn) {
                retryBtn.innerHTML =
                  '<i class="fas fa-redo me-2"></i>Retry Step';
                retryBtn.disabled = false;
              }
            });
        }
      }

      // Show audit trail function
      function showAuditTrail() {
        if (!window.currentInvestigationId) {
          alert("No active investigation found");
          return;
        }

        const modal = new bootstrap.Modal(
          document.getElementById("auditTrailModal")
        );
        modal.show();

        // Load audit trail data
        fetch(`/api/investigation/${window.currentInvestigationId}/audit-trail`)
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              displayAuditTrail(data.audit_trail);
            } else {
              document.getElementById("auditTrailContent").innerHTML = `
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Unable to load audit trail: ${data.message}
                            </div>
                        `;
            }
          })
          .catch((error) => {
            console.error("Error loading audit trail:", error);
            document.getElementById("auditTrailContent").innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-times-circle me-2"></i>
                            Error loading audit trail: ${error.message}
                        </div>
                    `;
          });
      }

      function displayAuditTrail(auditTrail) {
        const content = document.getElementById("auditTrailContent");

        if (!auditTrail || auditTrail.length === 0) {
          content.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-clipboard-list text-muted" style="font-size: 3rem;"></i>
                        <h6 class="text-muted mt-3">No Audit Trail Available</h6>
                        <p class="text-muted">No historical actions have been recorded for this investigation.</p>
                    </div>
                `;
          return;
        }

        const timelineHtml = auditTrail
          .map((entry) => {
            const timestamp = new Date(entry.timestamp);
            const timeStr = timestamp.toLocaleString();

            let iconClass = "fas fa-info-circle text-info";
            let bgClass = "bg-light";

            switch (entry.action) {
              case "step_execution_started":
                iconClass = "fas fa-play text-primary";
                bgClass = "bg-primary bg-opacity-10";
                break;
              case "step_execution_completed":
                iconClass = "fas fa-check-circle text-success";
                bgClass = "bg-success bg-opacity-10";
                break;
              case "investigation_data_cleared":
                iconClass = "fas fa-trash text-danger";
                bgClass = "bg-danger bg-opacity-10";
                break;
              case "step_execution_failed":
                iconClass = "fas fa-exclamation-circle text-warning";
                bgClass = "bg-warning bg-opacity-10";
                break;
            }

            return `
                    <div class="timeline-item ${bgClass} p-3 rounded mb-3">
                        <div class="d-flex align-items-start">
                            <div class="me-3 mt-1">
                                <i class="${iconClass}"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="mb-0">${formatActionName(
                                      entry.action
                                    )}</h6>
                                    <small class="text-muted">${timeStr}</small>
                                </div>
                                <div class="text-muted small mb-2">
                                    <strong>User:</strong> ${entry.user}
                                </div>
                                ${
                                  entry.details
                                    ? `
                                    <div class="details-section">
                                        <strong>Details:</strong>
                                        <pre class="small mt-1 mb-0" style="white-space: pre-wrap;">${JSON.stringify(
                                          entry.details,
                                          null,
                                          2
                                        )}</pre>
                                    </div>
                                `
                                    : ""
                                }
                            </div>
                        </div>
                    </div>
                `;
          })
          .join("");

        content.innerHTML = `
                <div class="audit-trail-timeline">
                    <h6 class="mb-3">
                        <i class="fas fa-timeline me-2"></i>
                        Investigation Timeline (${auditTrail.length} entries)
                    </h6>
                    ${timelineHtml}
                </div>
            `;
      }

      function formatActionName(action) {
        const actionNames = {
          step_execution_started: "Step Execution Started",
          step_execution_completed: "Step Execution Completed",
          step_execution_failed: "Step Execution Failed",
          investigation_data_cleared: "Investigation Data Cleared",
          investigation_created: "Investigation Created",
          step_canceled: "Step Canceled",
        };
        return (
          actionNames[action] ||
          action.replace(/_/g, " ").replace(/\b\w/g, (l) => l.toUpperCase())
        );
      }

      // Update alert status function
      function updateAlertStatus(alertId, newStatus) {
        fetch(`/api/alerts/${alertId}/status`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ status: newStatus }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              console.log(`Alert ${alertId} status updated to: ${newStatus}`);
            } else {
              console.error("Failed to update alert status:", data.message);
            }
          })
          .catch((error) => {
            console.error("Error updating alert status:", error);
          });
      }

      // Clear current alert investigation data only
      function clearCurrentAlertData() {
        const alertId = "{{ alert.alert_id }}";
        if (
          confirm(
            `Are you sure you want to clear investigation data for alert ${alertId}? This action cannot be undone.`
          )
        ) {
          // Show loading state
          const clearBtn = event.target;
          const originalText = clearBtn.innerHTML;
          clearBtn.innerHTML =
            '<i class="fas fa-spinner fa-spin me-2"></i>Clearing...';
          clearBtn.disabled = true;

          fetch(`/api/clear-alert-investigation/${alertId}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          })
            .then((response) => {
              if (response.ok) {
                return response.json();
              }
              throw new Error("Failed to clear alert investigation data");
            })
            .then((data) => {
              console.log("Alert investigation data cleared:", data);
              alert(`${data.message}`);

              // Clear any in-memory state for this alert
              window.currentInvestigationId = null;

              // Clear session storage for this alert steps
              for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                if (key && key.startsWith("step_")) {
                  sessionStorage.removeItem(key);
                }
              }

              // Close the modal and refresh the alert detail page
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("investigationModal")
              );
              if (modal) {
                modal.hide();
              }

              // Update alert status to 'In Progress' after clearing
              updateAlertStatus(alertId, "In Progress");

              // Refresh the page to show clean state
              window.location.reload();
            })
            .catch((error) => {
              console.error("Error clearing alert investigation data:", error);
              alert(`Error clearing investigation data: ${error.message}`);
            })
            .finally(() => {
              // Restore button state
              clearBtn.innerHTML = originalText;
              clearBtn.disabled = false;
            });
        }
      }

      // Clear all investigation data
      function clearAllInvestigationData() {
        if (
          confirm(
            "Are you sure you want to clear ALL historical investigation data? This action cannot be undone."
          )
        ) {
          // Show loading state
          const clearBtn = event.target;
          const originalText = clearBtn.innerHTML;
          clearBtn.innerHTML =
            '<i class="fas fa-spinner fa-spin me-2"></i>Clearing...';
          clearBtn.disabled = true;

          fetch("/api/clear-all-investigations", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          })
            .then((response) => {
              if (response.ok) {
                return response.json();
              }
              throw new Error("Failed to clear investigation data");
            })
            .then((data) => {
              console.log("All investigation data cleared:", data);
              alert(`${data.message}`);

              // Clear any in-memory state
              window.currentInvestigationId = null;
              sessionStorage.clear(); // Clear all session storage

              // Close the modal and refresh if needed
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("investigationModal")
              );
              if (modal) {
                modal.hide();
              }

              // Refresh the page to ensure clean state
              window.location.reload();
            })
            .catch((error) => {
              console.error("Error clearing investigation data:", error);
              alert(`Error clearing investigation data: ${error.message}`);
            })
            .finally(() => {
              // Restore button state
              clearBtn.innerHTML = originalText;
              clearBtn.disabled = false;
            });
        }
      }

      let pollingIntervals = {}; // Store polling intervals by step number

      function getCurrentInvestigationId() {
        return window.currentInvestigationId;
      }

      function startStatusPolling(stepNumber) {
        // Poll every 2 seconds for status updates
        pollingIntervals[stepNumber] = setInterval(() => {
          checkStepStatus(stepNumber);
        }, 2000);
      }

      function stopStatusPolling(stepNumber) {
        if (pollingIntervals[stepNumber]) {
          clearInterval(pollingIntervals[stepNumber]);
          delete pollingIntervals[stepNumber];
        }
      }

      function checkStepStatus(stepNumber) {
        if (!window.currentInvestigationId) return;

        fetch(`/api/investigation/${window.currentInvestigationId}/steps`)
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              const step = data.steps.find((s) => s.number === stepNumber);
              if (step) {
                const currentStatus = step.status;
                const sessionStatus = sessionStorage.getItem(
                  `step_${stepNumber}_status`
                );

                // Force UI update - check if status has changed OR if UI is stuck in running state
                const executeBtn = document.querySelector(
                  `[data-step="${stepNumber}"] .btn-success, [data-step="${stepNumber}"] .btn-primary`
                );
                const isUIRunning =
                  executeBtn &&
                  (executeBtn.innerHTML.includes("fa-spin") ||
                    executeBtn.innerHTML.includes("Executing"));

                if (
                  currentStatus !== sessionStatus ||
                  (isUIRunning && currentStatus === "completed")
                ) {
                  console.log(
                    `Step ${stepNumber}: Status changed from ${sessionStatus} to ${currentStatus} or UI sync needed`
                  );
                  updateStepStatus(stepNumber, currentStatus);

                  // If completed, failed, or canceled, stop polling and update button
                  if (
                    currentStatus === "completed" ||
                    currentStatus === "failed" ||
                    currentStatus === "canceled"
                  ) {
                    stopStatusPolling(stepNumber);
                    sessionStorage.removeItem(`step_${stepNumber}_status`);

                    // Force update the execute button state
                    if (executeBtn) {
                      if (currentStatus === "completed") {
                        executeBtn.innerHTML =
                          '<i class="fas fa-check me-2"></i>Completed';
                        executeBtn.disabled = true;
                        executeBtn.classList.remove("btn-primary");
                        executeBtn.classList.add("btn-success");
                      } else if (currentStatus === "canceled") {
                        executeBtn.innerHTML =
                          '<i class="fas fa-play me-2"></i>Execute Step';
                        executeBtn.disabled = false;
                        executeBtn.classList.remove("btn-success");
                        executeBtn.classList.add("btn-primary");
                      } else if (currentStatus === "failed") {
                        executeBtn.innerHTML =
                          '<i class="fas fa-exclamation-triangle me-2"></i>Failed - Retry';
                        executeBtn.disabled = false;
                        executeBtn.classList.remove("btn-success");
                        executeBtn.classList.add("btn-warning");
                      }
                    }

                    // If this step is currently displayed in the right panel, refresh it to show results
                    if (currentDisplayedStep === stepNumber) {
                      // This step is currently displayed in the right panel, refresh it
                      displayStepInRightPanel(step);
                    }

                    // Update playbook status card
                    updatePlaybookStatusCard(window.currentInvestigationId);
                  }
                }
              }
            }
          })
          .catch((error) => {
            console.error("Status polling error:", error);
            // Stop polling on error to prevent spam
            stopStatusPolling(stepNumber);
          });
      }

      // Function to restore step statuses from session storage on page load
      function restoreStepStatuses() {
        // Only restore running steps, respect server state for completed/pending steps
        for (let i = 0; i < sessionStorage.length; i++) {
          const key = sessionStorage.key(i);
          if (key && key.startsWith("step_") && key.endsWith("_status")) {
            const stepNumber = parseInt(key.split("_")[1]);
            const sessionStatus = sessionStorage.getItem(key);

            // Get current step element to check server state
            const stepElement = document.querySelector(
              `[data-step="${stepNumber}"]`
            );
            if (!stepElement) continue;

            // Only restore 'running' status if step is not already completed on server
            if (sessionStatus === "running") {
              // Check if server shows this step as completed/error - if so, clear session storage
              const hasCompleted =
                stepElement.classList.contains("step-completed");
              const hasError = stepElement.classList.contains("step-error");

              if (hasCompleted || hasError) {
                // Server has newer state, clear stale session storage
                sessionStorage.removeItem(key);
                sessionStorage.removeItem(`step_${stepNumber}_started_at`);
                continue;
              }

              // Server still shows pending/running, restore running state
              updateStepStatus(stepNumber, "running");

              const executeBtn = document.getElementById(
                `executeBtn${stepNumber}`
              );
              if (executeBtn) {
                executeBtn.innerHTML =
                  '<i class="fas fa-spinner fa-spin me-2"></i>Executing...';
                executeBtn.disabled = true;
              }

              // Resume polling for this step
              // startStatusPolling(stepNumber);
            }
          }
        }
      }

      // Function to run all steps automatically
      function runAllSteps() {
        if (!window.currentInvestigationId) {
          alert("No active investigation found");
          return;
        }

        const runAllBtn = document.getElementById("runAllStepsBtn");
        if (runAllBtn) {
          runAllBtn.innerHTML =
            '<i class="fas fa-spinner fa-spin me-1"></i>Running All Steps...';
          runAllBtn.disabled = true;
        }

        // Get current step status
        fetch(`/api/investigation/${window.currentInvestigationId}/steps`)
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              const pendingSteps = data.steps.filter(
                (step) => step.status === "pending"
              );

              if (pendingSteps.length === 0) {
                alert("All steps are already completed!");
                if (runAllBtn) {
                  runAllBtn.innerHTML =
                    '<i class="fas fa-play-circle me-1"></i>Run All Steps';
                  runAllBtn.disabled = false;
                }
                return;
              }

              // Execute steps sequentially
              executeStepsSequentially(pendingSteps, 0);
            }
          })
          .catch((error) => {
            alert(`Error getting step status: ${error.message}`);
            if (runAllBtn) {
              runAllBtn.innerHTML =
                '<i class="fas fa-play-circle me-1"></i>Run All Steps';
              runAllBtn.disabled = false;
            }
          });
      }

      // Function to execute steps one by one
      function executeStepsSequentially(steps, currentIndex) {
        if (currentIndex >= steps.length) {
          // All steps completed
          const runAllBtn = document.getElementById("runAllStepsBtn");
          if (runAllBtn) {
            runAllBtn.innerHTML =
              '<i class="fas fa-check me-1"></i>All Steps Completed';
            setTimeout(() => {
              runAllBtn.innerHTML =
                '<i class="fas fa-play-circle me-1"></i>Run All Steps';
              runAllBtn.disabled = false;
            }, 3000);
          }
          alert("All steps have been executed successfully!");
          return;
        }

        const step = steps[currentIndex];
        const stepNumber = step.number;

        console.log(`Executing step ${stepNumber}: ${step.phase}`);

        // Update UI to show step is running
        updateStepStatus(stepNumber, "running");
        const executeBtn = document.getElementById(`executeBtn${stepNumber}`);
        if (executeBtn) {
          executeBtn.innerHTML =
            '<i class="fas fa-spinner fa-spin me-2"></i>Executing...';
          executeBtn.disabled = true;
        }

        // Execute the current step
        fetch(
          `/api/investigation/${window.currentInvestigationId}/step/${stepNumber}/execute`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          }
        )
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              updateStepStatus(stepNumber, "completed");

              // Update the right panel if this step is selected
              showStepInRightPanel(stepNumber);

              // Move to next step after a short delay
              setTimeout(() => {
                executeStepsSequentially(steps, currentIndex + 1);
              }, 1000);
            } else {
              updateStepStatus(stepNumber, "error");
              alert(
                `Step ${stepNumber} execution failed: ${data.message}. Stopping execution.`
              );

              // Re-enable run all button
              const runAllBtn = document.getElementById("runAllStepsBtn");
              if (runAllBtn) {
                runAllBtn.innerHTML =
                  '<i class="fas fa-play-circle me-1"></i>Run All Steps';
                runAllBtn.disabled = false;
              }

              if (executeBtn) {
                executeBtn.innerHTML =
                  '<i class="fas fa-exclamation-triangle me-2"></i>Failed - Retry';
                executeBtn.disabled = false;
              }
            }
          })
          .catch((error) => {
            updateStepStatus(stepNumber, "error");
            alert(
              `Error executing step ${stepNumber}: ${error.message}. Stopping execution.`
            );

            // Re-enable run all button
            const runAllBtn = document.getElementById("runAllStepsBtn");
            if (runAllBtn) {
              runAllBtn.innerHTML =
                '<i class="fas fa-play-circle me-1"></i>Run All Steps';
              runAllBtn.disabled = false;
            }

            if (executeBtn) {
              executeBtn.innerHTML =
                '<i class="fas fa-exclamation-triangle me-2"></i>Failed - Retry';
              executeBtn.disabled = false;
            }
          });
      }

      function updateProgressCounter() {
        if (!window.currentInvestigationId) return;

        fetch(`/api/investigation/${window.currentInvestigationId}/steps`)
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              // Use investigation data if available, otherwise count from steps
              let completedSteps, totalSteps;

              if (data.investigation) {
                completedSteps = data.investigation.completed_steps;
                totalSteps = data.investigation.total_steps;
              } else {
                completedSteps = data.steps.filter(
                  (s) => s.status === "completed"
                ).length;
                totalSteps = data.steps.length;
              }

              const stepProgress = document.getElementById("stepProgress");
              if (stepProgress) {
                stepProgress.textContent = `${completedSteps} / ${totalSteps}`;
              }
            }
          })
          .catch((error) => {
            console.error("Error updating progress counter:", error);
          });
      }

      function updateAlertStatus(investigationStatus) {
        // Update alert status based on investigation progress
        let newStatus = "In Progress";
        if (investigationStatus === "completed") {
          newStatus = "Closed";
        }

        // Update the alert status via API
        fetch("/api/update-alert-status", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            alert_id: "{{ alert.id }}",
            status: newStatus,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              // Update the status display on the page
              const statusElement = document.querySelector(".alert-status");
              if (statusElement) {
                statusElement.textContent = newStatus;
                statusElement.className = `alert-status badge ${
                  newStatus === "Closed" ? "bg-success" : "bg-warning"
                }`;
              }
            }
          })
          .catch((error) => {
            console.error("Failed to update alert status:", error);
          });
      }

      function updateStepStatus(stepNumber, status) {
        // Ensure only one step visually shows 'running' at a time
        if (status === "running") {
          document.querySelectorAll(".playbook-step").forEach((el) => {
            el.classList.remove("step-running");
          });
        }

        const stepElement = document.querySelector(
          `[data-step="${stepNumber}"]`
        );
        if (!stepElement) return;

        // Remove previous status classes we manage
        stepElement.classList.remove(
          "step-pending",
          "step-running",
          "step-completed",
          "step-error",
          "step-in-progress",
          "step-failed",
          "step-canceled",
          "step-canceling"
        );

        // Add canonical class for status
        const statusClass = getStepStatusClass(status);
        stepElement.classList.add(statusClass);

        // Also add a more semantic class used elsewhere
        if (status === "running") {
          stepElement.classList.add("active");
        } else {
          stepElement.classList.remove("active");
        }

        // Update the step-number icon HTML
        const iconContainer = stepElement.querySelector(
          ".playbook-step-number"
        );
        if (iconContainer) {
          // Replace inner HTML icon but keep the number text
          const numberText =
            Array.from(iconContainer.childNodes).find(
              (n) => n.nodeType === Node.TEXT_NODE
            )?.nodeValue || "";
          iconContainer.innerHTML = `${getStepStatusIcon(
            status
          )} ${numberText.trim()}`;
        }
      }

      // Function to format AI output beautifully
      function formatAIOutput(text) {
        if (!text) return "";

        let formatted = text;

        // First, preserve newlines and convert them to proper breaks
        formatted = formatted.replace(/\r\n/g, "\n").replace(/\r/g, "\n");

        // Handle specific PLAYBOOK RUNNER AGENT patterns
        formatted = formatted.replace(
          /ðŸ“‹ PLAYBOOK RUNNER AGENT:/g,
          '<h5 class="text-primary mb-3"><i class="fas fa-play-circle me-2"></i>PLAYBOOK RUNNER AGENT:</h5>'
        );

        // Format main sections with headers
        formatted = formatted.replace(
          /^([A-Z][^:\n]*:)$/gm,
          '<h6 class="text-success mt-4 mb-2 border-bottom border-success pb-1">$1</h6>'
        );

        // Format sub-sections (lines ending with colon that aren't headers)
        formatted = formatted.replace(
          /^(\s*)- ([^:\n]*:)$/gm,
          '$1<strong class="text-primary">- $2</strong>'
        );

        // Format bullet points with proper indentation
        formatted = formatted.replace(
          /^(\s*)- ([^:\n]+)$/gm,
          '$1<div class="mb-1"><i class="fas fa-circle text-muted me-2" style="font-size: 0.5em;"></i>$2</div>'
        );

        // Format numbered lists
        formatted = formatted.replace(
          /^(\s*)(\d+)\.\s+(.+)$/gm,
          '$1<div class="mb-2"><span class="badge bg-primary me-2">$2</span>$3</div>'
        );

        // Format code/query blocks (lines that look like SPL or technical commands)
        formatted = formatted.replace(
          /(index=\w+[^\n]*)/g,
          '<code class="d-block bg-dark text-light p-2 rounded mb-2 small">$1</code>'
        );
        formatted = formatted.replace(
          /(GET|POST|PUT|DELETE)\s+(http[^\s]+)/g,
          '<code class="text-info">$1</code> <code class="text-warning">$2</code>'
        );

        // Format IP addresses and technical identifiers
        formatted = formatted.replace(
          /(\d+\.\d+\.\d+\.\d+)/g,
          '<span class="badge bg-secondary">$1</span>'
        );
        formatted = formatted.replace(
          /(ALERT-\w+)/g,
          '<span class="badge bg-warning text-dark">$1</span>'
        );

        // Format timestamps
        formatted = formatted.replace(
          /(\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2})/g,
          '<span class="text-muted">$1</span>'
        );

        // Convert newlines to breaks but preserve structure
        formatted = formatted.replace(/\n\n/g, '</div><div class="mb-3">');
        formatted = formatted.replace(/\n/g, "<br>");

        // Wrap in container
        formatted = `<div class="mb-3">${formatted}</div>`;

        // Clean up empty divs
        formatted = formatted.replace(/<div[^>]*><\/div>/g, "");
        formatted = formatted.replace(/<div[^>]*><br><\/div>/g, "");

        return formatted;
      }

      function showStepDetails(step) {
        document.getElementById(
          "stepDetailTitle"
        ).textContent = `Step ${step.step_number}: ${step.phase}`;
        document.getElementById("stepDetailDescription").textContent =
          step.description;
        document.getElementById("stepDetailActions").textContent =
          step.detail_actions;

        // Show AI reasoning if available
        if (step.reasoning) {
          const formattedReasoning = formatAIOutput(step.reasoning);
          document.getElementById("stepDetailReasoning").innerHTML = `
                    <div class="mt-3">
                        <h5 class="text-primary mb-3">
                            <i class="fas fa-brain me-2"></i>AI Reasoning & Analysis
                        </h5>
                        <div class="ai-reasoning-card p-4 rounded-3 shadow-sm">
                            ${formattedReasoning}
                        </div>
                    </div>
                `;
        } else {
          document.getElementById("stepDetailReasoning").innerHTML = "";
        }

        // Show conclusion if available
        if (step.conclusion) {
          const formattedConclusion = formatAIOutput(step.conclusion);
          document.getElementById("stepDetailConclusion").innerHTML = `
                    <div class="mt-4">
                        <h5 class="text-success mb-3">
                            <i class="fas fa-lightbulb me-2"></i>Key Findings & Recommendations
                        </h5>
                        <div class="conclusion-box p-4 rounded-3 shadow-sm">
                            ${formattedConclusion}
                        </div>
                    </div>
                `;
        } else {
          document.getElementById("stepDetailConclusion").innerHTML = "";
        }

        // Show the step detail modal
        const modal = new bootstrap.Modal(
          document.getElementById("stepDetailModal")
        );
        modal.show();
      }

      // (Deprecated) other updateStepStatus overload removed; unified implementation above.

      function updateStatus() {
        // This would allow status updates
        alert("Status update feature will be developed in the future");
      }

      // Load AI-generated quick questions on page load
      function loadQuickQuestions() {
        const container = document.getElementById("quickQuestionsContainer");

        container.innerHTML = `
                <div class="placeholder-glow">
                    <div class="btn placeholder w-100 text-start mb-2" style="height: 40px;"></div>
                    <div class="btn placeholder w-100 text-start mb-2" style="height: 40px;"></div>
                    <div class="btn placeholder w-100 text-start mb-2" style="height: 40px;"></div>
                    <div class="btn placeholder w-100 text-start mb-2" style="height: 40px;"></div>
                </div>
            `;

        fetch("/api/quick-questions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ alert_id: currentAlertId }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success" && data.questions) {
              // Normalize to an array of strings; handle plain string with newlines
              const raw = Array.isArray(data.questions)
                ? data.questions
                : String(data.questions)
                    .split(/\n+/)
                    .map((q) => q.trim())
                    .filter(Boolean);

              // Normalize questions - keep numbering if present
              const questions = raw
                .filter(Boolean)
                .slice(0, 5)
                .map((q, idx) => {
                  // If question already has number, keep it; otherwise add it
                  if (/^\d+\./.test(q.trim())) {
                    return q.trim();
                  } else {
                    return `${idx + 1}. ${q.trim()}`;
                  }
                });

              let questionsHtml = "";

              // Build clickable buttons (each on its own line)
              questions.forEach((question) => {
                // Escape for display and for embedding in attribute
                const display = question
                  .replace(/&/g, "&amp;")
                  .replace(/</g, "&lt;")
                  .replace(/>/g, "&gt;");
                const forAttr = question
                  .replace(/\\/g, "\\\\")
                  .replace(/`/g, "\\`")
                  .replace(/'/g, "\\'")
                  .replace(/\n/g, " ");

                questionsHtml += `
                            <button class="btn quick-question-btn w-100 text-start" style="margin-bottom: 12px; background: white !important; color: #1a1a1a !important;" onclick="setQuestion('${forAttr}')">
                                ${display}
                            </button>
                        `;
              });

              if (questions.length === 0) {
                questionsHtml += `
                          <div class="text-center text-muted">
                              <i class="fas fa-info-circle"></i>
                              <p class="mt-2 mb-0 small">No questions generated</p>
                          </div>
                      `;
              }

              container.innerHTML = questionsHtml;
            } else {
              container.innerHTML = `
                        <div class="text-center text-muted">
                            <i class="fas fa-exclamation-circle"></i>
                            <p class="mt-2 mb-0 small">Unable to generate questions</p>
                        </div>
                    `;
            }
          })
          .catch((error) => {
            container.innerHTML = `
                    <div class="text-center text-warning">
                        <i class="fas fa-wifi"></i>
                        <p class="mt-2 mb-0 small">Connection error</p>
                    </div>
                `;
          });
      }

      // Show AI-generated SPL queries
      function showSplunkQueries(alertId) {
        // Create modal if it doesn't exist
        let modal = document.getElementById("splQueryModal");
        if (!modal) {
          const modalHtml = `
                    <div class="modal fade" id="splQueryModal" tabindex="-1">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                                <div class="modal-header bg-dark text-white">
                                    <h5 class="modal-title">
                                        <i class="fas fa-search me-2"></i>AI-Generated Investigation Queries
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body" id="splQueryContent">
                                    <div class="text-center">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">Loading queries...</span>
                                        </div>
                                        <p class="mt-2">AI is loading investigation queries...</p>
                                        <small class="text-muted">May use cached queries for faster loading</small>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-warning me-2" onclick="regenerateSplunkQueries('${alertId}')">
                                        <i class="fas fa-sync-alt me-1"></i>Regenerate Queries
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
          document.body.insertAdjacentHTML("beforeend", modalHtml);
          modal = document.getElementById("splQueryModal");
        }

        // Show modal
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();

        // Load queries
        fetch("/api/investigation-queries", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ alert_id: alertId }),
        })
          .then((response) => response.json())
          .then((data) => {
            const content = document.getElementById("splQueryContent");

            if (data.status === "success" && data.queries) {
              let queriesHtml = "";

              // Add cache indicator if queries were cached
              if (data.cached) {
                queriesHtml += `
                            <div class="alert alert-info alert-sm mb-3">
                                <i class="fas fa-clock me-2"></i>
                                <small>Investigation queries loaded from cache for alert type: <strong>${data.alert_type}</strong></small>
                            </div>
                        `;
              } else {
                queriesHtml += `
                            <div class="alert alert-success alert-sm mb-3">
                                <i class="fas fa-magic me-2"></i>
                                <small>New AI-generated investigation queries for alert type: <strong>${data.alert_type}</strong></small>
                            </div>
                        `;
              }

              data.queries.forEach((query, index) => {
                // Clean and format the query text for display
                let cleanQuery = query.query;

                // Replace multiple spaces with single spaces and format nicely
                cleanQuery = cleanQuery
                  .replace(/\s+/g, " ")
                  .replace(/\|\s*/g, "\\n| ")
                  .replace(/earliest=/g, "\\n  earliest=")
                  .trim();

                // Escape HTML characters for safe display
                const escapedQuery = cleanQuery
                  .replace(/&/g, "&amp;")
                  .replace(/</g, "&lt;")
                  .replace(/>/g, "&gt;")
                  .replace(/"/g, "&quot;");

                // Store the original query for copying and execution
                const originalQuery = query.query;
                const escapedTitle = query.title
                  .replace(/'/g, "&#x27;")
                  .replace(/"/g, "&quot;");

                queriesHtml += `
                            <div class="spl-query-card">
                                <div class="spl-query-header">
                                    <i class="fas fa-code me-2"></i>${escapedTitle}
                                </div>
                                <div class="spl-query-body">
                                    <div class="spl-query-text"><code>${escapedQuery}</code></div>
                                    <div class="mt-3 text-end">
                                        <button class="btn btn-sm btn-outline-primary me-2" onclick="copyToClipboard(\`${originalQuery
                                          .replace(/`/g, "\\`")
                                          .replace(/\\/g, "\\\\")}\`)">
                                            <i class="fas fa-copy me-1"></i>Copy
                                        </button>
                                        <button class="btn btn-sm btn-primary" onclick="executeSplunkQuery(\`${originalQuery
                                          .replace(/`/g, "\\`")
                                          .replace(
                                            /\\/g,
                                            "\\\\"
                                          )}\`, \`${escapedTitle}\`)">
                                            <i class="fas fa-play me-1"></i>Execute
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
              });
              content.innerHTML = queriesHtml;
            } else {
              content.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Unable to generate investigation queries
                        </div>
                    `;
            }
          })
          .catch((error) => {
            document.getElementById("splQueryContent").innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle me-2"></i>
                        Error loading queries: ${error.message}
                    </div>
                `;
          });
      }

      // Regenerate Splunk queries function
      function regenerateSplunkQueries(alertId) {
        const content = document.getElementById("splQueryContent");

        // Show regenerating state
        content.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-warning" role="status">
                        <span class="visually-hidden">Regenerating queries...</span>
                    </div>
                    <p class="mt-2">AI is regenerating investigation queries...</p>
                    <small class="text-muted">This will create fresh queries without using cache</small>
                </div>
            `;

        // Force regeneration by adding force_regenerate parameter
        fetch("/api/investigation-queries", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            alert_id: alertId,
            force_regenerate: true,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success" && data.queries) {
              let queriesHtml = `
                        <div class="alert alert-success alert-sm mb-3">
                            <i class="fas fa-magic me-2"></i>
                            <small>Fresh AI-generated investigation queries for alert type: <strong>${data.alert_type}</strong></small>
                        </div>
                    `;

              data.queries.forEach((query, index) => {
                // Clean and format the query text for display
                let cleanQuery = query.query;

                // Replace multiple spaces with single spaces and format nicely
                cleanQuery = cleanQuery
                  .replace(/\s+/g, " ")
                  .replace(/\|\s*/g, "\\n| ")
                  .replace(/earliest=/g, "\\n  earliest=")
                  .trim();

                // Escape HTML characters for safe display
                const escapedQuery = cleanQuery
                  .replace(/&/g, "&amp;")
                  .replace(/</g, "&lt;")
                  .replace(/>/g, "&gt;")
                  .replace(/"/g, "&quot;");

                // Store the original query for copying and execution
                const originalQuery = query.query;
                const escapedTitle = query.title
                  .replace(/'/g, "&#x27;")
                  .replace(/"/g, "&quot;");

                queriesHtml += `
                            <div class="spl-query-card">
                                <div class="spl-query-header">
                                    <i class="fas fa-code me-2"></i>${escapedTitle}
                                </div>
                                <div class="spl-query-body">
                                    <div class="spl-query-text"><code>${escapedQuery}</code></div>
                                    <div class="mt-3 text-end">
                                        <button class="btn btn-sm btn-outline-primary me-2" onclick="copyToClipboard(\`${originalQuery
                                          .replace(/`/g, "\\`")
                                          .replace(/\\/g, "\\\\")}\`)">
                                            <i class="fas fa-copy me-1"></i>Copy
                                        </button>
                                        <button class="btn btn-sm btn-primary" onclick="executeSplunkQuery(\`${originalQuery
                                          .replace(/`/g, "\\`")
                                          .replace(
                                            /\\/g,
                                            "\\\\"
                                          )}\`, \`${escapedTitle}\`)">
                                            <i class="fas fa-play me-1"></i>Execute
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
              });
              content.innerHTML = queriesHtml;

              showNotification("Queries regenerated successfully!", "success");
            } else {
              content.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Unable to regenerate investigation queries
                        </div>
                    `;
              showNotification("Failed to regenerate queries", "error");
            }
          })
          .catch((error) => {
            content.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle me-2"></i>
                        Error regenerating queries: ${error.message}
                    </div>
                `;
            showNotification(
              "Error regenerating queries: " + error.message,
              "error"
            );
          });
      }

      // Generate IOC-focused SPL queries
      function generateIOCQueries(alertId) {
        // Create modal if it doesn't exist
        let modal = document.getElementById("iocQueryModal");
        if (!modal) {
          const modalHtml = `
                    <div class="modal fade" id="iocQueryModal" tabindex="-1">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                                <div class="modal-header bg-success text-white">
                                    <h5 class="modal-title">
                                        <i class="fas fa-search-plus me-2"></i>IOC Investigation Queries
                                        <small class="ms-2 opacity-75">Find Indicators of Compromise</small>
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body" id="iocQueryContent">
                                    <div class="text-center py-5">
                                        <div class="spinner-border text-success mb-3" role="status" style="width: 3rem; height: 3rem;">
                                            <span class="visually-hidden">Generating queries...</span>
                                        </div>
                                        <h5 class="text-success mb-2">
                                            <i class="fas fa-robot me-2"></i>AI is Generating SPL Queries...
                                        </h5>
                                        <p class="text-muted">Analyzing alert data to create targeted IOC search queries</p>
                                        <div class="progress mt-3" style="height: 8px; max-width: 400px; margin: 0 auto;">
                                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                                                 role="progressbar" style="width: 100%"></div>
                                        </div>
                                        <small class="text-muted d-block mt-3">
                                            <i class="fas fa-lightbulb me-1"></i>
                                            Creating queries to find source IPs, destination IPs, user activity, and related threats...
                                        </small>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-success" onclick="generateIOCQueries('${alertId}')">
                                        <i class="fas fa-sync-alt me-1"></i>Regenerate
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
          document.body.insertAdjacentHTML("beforeend", modalHtml);
          modal = document.getElementById("iocQueryModal");
        }

        // Show modal
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();

        // Generate IOC queries
        fetch("/api/generate_spl", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ alert_id: alertId }),
        })
          .then((response) => response.json())
          .then((data) => {
            const content = document.getElementById("iocQueryContent");

            if (data.status === "success" && data.queries) {
              let queriesHtml = `
                        <div class="alert alert-success mb-3">
                            <i class="fas fa-check-circle me-2"></i>
                            Successfully generated <strong>${data.total_queries}</strong> IOC investigation queries
                        </div>
                    `;

              data.queries.forEach((query, index) => {
                queriesHtml += `
                            <div class="card mb-3 border-success">
                                <div class="card-header bg-light">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">
                                            <span class="badge bg-success me-2">${
                                              index + 1
                                            }</span>
                                            ${
                                              query.title ||
                                              "Query " + (index + 1)
                                            }
                                        </h6>
                                        <button class="btn btn-sm btn-outline-success" onclick="copyToClipboard(\`${query.query.replace(
                                          /`/g,
                                          "\\`"
                                        )}\`, 'Query ${index + 1}')">
                                            <i class="fas fa-copy me-1"></i>Copy
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="query-box p-3 mb-2">
                                        <code style="white-space: pre-wrap; word-break: break-all;">${
                                          query.query
                                        }</code>
                                    </div>
                                    ${
                                      query.description
                                        ? `
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle me-1"></i>${query.description}
                                        </small>
                                    `
                                        : ""
                                    }
                                </div>
                            </div>
                        `;
              });

              content.innerHTML = queriesHtml;
              showNotification(
                `Generated ${data.total_queries} IOC queries successfully!`,
                "success"
              );
            } else {
              content.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Unable to generate IOC queries: ${
                              data.error || "Unknown error"
                            }
                        </div>
                    `;
              showNotification("Failed to generate IOC queries", "error");
            }
          })
          .catch((error) => {
            document.getElementById("iocQueryContent").innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle me-2"></i>
                        Error generating queries: ${error.message}
                    </div>
                `;
            showNotification("Error: " + error.message, "error");
          });
      }

      // Smart Investigation: aggregate MCP threat intel and display in a modal
      function InvestigationOnline(alertId) {
        // Create modal lazily if it doesn't exist
        let modal = document.getElementById("smartInvestigationModal");
        if (!modal) {
          const modalHtml = `
            <div class="modal fade" id="smartInvestigationModal" tabindex="-1">
              <div class="modal-dialog modal-xl modal-dialog-scrollable">
                <div class="modal-content">
                  <div class="modal-header bg-warning text-white">
                    <h5 class="modal-title">
                      <i class="fas fa-search me-2"></i>Smart Investigation
                      <small class="ms-2 opacity-75">Threat intel (VirusTotal, AbuseIPDB, ...)</small>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body" id="smartInvestigationContent">
                    <div class="text-center py-5">
                      <div class="spinner-border text-warning mb-3" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                      <h5 class="text-warning mb-2">
                        <i class="fas fa-robot me-2"></i>AI Ä‘ang generate thÃ´ng tin Ä‘iá»u tra...
                      </h5>
                      <p class="text-muted">Äang tá»•ng há»£p dá»¯ liá»‡u tá»« cÃ¡c MCP server (VirusTotal, AbuseIPDB, ...)</p>
                      <div class="progress mt-3" style="height: 8px; max-width: 400px; margin: 0 auto;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-warning" role="progressbar" style="width: 100%"></div>
                      </div>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-warning" onclick="InvestigationOnline('${alertId}')">
                      <i class="fas fa-sync-alt me-1"></i>Cháº¡y láº¡i
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ÄÃ³ng</button>
                  </div>
                </div>
              </div>
            </div>`;
          document.body.insertAdjacentHTML("beforeend", modalHtml);
          modal = document.getElementById("smartInvestigationModal");
        }

        // Show the modal
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();

        // Fetch smart investigation results
        fetch("/api/smart-investigation", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ alert_id: alertId }),
        })
          .then((res) => res.json())
          .then((data) => {
            const container = document.getElementById(
              "smartInvestigationContent"
            );

            if (data.status !== "success") {
              container.innerHTML = `
                <div class="alert alert-warning">
                  <i class="fas fa-exclamation-triangle me-2"></i>
                  KhÃ´ng thá»ƒ cháº¡y Smart Investigation: ${
                    data.error || data.message || "Unknown error"
                  }
                </div>`;
              showNotification("Smart Investigation failed", "error");
              return;
            }

            const inv = data.investigation || {};
            const iocs = inv.iocs_found || [];
            const enr = inv.enrichment_results || {};

            if (iocs.length === 0) {
              container.innerHTML = `
                <div class="alert alert-info">
                  <i class="fas fa-info-circle me-2"></i>
                  KhÃ´ng tÃ¬m tháº¥y IOC cÃ´ng khai nÃ o Ä‘á»ƒ tra cá»©u.
                </div>`;
              return;
            }

            let html = `
              <div class="mb-3">
                <div class="d-flex align-items-center">
                  <span class="badge bg-primary me-2">${iocs.length}</span>
                  <strong>IOC tÃ¬m tháº¥y</strong>
                </div>
                <small class="text-muted">Alert: ${data.alert_id} â€¢ ${new Date(
              inv.timestamp || data.timestamp || Date.now()
            ).toLocaleString()}</small>
              </div>
            `;

            iocs.forEach((ioc) => {
              const key = `${ioc.type}_${ioc.value}`;
              const item = enr[key] || {};
              const verdict = item.verdict || {};
              const sources = item.sources || {};
              const riskColor = verdict.risk_color || ""; // emoji like ðŸŸ¢ðŸŸ¡ðŸ”´
              const riskLevel = verdict.risk_level || "Unknown";
              const rl = String(riskLevel).toLowerCase();
              const summary = verdict.summary || "No summary";

              html += `
                <div class="card mb-3">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                      <span class="badge bg-dark text-uppercase me-2">${
                        ioc.type
                      }</span>
                      <strong>${escapeHtml(ioc.value)}</strong>
                    </div>
                    <div class="d-flex align-items-center">
                      <span class="me-2" style="font-size: 1.25rem;">${
                        riskColor || ""
                      }</span>
                      <span class="badge ${
                        rl === "high"
                          ? "bg-danger"
                          : rl === "medium"
                          ? "bg-warning text-dark"
                          : rl === "low"
                          ? "bg-success"
                          : "bg-secondary"
                      }">${riskLevel}</span>
                    </div>
                  </div>
                  <div class="card-body">
                    <div class="mb-2 text-muted">${escapeHtml(summary)}</div>
                    <div class="row g-3">
                      ${Object.keys(sources)
                        .map((name) => {
                          const s = sources[name] || {};
                          const ok =
                            (s.status || "").toLowerCase() === "success";
                          const sub = s.summary || s.message || "No details";
                          const extra = [];
                          if (typeof s.malicious === "number")
                            extra.push(`Malicious: ${s.malicious}`);
                          if (typeof s.suspicious === "number")
                            extra.push(`Suspicious: ${s.suspicious}`);
                          if (typeof s.abuse_confidence_score === "number")
                            extra.push(
                              `Abuse Score: ${s.abuse_confidence_score}%`
                            );
                          if (typeof s.total_reports === "number")
                            extra.push(`Reports: ${s.total_reports}`);
                          return `
                            <div class="col-md-6">
                              <div class="api-result-card h-100">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                  <strong><i class="fas fa-database me-2"></i>${escapeHtml(
                                    name
                                  )}</strong>
                                  <span class="badge ${
                                    ok ? "bg-success" : "bg-secondary"
                                  }">${ok ? "OK" : "N/A"}</span>
                                </div>
                                <div class="small">${escapeHtml(sub)}</div>
                                ${
                                  extra.length
                                    ? `<div class="mt-2 small text-muted">${extra
                                        .map(escapeHtml)
                                        .join(" â€¢ ")}</div>`
                                    : ""
                                }
                              </div>
                            </div>`;
                        })
                        .join("")}
                    </div>
                  </div>
                </div>`;
            });

            container.innerHTML = html;
            showNotification(
              `Smart Investigation hoÃ n táº¥t: ${iocs.length} IOC`,
              "success"
            );
          })
          .catch((err) => {
            document.getElementById("smartInvestigationContent").innerHTML = `
              <div class="alert alert-danger">
                <i class="fas fa-times-circle me-2"></i>
                Lá»—i khi gá»i Smart Investigation: ${err.message}
              </div>`;
            showNotification(
              "Smart Investigation error: " + err.message,
              "error"
            );
          });
      }

      // Small helper to escape HTML
      function escapeHtml(str) {
        if (str === undefined || str === null) return "";
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // Execute Splunk query
      function executeSplunkQuery(query, title) {
        showNotification("Executing query: " + title, "info");

        // Get current alert ID
        const alertId = "{{ alert.id }}";

        fetch("/api/execute-splunk-query", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            query: query,
            alert_id: alertId,
            max_results: 100,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              showNotification("Query executed successfully!", "success");
              showQueryResults(data, title);
            } else {
              showNotification(
                "Query execution failed: " + (data.error || "Unknown error"),
                "error"
              );
              console.error("Query execution failed:", data);
            }
          })
          .catch((error) => {
            showNotification(
              "Error executing query: " + error.message,
              "error"
            );
            console.error("Query execution error:", error);
          });
      }

      // Show query results in a modal
      function showQueryResults(data, queryTitle) {
        // Create results modal if it doesn't exist
        let resultsModal = document.getElementById("queryResultsModal");
        if (!resultsModal) {
          const modalHtml = `
                    <div class="modal fade" id="queryResultsModal" tabindex="-1">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title">
                                        <i class="fas fa-chart-line me-2"></i>Query Results
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body" id="queryResultsContent">
                                    <!-- Results will be populated here -->
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="button" class="btn btn-primary" onclick="exportResults()">
                                        <i class="fas fa-download me-1"></i>Export Results
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
          document.body.insertAdjacentHTML("beforeend", modalHtml);
          resultsModal = document.getElementById("queryResultsModal");
        }

        // Populate results content
        const content = document.getElementById("queryResultsContent");

        let resultsHtml = `
                <div class="query-results-header mb-4">
                    <h6 class="fw-bold text-primary">${queryTitle}</h6>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-value">${
                                  data.total_results
                                }</div>
                                <div class="stat-label">Total Results</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-value">${
                                  data.execution_time || "N/A"
                                }</div>
                                <div class="stat-label">Execution Time</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="query-display">
                                <strong>Query:</strong>
                                <code class="d-block mt-1 p-2 bg-light rounded">${
                                  data.query
                                }</code>
                            </div>
                        </div>
                    </div>
                </div>
            `;

        if (data.results && data.results.length > 0) {
          // Create table for results
          resultsHtml += `
                    <div class="results-table-container">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                `;

          // Get all unique keys from results for table headers
          const allKeys = new Set();
          data.results.forEach((result) => {
            Object.keys(result).forEach((key) => allKeys.add(key));
          });

          // Sort keys to show important ones first
          const sortedKeys = Array.from(allKeys).sort((a, b) => {
            const priority = [
              "_time",
              "_raw",
              "timestamp",
              "time",
              "event",
              "src_ip",
              "dest_ip",
              "user",
              "action",
            ];
            const aIndex = priority.indexOf(a);
            const bIndex = priority.indexOf(b);
            if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
            if (aIndex !== -1) return -1;
            if (bIndex !== -1) return 1;
            return a.localeCompare(b);
          });

          // Add headers
          sortedKeys.forEach((key) => {
            resultsHtml += `<th>${key}</th>`;
          });

          resultsHtml += `
                                    </tr>
                                </thead>
                                <tbody>
                `;

          // Add rows
          data.results.forEach((result, index) => {
            resultsHtml += `<tr>`;
            sortedKeys.forEach((key) => {
              let value = result[key] || "";
              // Truncate long values
              if (typeof value === "string" && value.length > 100) {
                value = value.substring(0, 100) + "...";
              }
              resultsHtml += `<td title="${(result[key] || "")
                .toString()
                .replace(/"/g, "&quot;")}">${value}</td>`;
            });
            resultsHtml += `</tr>`;
          });

          resultsHtml += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
        } else {
          resultsHtml += `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        No results found for this query.
                    </div>
                `;
        }

        content.innerHTML = resultsHtml;

        // Store results for export
        window.currentQueryResults = data;

        // Show modal
        const bsModal = new bootstrap.Modal(resultsModal);
        bsModal.show();
      }

      // Export results to CSV
      function exportResults() {
        if (
          !window.currentQueryResults ||
          !window.currentQueryResults.results
        ) {
          showNotification("No results to export", "warning");
          return;
        }

        const results = window.currentQueryResults.results;
        if (results.length === 0) {
          showNotification("No results to export", "warning");
          return;
        }

        // Get all keys
        const allKeys = new Set();
        results.forEach((result) => {
          Object.keys(result).forEach((key) => allKeys.add(key));
        });

        // Create CSV content
        const headers = Array.from(allKeys).join(",");
        const rows = results.map((result) => {
          return Array.from(allKeys)
            .map((key) => {
              const value = result[key] || "";
              // Escape quotes and wrap in quotes if contains comma
              const escaped = value.toString().replace(/"/g, '""');
              return escaped.includes(",") ? `"${escaped}"` : escaped;
            })
            .join(",");
        });

        const csvContent = [headers, ...rows].join("\\n");

        // Download CSV
        const blob = new Blob([csvContent], { type: "text/csv" });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `splunk_query_results_${new Date()
          .toISOString()
          .slice(0, 19)
          .replace(/:/g, "-")}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        showNotification("Results exported successfully", "success");
      }

      // Copy text to clipboard
      function copyToClipboard(text) {
        navigator.clipboard
          .writeText(text)
          .then(() => {
            showNotification("Query copied to clipboard", "success");
          })
          .catch((err) => {
            showNotification("Failed to copy query", "error");
          });
      }

      // Enhanced addConversationBubble with better formatting
      function addConversationBubble(message, isUser = false) {
        const conversationHistory = document.getElementById(
          "conversationHistory"
        );
        const bubble = document.createElement("div");
        bubble.className = `conversation-bubble ${
          isUser ? "user" : "ai"
        } text-left-force`;

        const timestamp = new Date().toLocaleTimeString();

        if (isUser) {
          bubble.innerHTML = `
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-user text-white me-2"></i>
                        <strong class="text-white">You</strong>
                        <small class="text-white-50 ms-2">${timestamp}</small>
                    </div>
                    <div class="response-content">${message}</div>
                `;
        } else {
          bubble.innerHTML = `
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-robot text-primary me-2"></i>
                        <strong>AI Security Analyst</strong>
                        <small class="text-muted ms-2">${timestamp}</small>
                    </div>
                    <div class="response-content">${message}</div>
                `;
        }

        conversationHistory.appendChild(bubble);
        conversationHistory.scrollTop = conversationHistory.scrollHeight;
      }

      // Initialize page
      document.addEventListener("DOMContentLoaded", function () {
        const alertId = "{{ alert.id }}";
        if (alertId && alertId !== "None") {
          // Auto-run all AI features when alert loads
          autoRunAlertAnalysis(alertId);

          // Initialize the QA assistant with alert ID
          window.currentChatAlertId = alertId;

          // Load chat history automatically
          loadChatHistory(alertId);

          // Show welcome message in chat
          setTimeout(() => {
            displayWelcomeMessage();
          }, 500);
        }
      });

      // Auto-run function for complete alert analysis
      function autoRunAlertAnalysis(alertId) {
        console.log(`Auto-running complete analysis for alert: ${alertId}`);

        // 1. Load Quick Questions
        loadQuickQuestions();

        // 2. Pre-generate Investigation Queries (in background)
        preGenerateInvestigationQueries(alertId);

        // 3. Auto-start investigation and run all steps
        autoStartInvestigation(alertId);
      }

      // Pre-generate investigation queries without showing modal
      function preGenerateInvestigationQueries(alertId) {
        fetch("/api/investigation-queries", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ alert_id: alertId }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              console.log(
                `Investigation queries pre-generated for alert type: ${data.alert_type}`
              );
              // Store queries for quick access later
              window.preGeneratedQueries = data.queries;
            }
          })
          .catch((error) => {
            console.error("Error pre-generating investigation queries:", error);
          });
      }

      // Auto-start investigation and run all steps
      function autoStartInvestigation(alertId) {
        // Start investigation
        fetch("/api/start-investigation", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ alert_id: alertId }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              const investigationId = data.investigation_id;
              console.log(`Investigation started: ${investigationId}`);

              // Store investigation ID for later use
              window.autoInvestigationId = investigationId;

              // Auto-run all steps
              setTimeout(() => {
                autoRunAllSteps(investigationId);
              }, 1000);
            }
          })
          .catch((error) => {
            console.error("Error starting auto investigation:", error);
          });
      }

      // Auto-run all investigation steps
      function autoRunAllSteps(investigationId) {
        // Get the steps first
        fetch(`/api/investigation/${investigationId}/steps`)
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success" && data.steps) {
              console.log(
                `Auto-running ${data.steps.length} investigation steps`
              );

              // Run each step sequentially
              runStepsSequentially(investigationId, data.steps, 0);
            }
          })
          .catch((error) => {
            console.error("Error getting investigation steps:", error);
          });
      }

      // Run steps sequentially with delay
      function runStepsSequentially(investigationId, steps, currentIndex) {
        if (currentIndex >= steps.length) {
          console.log("All investigation steps completed");
          showNotification(
            "Auto-investigation completed! All AI outputs are ready.",
            "success"
          );
          return;
        }

        const step = steps[currentIndex];
        const stepNumber = currentIndex + 1;

        console.log(`Executing step ${stepNumber}: ${step.title}`);

        // Execute the step
        fetch(
          `/api/investigation/${investigationId}/step/${stepNumber}/execute`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          }
        )
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              console.log(`Step ${stepNumber} completed successfully`);

              // Wait a bit before running the next step
              setTimeout(() => {
                runStepsSequentially(investigationId, steps, currentIndex + 1);
              }, 2000);
            } else {
              console.error(`Step ${stepNumber} failed:`, data.message);
              // Continue with next step even if one fails
              setTimeout(() => {
                runStepsSequentially(investigationId, steps, currentIndex + 1);
              }, 1000);
            }
          })
          .catch((error) => {
            console.error(`Error executing step ${stepNumber}:`, error);
            // Continue with next step even if one fails
            setTimeout(() => {
              runStepsSequentially(investigationId, steps, currentIndex + 1);
            }, 1000);
          });
      }

      function showNotification(message, type = "info") {
        // Create notification element
        const notification = document.createElement("div");
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        notification.style.cssText =
          "top: 20px; right: 20px; z-index: 9999; min-width: 300px;";
        notification.innerHTML = `
                <i class="fas fa-${
                  type === "success"
                    ? "check-circle"
                    : type === "error"
                    ? "exclamation-triangle"
                    : "info-circle"
                } me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

        // Add to page
        document.body.appendChild(notification);

        // Auto-remove after 5 seconds
        setTimeout(() => {
          if (notification.parentNode) {
            notification.remove();
          }
        }, 5000);
      }

      // Playbook Status Management Functions
      function updatePlaybookStatusCard(investigationId) {
        if (!investigationId) {
          hidePlaybookStatusCard();
          return;
        }

        const statusCard = document.getElementById("playbookStatusCard");
        const statusContent = document.getElementById("playbookStatusContent");

        // Show the card
        statusCard.style.display = "block";

        // Show loading state
        statusContent.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border spinner-border-sm text-primary mb-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="text-muted small">Loading playbook status...</p>
                </div>
            `;

        // Fetch playbook status
        fetch(`/api/playbook-status/${investigationId}`)
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              displayPlaybookStatusSummary(data);
            } else {
              statusContent.innerHTML = `
                            <div class="alert alert-warning alert-sm">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Unable to load playbook status
                            </div>
                        `;
            }
          })
          .catch((error) => {
            console.error("Error loading playbook status:", error);
            statusContent.innerHTML = `
                        <div class="alert alert-danger alert-sm">
                            <i class="fas fa-times-circle me-2"></i>
                            Error loading status
                        </div>
                    `;
          });
      }

      function displayPlaybookStatusSummary(data) {
        const statusContent = document.getElementById("playbookStatusContent");
        const summary = data.execution_summary;
        const investigation = data.investigation;

        let progressPercentage = 0;
        if (summary.total_steps > 0) {
          progressPercentage = Math.round(
            (summary.completed_steps / summary.total_steps) * 100
          );
        }

        // Determine overall status
        let statusBadge = "";
        let statusIcon = "";
        if (summary.in_progress_steps > 0) {
          statusBadge = '<span class="badge bg-warning">In Progress</span>';
          statusIcon = '<i class="fas fa-spinner fa-spin text-warning"></i>';
        } else if (summary.completed_steps === summary.total_steps) {
          statusBadge = '<span class="badge bg-success">Completed</span>';
          statusIcon = '<i class="fas fa-check-circle text-success"></i>';
        } else if (summary.failed_steps > 0) {
          statusBadge = '<span class="badge bg-danger">Failed</span>';
          statusIcon = '<i class="fas fa-exclamation-circle text-danger"></i>';
        } else {
          statusBadge = '<span class="badge bg-secondary">Pending</span>';
          statusIcon = '<i class="fas fa-clock text-secondary"></i>';
        }

        statusContent.innerHTML = `
                <div class="playbook-status-summary">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <div>
                            <h6 class="mb-1">${
                              investigation.playbook?.name ||
                              "Investigation Playbook"
                            }</h6>
                            <small class="text-muted">${statusBadge}</small>
                        </div>
                        <div class="text-end">
                            ${statusIcon}
                        </div>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small class="text-muted">Progress</small>
                            <small class="fw-bold">${summary.completed_steps}/${
          summary.total_steps
        } steps</small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar ${
                              progressPercentage === 100
                                ? "bg-success"
                                : "bg-primary"
                            }" 
                                 role="progressbar" 
                                 style="width: ${progressPercentage}%"
                                 aria-valuenow="${progressPercentage}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                        <small class="text-muted">${progressPercentage}% complete</small>
                    </div>
                    
                    <!-- Step Status Summary -->
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <div class="text-center p-2 bg-light rounded">
                                <div class="text-success fw-bold">${
                                  summary.completed_steps
                                }</div>
                                <small class="text-muted">Completed</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center p-2 bg-light rounded">
                                <div class="text-secondary fw-bold">${
                                  summary.pending_steps
                                }</div>
                                <small class="text-muted">Pending</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="d-grid gap-2">
                        <button class="btn btn-sm btn-outline-primary" onclick="openInvestigationModal()">
                            <i class="fas fa-eye me-1"></i>View Details
                        </button>
                        ${
                          summary.in_progress_steps === 0 &&
                          summary.pending_steps > 0
                            ? '<button class="btn btn-sm btn-primary" onclick="resumeInvestigation()"><i class="fas fa-play me-1"></i>Resume</button>'
                            : ""
                        }
                    </div>
                </div>
            `;
      }

      function hidePlaybookStatusCard() {
        const statusCard = document.getElementById("playbookStatusCard");
        statusCard.style.display = "none";
      }

      function openInvestigationModal() {
        if (window.currentInvestigationId) {
          const modal = new bootstrap.Modal(
            document.getElementById("investigationModal")
          );
          modal.show();
          loadPlaybookSteps(window.currentInvestigationId);
        }
      }

      function resumeInvestigation() {
        if (window.currentInvestigationId) {
          openInvestigationModal();
        }
      }

      // Enhanced startInvestigation function to update status card
      const originalStartInvestigation = window.startInvestigation;
      window.startInvestigation = function (alertId) {
        if (originalStartInvestigation) {
          originalStartInvestigation(alertId);
        }

        // Set up a listener to update the status card when investigation starts
        setTimeout(() => {
          if (window.currentInvestigationId) {
            updatePlaybookStatusCard(window.currentInvestigationId);

            // Set up periodic updates
            if (window.playbookStatusInterval) {
              clearInterval(window.playbookStatusInterval);
            }
            window.playbookStatusInterval = setInterval(() => {
              updatePlaybookStatusCard(window.currentInvestigationId);
            }, 30000); // Update every 30 seconds
          }
        }, 1000);
      };

      // Check for active investigations on page load
      document.addEventListener("DOMContentLoaded", function () {
        // Check if there's an existing investigation for this alert
        const alertId = "{{ alert.id }}";
        const existingInvestigationId = '{{ existing_investigation_id or "" }}';

        if (existingInvestigationId && existingInvestigationId !== "None") {
          // Set the current investigation ID
          window.currentInvestigationId = existingInvestigationId;

          // Automatically load and display the playbook status
          updatePlaybookStatusCard(existingInvestigationId);

          // Set up periodic updates
          if (window.playbookStatusInterval) {
            clearInterval(window.playbookStatusInterval);
          }
          window.playbookStatusInterval = setInterval(() => {
            updatePlaybookStatusCard(existingInvestigationId);
          }, 30000); // Update every 30 seconds

          console.log(
            `Auto-loaded existing investigation: ${existingInvestigationId}`
          );
        } else {
          console.log("No existing investigation found for this alert");
        }
      });
    </script>
  </body>
</html>
